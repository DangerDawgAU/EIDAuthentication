# VirusTotal API Key Verification Workflow
#
# This workflow verifies that the VT_API_KEY secret is properly configured
# and can authenticate with the VirusTotal API.
#
# Part of Phase 41: Prerequisites and Secret Setup
# DO NOT expose the API key in logs - it will be automatically masked by GitHub
name: "Verify VT API Key"

on:
  workflow_dispatch:
    # Manual trigger only - for verification purposes

jobs:
  verify-api-key:
    name: Verify VirusTotal API Key
    runs-on: ubuntu-latest

    steps:
      - name: Test API Connection
        env:
          VT_API_KEY: ${{ secrets.VT_API_KEY }}
        run: |
          echo "Testing VirusTotal API connection..."

          # Make a test API call to VirusTotal
          # Using the users/current endpoint to verify API key validity
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "x-apikey: $VT_API_KEY" \
            "https://www.virustotal.com/api/v3/users/current")

          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "API key verified successfully"
            echo "HTTP Status: $HTTP_STATUS"
            exit 0
          elif [ "$HTTP_STATUS" -eq 401 ]; then
            echo "::error::API key authentication failed (401 Unauthorized)"
            echo "The VT_API_KEY secret may be invalid or expired"
            exit 1
          elif [ "$HTTP_STATUS" -eq 429 ]; then
            echo "::warning::API rate limit reached (429 Too Many Requests)"
            echo "This is expected with free tier - the key is valid"
            exit 0
          else
            echo "::error::Unexpected HTTP status: $HTTP_STATUS"
            exit 1
          fi

      - name: Verify Key Masking
        run: |
          echo "Secret masking verification:"
          echo "If you see '***' below, the secret is properly masked:"
          echo "Key preview: ${{ secrets.VT_API_KEY }}"
          echo ""
          echo "If the above shows asterisks, the secret is properly configured."
