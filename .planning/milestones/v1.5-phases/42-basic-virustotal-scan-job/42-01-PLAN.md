---
phase: 42-basic-virustotal-scan-job
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [.github/workflows/scan-artifacts.yml]
autonomous: true
requirements: [SCAN-01, SCAN-02, SCAN-03, SCAN-04, WF-01, WF-02, WF-03, WF-04, RPT-02, WARN-01]

must_haves:
  truths:
    - "Workflow triggers on push to main branch after successful build"
    - "All compiled DLLs are uploaded to VirusTotal and scanned"
    - "All compiled EXEs are uploaded to VirusTotal and scanned"
    - "NSIS installer executable is uploaded to VirusTotal and scanned"
    - "Source code archive is uploaded to VirusTotal and scanned"
    - "Scan results are logged to workflow output with analysis URLs"
    - "Warning is logged when detections found but build continues"
    - "API rate limiting is set to 4 requests/minute"
    - "Retry logic handles API errors with exponential backoff"
  artifacts:
    - path: ".github/workflows/scan-artifacts.yml"
      provides: "VirusTotal scanning workflow"
      contains: "crazy-max/ghaction-virustotal"
      min_lines: 80
  key_links:
    - from: ".github/workflows/scan-artifacts.yml"
      to: "VirusTotal API v3"
      via: "crazy-max/ghaction-virustotal@v4"
      pattern: "uses:.*ghaction-virustotal"
    - from: ".github/workflows/scan-artifacts.yml"
      to: "VT_API_KEY secret"
      via: "secrets.VT_API_KEY"
      pattern: "secrets\\.VT_API_KEY"
---

<objective>
Create a GitHub Actions workflow that scans all build artifacts with VirusTotal on push to main branch, logs results to workflow output, and handles detections as non-blocking warnings.

Purpose: Enable automated malware scanning of all release artifacts to provide security transparency for users while avoiding false-positive blocking of security software releases.

Output: A working VirusTotal scanning workflow that runs on main branch pushes.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK-VIRUSTOTAL.md
@.planning/research/PITFALLS.md
@.planning/research/ARCHITECTURE.md

# Reference implementation from Phase 41
@.github/workflows/verify-vt-api.yml

# Prior phase context
@.planning/milestones/v1.5-phases/41-prerequisites-and-secret-setup/41-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VirusTotal scan workflow</name>
  <files>.github/workflows/scan-artifacts.yml</files>
  <action>
Create the VirusTotal scanning workflow at `.github/workflows/scan-artifacts.yml` with the following requirements:

**Workflow Structure:**
```yaml
name: VirusTotal Artifact Scan

on:
  push:
    branches: [main]
    # Only trigger if build-related files change
    paths:
      - 'EIDCardLibrary/**'
      - 'EIDCredentialProvider/**'
      - 'EIDAuthenticationPackage/**'
      - 'EIDPasswordChangeNotification/**'
      - 'EIDConfigurationWizard/**'
      - 'EIDConfigurationWizardElevated/**'
      - 'EIDLogManager/**'
      - 'Installer/**'
      - '.github/workflows/scan-artifacts.yml'
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: read
```

**Jobs:**
1. `build` job: Build all 7 projects using MSBuild on windows-latest runner
2. `package` job: Create NSIS installer and source code zip (needs: build)
3. `scan` job: Upload all artifacts to VirusTotal (needs: package, runs-on: ubuntu-latest)

**Build Job Steps:**
- Checkout repository
- Setup MSBuild (microsoft/setup-msbuild@v2)
- Build solution in Release x64 configuration
- Upload build artifacts (all DLLs and EXEs from x64/Release directories)

**Package Job Steps:**
- Download build artifacts
- Create NSIS installer using joncloud/makensis-action@v1
- Create source code zip (exclude .git, build artifacts)
- Upload packaged artifacts (installer and source zip)

**Scan Job Configuration:**
- Use `crazy-max/ghaction-virustotal@v4`
- Set `vt_api_key: ${{ secrets.VT_API_KEY }}`
- Set `request_rate: 4` (free tier compliance - WF-02)
- Set `continue-on-error: true` on the scan step (WF-03)
- Configure retry logic via action's built-in handling (WF-04)

**Files to Scan (exact patterns):**
```yaml
files: |
  ./artifacts/EIDCredentialProvider.dll
  ./artifacts/EIDCardLibrary.dll
  ./artifacts/EIDLogManager.dll
  ./artifacts/EIDPasswordChangeNotification.dll
  ./artifacts/EIDAuthenticationPackage.dll
  ./artifacts/EIDConfigurationWizard.exe
  ./artifacts/EIDConfigurationWizardElevated.exe
  ./artifacts/EIDInstallx64.exe
  ./artifacts/source.zip
```

**Logging Requirements (RPT-02, WARN-01):**
After the scan step, add a step that:
1. Echoes each analysis URL to workflow output
2. Parses the scan results output
3. If any detections found, logs a warning annotation using `::warning::` but does not fail

**Example logging step:**
```yaml
- name: Report scan results
  if: always()
  run: |
    echo "## VirusTotal Scan Results" >> $GITHUB_STEP_SUMMARY
    echo "" >> $GITHUB_STEP_SUMMARY
    # Parse and log each artifact's analysis URL
    # Use ::warning:: if detections > 0
```

**Critical Implementation Notes:**
- The action `crazy-max/ghaction-virustotal@v4` has built-in retry logic with exponential backoff - do NOT implement custom retry logic
- Set job timeout to 30 minutes to allow for VirusTotal queue wait times
- Use `if: always()` on the report step to ensure results are logged even if scan partially fails
- Ensure all 7 DLLs and EXEs are captured from the build output directories:
  - EIDCredentialProvider/x64/Release/EIDCredentialProvider.dll
  - EIDCardLibrary/x64/Release/EIDCardLibrary.dll
  - EIDLogManager/x64/Release/EIDLogManager.dll
  - EIDPasswordChangeNotification/x64/Release/EIDPasswordChangeNotification.dll
  - EIDAuthenticationPackage/x64/Release/EIDAuthenticationPackage.dll
  - EIDConfigurationWizard/x64/Release/EIDConfigurationWizard.exe
  - EIDConfigurationWizardElevated/x64/Release/EIDConfigurationWizardElevated.exe

**Source Code Archive:**
Create a zip of the source code excluding:
- .git directory
- x64/ and Debug/ and Release/ build directories
- *.obj, *.pdb, *.ilk files
  </action>
  <verify>
Run `gh workflow lint .github/workflows/scan-artifacts.yml` to validate YAML syntax (or manually verify YAML is valid).
Check that all required patterns exist:
- `uses: crazy-max/ghaction-virustotal@v4`
- `request_rate: 4`
- `secrets.VT_API_KEY`
- `continue-on-error: true`
- All 9 artifact file paths listed
  </verify>
  <done>
Workflow file exists at `.github/workflows/scan-artifacts.yml` containing:
1. Trigger on push to main branch with path filters (WF-01)
2. Rate limiting set to 4 requests/minute (WF-02)
3. continue-on-error: true on scan step (WF-03)
4. Uses crazy-max/ghaction-virustotal@v4 which has built-in retry (WF-04)
5. All 7 DLLs and EXEs in files list (SCAN-01, SCAN-02)
6. NSIS installer in files list (SCAN-03)
7. Source code zip in files list (SCAN-04)
8. Scan results logged to workflow output (RPT-02)
9. Warning annotation on detections (WARN-01)
  </done>
</task>

</tasks>

<verification>
1. Workflow file syntax is valid YAML
2. All 10 requirements have corresponding implementation in the workflow:
   - SCAN-01: DLL artifacts listed in files input
   - SCAN-02: EXE artifacts listed in files input
   - SCAN-03: NSIS installer listed in files input
   - SCAN-04: source.zip listed in files input
   - WF-01: on.push.branches contains [main]
   - WF-02: request_rate: 4 is set
   - WF-03: continue-on-error: true on scan step
   - WF-04: crazy-max/ghaction-virustotal@v4 has built-in retry
   - RPT-02: Scan results logged to GITHUB_STEP_SUMMARY
   - WARN-01: ::warning:: annotation used for detections
3. VT_API_KEY referenced via secrets, not hardcoded
4. Job dependencies correctly configured (build -> package -> scan)
</verification>

<success_criteria>
Measurable completion criteria:
1. Workflow triggers on push to main branch
2. All 9 artifacts are scanned (7 binaries + 1 installer + 1 source zip)
3. Scan results include analysis URLs for each artifact
4. Detections produce warnings but do not fail the workflow
5. Rate limiting respects 4 requests/minute limit
6. Workflow handles API errors gracefully with retry logic
</success_criteria>

<output>
After completion, create `.planning/milestones/v1.5-phases/42-basic-virustotal-scan-job/42-01-SUMMARY.md`
</output>
