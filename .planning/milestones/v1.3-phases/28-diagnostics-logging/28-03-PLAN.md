---
phase: 28-diagnostics-logging
plan: 03
type: execute
wave: 2
depends_on:
  - 28-01
files_modified:
  - EIDAuthenticationPackage/EIDAuthenticationPackage.cpp
autonomous: true
requirements:
  - DIAG-01
  - DIAG-02
  - DIAG-03

must_haves:
  truths:
    - "Authentication package error messages include operation context and user identification"
    - "Security audit messages use structured prefixes for SIEM filtering"
    - "Critical error paths have stack trace logging for post-mortem analysis"
  artifacts:
    - path: "EIDAuthenticationPackage/EIDAuthenticationPackage.cpp"
      provides: "Enhanced authentication flow tracing and structured security audits"
      min_lines: 1000
  key_links:
    - from: "LsaApLogonUserEx2"
      to: "EIDLogErrorWithContext"
      via: "error path enhancement"
      pattern: "EIDLogErrorWithContext"
    - from: "Authentication error paths"
      to: "EIDLogStackTrace"
      via: "exception handlers"
      pattern: "EIDLogStackTrace"
---

<objective>
Enhance error messages and tracing in the authentication package with operation context, and add structured prefixes to security audit messages.

Purpose: The authentication package (LSASS context) is the most critical for debugging login failures. Enhance error paths with context and add stack trace capture for exception handlers. Improve security audit messages with structured prefixes for easier SIEM filtering.

Output: EIDAuthenticationPackage.cpp with enhanced error tracing and structured security audits.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-diagnostics-logging/28-RESEARCH.md
@.planning/phases/28-diagnostics-logging/28-01-PLAN.md
@EIDAuthenticationPackage/EIDAuthenticationPackage.cpp
@EIDCardLibrary/Tracing.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add structured prefixes to security audit messages</name>
  <files>EIDAuthenticationPackage/EIDAuthenticationPackage.cpp</files>
  <action>
Enhance existing EIDSecurityAudit calls with structured prefixes for easier SIEM filtering.

The existing security audit messages (lines 852-978) are already good but can be improved with structured prefixes:

1. Line ~852: Add [AUTH_CERT_ERROR] prefix:
```cpp
// BEFORE:
EIDSecurityAudit(SECURITY_AUDIT_FAILURE, L"Smart card logon failed: Unable to get certificate from CSP info");

// AFTER:
EIDSecurityAudit(SECURITY_AUDIT_FAILURE, L"[AUTH_CERT_ERROR] Smart card logon failed: Unable to get certificate from CSP info");
```

2. Line ~859: Add [AUTH_CERT_ERROR] prefix:
```cpp
// BEFORE:
EIDSecurityAudit(SECURITY_AUDIT_FAILURE, L"Smart card logon failed: Could not get username from certificate (0x%08x)", GetLastError());

// AFTER:
EIDSecurityAudit(SECURITY_AUDIT_FAILURE, L"[AUTH_CERT_ERROR] Smart card logon failed: Could not get username from certificate (0x%08x)", GetLastError());
```

3. Line ~863: Add [AUTH_CERT_ERROR] prefix:
```cpp
// BEFORE:
EIDSecurityAudit(SECURITY_AUDIT_FAILURE, L"Smart card logon failed: NULL username from certificate");

// AFTER:
EIDSecurityAudit(SECURITY_AUDIT_FAILURE, L"[AUTH_CERT_ERROR] Smart card logon failed: NULL username from certificate");
```

4. Line ~872: Add [AUTH_CERT_ERROR] prefix:
```cpp
// BEFORE:
EIDSecurityAudit(SECURITY_AUDIT_FAILURE, L"Smart card logon failed for user '%s': Untrusted certificate (0x%08x)", szUserName, GetLastError());

// AFTER:
EIDSecurityAudit(SECURITY_AUDIT_FAILURE, L"[AUTH_CERT_ERROR] Smart card logon failed for user '%s': Untrusted certificate (0x%08x)", szUserName, GetLastError());
```

5. Lines ~906, ~909, ~913, ~916, ~919, ~922: Add [AUTH_CARD_ERROR] prefix to smart card errors:
- "No keyset" -> [AUTH_CARD_ERROR]
- "Wrong PIN" -> [AUTH_PIN_ERROR]
- "Card blocked" -> [AUTH_PIN_ERROR]
- "Silent context" -> [AUTH_CARD_ERROR]
- "Card not authenticated" -> [AUTH_CARD_ERROR]
- "I/O error" -> [AUTH_CARD_ERROR]

6. Line ~978: Add [AUTH_SUCCESS] prefix:
```cpp
// BEFORE:
EIDSecurityAudit(SECURITY_AUDIT_SUCCESS, L"Smart card logon succeeded for user '%wZ'", *AccountName);

// AFTER:
EIDSecurityAudit(SECURITY_AUDIT_SUCCESS, L"[AUTH_SUCCESS] Smart card logon succeeded for user '%wZ'", *AccountName);
```

Structured prefix categories:
- [AUTH_CERT_ERROR] - Certificate validation failures
- [AUTH_CARD_ERROR] - Smart card communication errors
- [AUTH_PIN_ERROR] - PIN-related errors
- [AUTH_CRED_ERROR] - Credential retrieval errors
- [AUTH_SUCCESS] - Successful authentication
</action>
  <verify>
cd C:/Users/user/Documents/EIDAuthentication && cmake --build build --config Release --target EIDAuthenticationPackage 2>&1 | head -50
grep -c "\\[AUTH_" EIDAuthenticationPackage/EIDAuthenticationPackage.cpp
</verify>
  <done>
All security audit messages have structured prefixes
Prefix categories: AUTH_CERT_ERROR, AUTH_CARD_ERROR, AUTH_PIN_ERROR, AUTH_SUCCESS
Build passes without errors
</done>
</task>

<task type="auto">
  <name>Task 2: Enhance error path tracing with operation context</name>
  <files>EIDAuthenticationPackage/EIDAuthenticationPackage.cpp</files>
  <action>
Enhance generic error traces with operation context using EIDLogErrorWithContext.

1. Lines ~168, ~180, ~207, ~214, ~220: LSA security context checks:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"ImpersonateClient 0x%08x", status);

// AFTER:
EIDLogErrorWithContext("ImpersonateClient", HRESULT_FROM_NT(status), nullptr);
```

2. Lines ~321, ~404: Certificate context creation:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"CertCreateCertificateContext 0x%08x", pBuffer->dwError);

// AFTER:
EIDLogErrorWithContext("CertCreateCertificateContext", HRESULT_FROM_WIN32(pBuffer->dwError), nullptr);
```

3. Lines ~441, ~658, ~988: Exception handlers - add stack trace:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"NT exception 0x%08x",GetExceptionCode());
return STATUS_LOGON_FAILURE;

// AFTER:
EIDCardLibraryTrace(WINEVENT_LEVEL_ERROR,L"NT exception in LsaApLogonUserEx2: 0x%08x",GetExceptionCode());
EIDLogStackTrace(GetExceptionCode());
return STATUS_LOGON_FAILURE;
```

4. Line ~737: Credential unprotect:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"CredUnprotectW 0x%08x",GetLastError());

// AFTER:
EIDLogErrorWithContext("CredUnprotectW", HRESULT_FROM_WIN32(GetLastError()), nullptr);
```

5. Line ~821: GetComputerName:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"GetComputerName NULL 0x%08x",GetLastError());

// AFTER:
EIDLogErrorWithContext("GetComputerName", HRESULT_FROM_WIN32(GetLastError()), nullptr);
```

6. Line ~899: RetrieveStoredCredential:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"RetrieveStoredCredential failed 0x%08x", dwError);

// AFTER:
EIDLogErrorWithContext("RetrieveStoredCredential", HRESULT_FROM_WIN32(dwError), nullptr);
```

CRITICAL: Never log PIN, password, or sensitive credential data in traces.
</action>
  <verify>
cd C:/Users/user/Documents/EIDAuthentication && cmake --build build --config Release --target EIDAuthenticationPackage 2>&1 | head -50
grep -c "EIDLogErrorWithContext" EIDAuthenticationPackage/EIDAuthenticationPackage.cpp
grep -c "EIDLogStackTrace" EIDAuthenticationPackage/EIDAuthenticationPackage.cpp
</verify>
  <done>
Key error paths use EIDLogErrorWithContext with operation context
Exception handlers use EIDLogStackTrace for post-mortem analysis
Build passes without errors
No sensitive data logged
</done>
</task>

</tasks>

<verification>
1. Build EIDAuthenticationPackage project successfully
2. Security audit messages have structured prefixes ([AUTH_*])
3. Key error paths use EIDLogErrorWithContext instead of generic traces
4. Exception handlers call EIDLogStackTrace for stack capture
5. No sensitive data (PIN, password, credential) logged
</verification>

<success_criteria>
- All security audit messages use structured prefixes for SIEM filtering
- Error paths have operation context for troubleshooting
- Exception handlers capture stack traces for post-mortem analysis
- Build passes with no new warnings
</success_criteria>

<output>
After completion, create `.planning/phases/28-diagnostics-logging/28-03-SUMMARY.md`
</output>
