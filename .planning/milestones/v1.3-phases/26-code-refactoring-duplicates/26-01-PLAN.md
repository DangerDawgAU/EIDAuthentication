---
phase: 26-code-refactoring-duplicates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
requirements: [REFACT-03]
user_setup: []

must_haves:
  truths:
    - "Existing shared helper functions are used consistently"
    - "SonarQube duplications are documented with justifications"
    - "Build passes with no errors"
  artifacts:
    - path: ".planning/phases/26-code-refactoring-duplicates/26-DUPLICATION-ANALYSIS.md"
      provides: "Documentation of duplication analysis and won't-fix justifications"
      contains: "Won't-Fix Category"
  key_links:
    - from: "EIDCardLibrary/CertificateUtilities.cpp"
      to: "EIDCardLibrary/CertificateUtilities.h"
      via: "Shared function declarations"
      pattern: "BuildContainerNameFromReader|SchGetProviderNameFromCardName|SetupCertificateContextWithKeyInfo"
---

<objective>
Verify existing shared helpers are used consistently and document remaining SonarQube duplications as "Won't Fix" with appropriate justifications.

Purpose: The codebase has a 1.9% duplication rate (443 lines in 17 blocks across 6 files), which is below the 3-5% concern threshold. Most duplications are intentional: Windows API boilerplate, context-specific error handling, security isolation, and SEH-protected code. The goal is A+ code (not A++) - practical verification and documentation, not over-engineering.

Output: Verification report confirming existing helpers are used consistently, and a duplication analysis document with won't-fix justifications.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-code-refactoring-duplicates/26-RESEARCH.md

# Key files with shared functions already consolidated:
# - EIDCardLibrary/CertificateUtilities.cpp - contains BuildContainerNameFromReader, SchGetProviderNameFromCardName, SetupCertificateContextWithKeyInfo
# - EIDCardLibrary/StringConversion.cpp - contains modern C++ BuildContainerNameFromReader overload

# Duplication metrics from Phase 13:
# - 1.9% duplication density (below 3% threshold)
# - 17 blocks, 443 lines, 6 files
# - Most are Windows API patterns or intentional for security

# User constraint: A+ code, not A++ - practical refactoring, not over-engineering
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify existing shared helpers are used consistently</name>
  <files>EIDCardLibrary/*.cpp</files>
  <action>
Verify that the existing shared helper functions in EIDCardLibrary are being used consistently across the codebase. Check for:

1. **BuildContainerNameFromReader** - Verify this function is called (not inline-duplicated) wherever the "\\\\.\\" + readerName + "\\" pattern is needed. Check:
   - CertificateUtilities.cpp (function definition)
   - CContainerHolderFactory.cpp (calls it)
   - Any other files that build container names

2. **SchGetProviderNameFromCardName** - Verify this function is called (not inline-duplicated) wherever provider name lookup is needed. Check:
   - CertificateUtilities.cpp (function definition)
   - CContainerHolderFactory.cpp (calls it)
   - Any other files that get provider name from card name

3. **SetupCertificateContextWithKeyInfo** - Verify this function is called (not inline-duplicated) wherever certificate context setup with key info is needed. Check:
   - CertificateUtilities.cpp (function definition)
   - CertificateValidation.cpp (calls it)
   - CContainerHolderFactory.cpp (calls it)

Use grep to search for any inline duplication of these patterns that should be calling the existing functions instead.

Expected outcome: Confirm all existing shared helpers are being used correctly. If 1-2 minor inconsistencies are found (e.g., a place where a helper could be used but inline code exists), note them for potential cleanup but do NOT make changes in this phase - the risk outweighs the benefit for A+ code goal.
  </action>
  <verify>
    grep -c "BuildContainerNameFromReader" EIDCardLibrary/*.cpp
    grep -c "SchGetProviderNameFromCardName" EIDCardLibrary/*.cpp
    grep -c "SetupCertificateContextWithKeyInfo" EIDCardLibrary/*.cpp
  </verify>
  <done>
Verification complete with grep counts confirming shared helpers are used across the codebase. Any inline duplications identified and documented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create duplication analysis document with won't-fix justifications</name>
  <files>.planning/phases/26-code-refactoring-duplicates/26-DUPLICATION-ANALYSIS.md</files>
  <action>
Create a comprehensive duplication analysis document that:

1. Summarizes the duplication metrics (1.9%, 17 blocks, 443 lines, 6 files)

2. Documents the existing shared functions that already consolidate common patterns:
   - BuildContainerNameFromReader
   - SchGetProviderNameFromCardName
   - SetupCertificateContextWithKeyInfo

3. Lists each Won't-Fix category with justification:
   - **Won't-Fix Category 1: Windows API Boilerplate** - Patterns like SCardEstablishContext, CertOpenStore, CryptAcquireContext are standard Windows API usage, not true duplication
   - **Won't-Fix Category 2: Error Handling Variants** - Similar code with different error handling (tracing, messages, status codes) - error context is part of the code's purpose
   - **Won't-Fix Category 3: Security Context Isolation** - Similar code in LSASS vs user-mode components - intentional duplication for security isolation
   - **Won't-Fix Category 4: SEH-Protected Code** - Duplicated cleanup patterns within __try/__finally blocks - cannot safely extract without breaking exception safety
   - **Won't-Fix Category 5: Already Consolidated** - Patterns that already have shared functions (verified in Task 1)

4. Notes that 1.9% duplication is below the 3-5% concern threshold

5. States the recommendation: No new shared functions needed; existing helpers verified; document remaining as won't-fix per A+ (not A++) code goal

Format the document in markdown with clear sections and a summary table.
  </action>
  <verify>
    cat .planning/phases/26-code-refactoring-duplicates/26-DUPLICATION-ANALYSIS.md
  </verify>
  <done>
Duplication analysis document created with won't-fix justifications for all 17 duplication blocks across 6 files. Document confirms existing shared functions are used and no new consolidation is warranted.
  </done>
</task>

<task type="auto">
  <name>Task 3: Build verification</name>
  <files></files>
  <action>
Run the build to verify no changes are needed and the codebase compiles cleanly:

1. Run `build.bat` from the repository root to compile all 7 projects
2. Verify zero compilation errors
3. Confirm no new warnings introduced

Since this phase is verification and documentation only (no code changes expected), the build should pass identically to Phase 25.
  </action>
  <verify>
    cd C:/Users/user/Documents/EIDAuthentication && ./build.bat
  </verify>
  <done>
Build passes with zero errors. All 7 projects compile successfully. No code changes were needed - existing shared helpers are used consistently and duplications are documented as won't-fix.
  </done>
</task>

</tasks>

<verification>
1. Grep confirms existing shared helpers are used consistently across files
2. Duplication analysis document exists with won't-fix justifications
3. Build passes with zero errors
4. No code changes made (verification and documentation only)
</verification>

<success_criteria>
1. SonarQube duplications documented with won't-fix justifications (17 blocks, 6 files)
2. Existing shared patterns verified to be used consistently (BuildContainerNameFromReader, SchGetProviderNameFromCardName, SetupCertificateContextWithKeyInfo)
3. Build passes and functionality preserved (no code changes)
</success_criteria>

<output>
After completion, create `.planning/phases/26-code-refactoring-duplicates/26-01-SUMMARY.md`
</output>
