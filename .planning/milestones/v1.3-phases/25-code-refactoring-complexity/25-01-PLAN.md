---
phase: 25-code-refactoring-complexity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - EIDCardLibrary/CertificateUtilities.cpp
autonomous: true
requirements: [REFACT-01, REFACT-02]

must_haves:
  truths:
    - "SelectFirstCertificateWithPrivateKey function has reduced cognitive complexity"
    - "Helper functions extract complex boolean conditions into named predicates"
    - "Build passes with zero errors"
  artifacts:
    - path: "EIDCardLibrary/CertificateUtilities.cpp"
      provides: "Certificate selection utilities with reduced complexity"
      contains: "static bool IsCertificateMatch"
  key_links:
    - from: "SelectFirstCertificateWithPrivateKey"
      to: "IsCertificateMatch helper"
      via: "function call"
      pattern: "IsCertificateMatch\\s*\\("
---

<objective>
Extract helper functions from SelectFirstCertificateWithPrivateKey in CertificateUtilities.cpp to reduce cognitive complexity by naming complex boolean conditions.

Purpose: Make certificate selection logic more readable by extracting nested condition checks into well-named helper functions.
Output: CertificateUtilities.cpp with extracted helper functions and reduced cognitive complexity.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-code-refactoring-complexity/25-RESEARCH.md
@EIDCardLibrary/CertificateUtilities.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract certificate matching helper from SelectFirstCertificateWithPrivateKey</name>
  <files>EIDCardLibrary/CertificateUtilities.cpp</files>
  <action>
The SelectFirstCertificateWithPrivateKey function (lines ~201-248) has a complex condition checking for computer name match. Extract this into a named helper function.

**Current code pattern (lines 232-242):**
```cpp
// Check for computer name match
if (_tcscmp(szCertName, szComputerName) == 0)
{
    returnedContext = pCertContext;
    break;  // Found exact match, exit loop
}

// Keep a reference to this certificate as fallback
returnedContext = CertDuplicateCertificateContext(pCertContext);
```

**Refactoring approach:**
1. Create a static helper function `IsComputerNameMatch` that takes the certificate name and computer name and returns bool
2. Use this helper in the main loop to make the intent clearer

**Create this helper function before SelectFirstCertificateWithPrivateKey:**
```cpp
// Helper: Check if certificate name matches computer name
static bool IsComputerNameMatch(LPCTSTR szCertName, LPCTSTR szComputerName)
{
    return szCertName && szComputerName && _tcscmp(szCertName, szComputerName) == 0;
}
```

**Update the condition in SelectFirstCertificateWithPrivateKey (around line 235):**
```cpp
// Check for computer name match - exact match takes priority
if (IsComputerNameMatch(szCertName, szComputerName))
{
    returnedContext = pCertContext;
    break;  // Found exact match, exit loop
}
```

**Why this helps:**
- Names the condition's intent (checking for computer name match)
- Reduces cognitive complexity by removing the null-check mental burden (handled in helper)
- Makes the main loop logic clearer

**Do NOT modify:**
- CreateCertificate function (SEH-protected, complex crypto operations)
- ImportFileToSmartCard function (SEH-protected, smart card operations)
- Any function with __try/__except blocks
  </action>
  <verify>
    # Build EIDCardLibrary to verify changes compile
    cd C:/Users/user/Documents/EIDAuthentication
    msbuild EIDCardLibrary/EIDCardLibrary.vcxproj /p:Configuration=Release /p:Platform=x64 /t:Build /v:minimal 2>&1 | head -50
  </verify>
  <done>
    - Helper function IsComputerNameMatch exists in CertificateUtilities.cpp
    - SelectFirstCertificateWithPrivateKey uses the helper for name comparison
    - Build passes with zero errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract certificate has private key check helper</name>
  <files>EIDCardLibrary/CertificateUtilities.cpp</files>
  <action>
Extract the "has private key" check from SelectFirstCertificateWithPrivateKey into a named helper function. This pattern is already used but can be made clearer.

**Current code pattern (lines 221-225):**
```cpp
// Skip certificates without private keys
if (!CertGetCertificateContextProperty(pCertContext, CERT_KEY_PROV_INFO_PROP_ID, KeySpec, &dwSize))
{
    pCertContext = CertEnumCertificatesInStore(hCertStore, pCertContext);
    continue;
}
```

**Create this helper function before SelectFirstCertificateWithPrivateKey:**
```cpp
// Helper: Check if certificate has an associated private key
static bool CertificateHasPrivateKey(PCCERT_CONTEXT pCertContext)
{
    if (!pCertContext) return false;
    DWORD dwSize = 0;
    return CertGetCertificateContextProperty(pCertContext, CERT_KEY_PROV_INFO_PROP_ID, nullptr, &dwSize) != FALSE;
}
```

**Update the check in SelectFirstCertificateWithPrivateKey (around line 221):**
```cpp
// Skip certificates without private keys
if (!CertificateHasPrivateKey(pCertContext))
{
    pCertContext = CertEnumCertificatesInStore(hCertStore, pCertContext);
    continue;
}
```

**Why this helps:**
- Names the condition's intent (checking for private key presence)
- Reduces cognitive complexity by hiding the CertGetCertificateContextProperty API details
- Makes the early continue pattern more self-documenting
  </action>
  <verify>
    # Build EIDCardLibrary to verify changes compile
    cd C:/Users/user/Documents/EIDAuthentication
    msbuild EIDCardLibrary/EIDCardLibrary.vcxproj /p:Configuration=Release /p:Platform=x64 /t:Build /v:minimal 2>&1 | head -50
  </verify>
  <done>
    - Helper function CertificateHasPrivateKey exists in CertificateUtilities.cpp
    - SelectFirstCertificateWithPrivateKey uses the helper for private key check
    - Build passes with zero errors
  </done>
</task>

</tasks>

<verification>
1. Build EIDCardLibrary project - must succeed with zero errors
2. Verify helper functions are static file-local (not exported)
3. Verify main function logic is preserved (same behavior, clearer code)
</verification>

<success_criteria>
- Two helper functions extracted (IsComputerNameMatch, CertificateHasPrivateKey)
- SelectFirstCertificateWithPrivateKey cognitive complexity reduced
- Build passes with zero errors
- No changes to SEH-protected functions
</success_criteria>

<output>
After completion, create `.planning/phases/25-code-refactoring-complexity/25-01-SUMMARY.md`
</output>
