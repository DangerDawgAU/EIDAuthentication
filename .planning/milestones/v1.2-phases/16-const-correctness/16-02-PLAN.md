---
phase: 16-const-correctness
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - EIDLogManager/EIDLogManager.cpp
  - EIDCardLibrary/Tracing.cpp
  - EIDCardLibrary/CredentialManagement.cpp
  - EIDCardLibrary/StoredCredentialManagement.cpp
  - EIDCardLibrary/CertificateUtilities.cpp
  - EIDAuthenticationPackage/EIDSecuritySupportProvider.cpp
  - EIDCredentialProvider/CEIDProvider.cpp
autonomous: true
requirements:
  - CONST-02

must_haves:
  truths:
    - "Global pointers that never change what they point to are marked const at appropriate levels"
    - "Code compiles successfully after const pointer changes"
    - "Windows API compatibility is preserved (no const_cast needed at API boundaries)"
  artifacts:
    - path: "EIDCardLibrary/Tracing.cpp"
      provides: "Pointer definitions with correct const-ness"
    - path: "EIDLogManager/EIDLogManager.cpp"
      provides: "Global instance pointers with const"
  key_links:
    - from: "pointer declarations"
      to: "Windows API calls"
      via: "function parameters"
      pattern: "const pointer passed to non-const API parameter requires const_cast"
---

<objective>
Add const qualifiers to global pointers at appropriate levels for 31 SonarQube issues.

Purpose: Global pointers should be const at every level (pointer itself and/or pointed-to data) to prevent unintended modifications and enable compiler optimizations.

Output: Global pointers correctly marked const at appropriate levels while preserving Windows API compatibility.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/sonarqube-analysis.md

# SonarQube issue files with global pointer const issues
@sonarqube_issues/issues/High/Maintainability/

# Key constraints from PROJECT.md
- Windows API compatibility: Some pointers may need to remain non-const for API interop
- LSASS context: No exceptions, careful with memory management
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analyze and fix global pointer const issues in EIDLogManager</name>
  <files>EIDLogManager/EIDLogManager.cpp</files>
  <action>
Review EIDLogManager.cpp for global pointer const issues (SonarQube reports line 32).

Common patterns for global pointers that should be const:
1. `Type* ptr` where ptr never changes → `Type* const ptr`
2. `Type* ptr` where pointed-to data never changes → `const Type* ptr`
3. Both never change → `const Type* const ptr`

For hInst (line 32):
- This is set by Windows during WinMain/DllMain
- Do NOT mark const - it's assigned by the system

Check for other global pointers in this file that may need const treatment.
</action>
  <verify>
    - `msbuild EIDLogManager.vcxproj /p:Configuration=Release /p:Platform=x64` compiles without errors
    - No new compiler warnings
  </verify>
  <done>
EIDLogManager global pointers are correctly const-qualified where appropriate.
</done>
</task>

<task type="auto">
  <name>Task 2: Fix global pointer const issues in EIDCardLibrary</name>
  <files>
    EIDCardLibrary/Tracing.cpp,
    EIDCardLibrary/CredentialManagement.cpp,
    EIDCardLibrary/StoredCredentialManagement.cpp,
    EIDCardLibrary/CertificateUtilities.cpp
  </files>
  <action>
Review EIDCardLibrary source files for global pointer const issues.

For each global pointer:
1. Identify if the pointer itself ever changes (assigned after initialization)
2. Identify if the pointed-to data ever changes
3. Add const at appropriate levels:
   - `T* const ptr` - pointer never reassigned
   - `const T* ptr` - pointed-to data never modified
   - `const T* const ptr` - both never change

CRITICAL WINDOWS API COMPATIBILITY:
- Windows API structures often have non-const pointer members
- If a pointer is passed to a Windows API that takes non-const, evaluate:
  a) Can we mark it const and use const_cast at call site?
  b) Must it remain non-const for API requirements?
- Document any exceptions where const cannot be added

Common safe patterns to const-ify:
- Pointers to static data/lookup tables
- Pointers to configuration strings
- Pointers received from Windows APIs that are never freed/reassigned
</action>
  <verify>
    - `msbuild EIDCardLibrary.vcxproj /p:Configuration=Release /p:Platform=x64` compiles without errors
    - No new compiler warnings
  </verify>
  <done>
EIDCardLibrary global pointers are correctly const-qualified where appropriate without breaking Windows API compatibility.
</done>
</task>

<task type="auto">
  <name>Task 3: Fix global pointer const issues in remaining projects</name>
  <files>
    EIDAuthenticationPackage/EIDSecuritySupportProvider.cpp,
    EIDCredentialProvider/CEIDProvider.cpp
  </files>
  <action>
Review remaining projects for global pointer const issues:

EIDAuthenticationPackage/EIDSecuritySupportProvider.cpp:
- LSA package context pointers - be very careful
- Pointers to LSA dispatch tables may need to remain non-const
- Security-critical code path - preserve existing behavior

EIDCredentialProvider/CEIDProvider.cpp:
- Credential provider interface pointers
- COM interface pointers typically should not be const (reference counting)

For each global pointer found:
1. Evaluate const-ification safety
2. If safe, add const at appropriate levels
3. If unsafe, document why const cannot be added (LSASS constraint, COM, etc.)

IMPORTANT: When in doubt, DO NOT add const. Breaking LSASS/LSA code can cause system instability.
</action>
  <verify>
    - `msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:Build` compiles all projects without errors
    - No new compiler warnings
  </verify>
  <done>
All remaining project global pointers are correctly const-qualified where safe. Full solution builds successfully.
</done>
</task>

</tasks>

<verification>
1. Run full solution build: `msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64`
2. Verify no new compiler warnings
3. Document any pointers that could NOT be const-ified and the reason (Windows API, COM, LSASS)
</verification>

<success_criteria>
- All 31 global pointer const issues addressed (marked const or documented as exception)
- Code compiles successfully after changes
- No new compiler warnings introduced
- Windows API compatibility preserved
- LSASS-critical code paths unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/16-const-correctness/16-02-SUMMARY.md`
</output>
