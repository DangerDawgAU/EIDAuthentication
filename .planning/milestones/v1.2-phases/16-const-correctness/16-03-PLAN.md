---
phase: 16-const-correctness
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - EIDCredentialProvider/CEIDCredential.h
  - EIDCredentialProvider/CEIDCredential.cpp
  - EIDCredentialProvider/CEIDProvider.h
  - EIDCredentialProvider/CEIDProvider.cpp
  - EIDCardLibrary/CContainer.h
  - EIDCardLibrary/CContainer.cpp
  - EIDCardLibrary/CContainerHolderFactory.h
  - EIDCardLibrary/CContainerHolderFactory.cpp
autonomous: true
requirements:
  - CONST-03

must_haves:
  truths:
    - "Member functions that don't modify object state are marked const"
    - "Getter methods return const references where appropriate"
    - "Code compiles successfully after const member function additions"
  artifacts:
    - path: "EIDCredentialProvider/CEIDCredential.h"
      provides: "Class declarations with const member functions"
      pattern: ".*const\\s*;"
    - path: "EIDCardLibrary/CContainer.h"
      provides: "Container class with const getters"
  key_links:
    - from: "const member function declarations"
      to: "const member function definitions"
      via: "matching const qualifiers"
      pattern: "definition must have const if declaration has const"
---

<objective>
Mark member functions that don't modify state as const across the codebase.

Purpose: Improve code correctness and enable compiler optimizations by marking member functions that don't modify object state as const.

Output: Getter methods and other non-mutating member functions marked const in both declarations and definitions.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/sonarqube-analysis.md

# SonarQube issue files with member function const issues
@sonarqube_issues/issues/High/Maintainability/
@sonarqube_issues/issues/Medium/Maintainability/

# Key constraints
- COM interfaces cannot have const member functions (IUnknown methods)
- Windows API callback signatures may not allow const
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add const to CEIDCredential member functions</name>
  <files>
    EIDCredentialProvider/CEIDCredential.h,
    EIDCredentialProvider/CEIDCredential.cpp
  </files>
  <action>
Review CEIDCredential class for member functions that should be const.

Typical candidates for const:
- Getters: GetFieldDescriptorPtr(), GetCheckboxValue(), GetSubmitLabelValue(), etc.
- Query methods: IsSelected(), IsEnabled(), etc.
- Accessor methods that return internal state without modification

For each method:
1. Check if it modifies any member variables
2. If not, add const to BOTH declaration (in .h) and definition (in .cpp)

IMPORTANT EXCEPTIONS (do NOT mark const):
- COM interface implementations (IUnknown::QueryInterface, AddRef, Release)
- ICredentialProvider methods (must match interface signature)
- ICredentialProviderCredential methods (must match interface signature)

Pattern for adding const:
Declaration: `HRESULT GetStringValue(DWORD dwFieldId, LPWSTR* ppwsz) const;`
Definition: `HRESULT CEIDCredential::GetStringValue(DWORD dwFieldId, LPWSTR* ppwsz) const { ... }`
</action>
  <verify>
    - `msbuild EIDCredentialProvider.vcxproj /p:Configuration=Release /p:Platform=x64` compiles without errors
    - No new compiler warnings
  </verify>
  <done>
CEIDCredential member functions that don't modify state are marked const.
</done>
</task>

<task type="auto">
  <name>Task 2: Add const to CEIDProvider member functions</name>
  <files>
    EIDCredentialProvider/CEIDProvider.h,
    EIDCredentialProvider/CEIDProvider.cpp
  </files>
  <action>
Review CEIDProvider class for member functions that should be const.

Candidates for const:
- Getters for provider state
- Query methods that don't modify internal state

IMPORTANT EXCEPTIONS (do NOT mark const):
- ICredentialProvider interface methods (must match vtable layout)
- Methods that modify reference counts or credential lists
- Any method called through COM interface pointers

Be conservative with provider classes - credential provider interfaces have strict requirements.
</action>
  <verify>
    - `msbuild EIDCredentialProvider.vcxproj /p:Configuration=Release /p:Platform=x64` compiles without errors
    - No new compiler warnings
  </verify>
  <done>
CEIDProvider member functions that don't modify state and are safe to mark const are marked const.
</done>
</task>

<task type="auto">
  <name>Task 3: Add const to EIDCardLibrary class member functions</name>
  <files>
    EIDCardLibrary/CContainer.h,
    EIDCardLibrary/CContainer.cpp,
    EIDCardLibrary/CContainerHolderFactory.h,
    EIDCardLibrary/CContainerHolderFactory.cpp
  </files>
  <action>
Review EIDCardLibrary classes for member functions that should be const.

CContainer class:
- GetCertificate() - should return const pointer if certificate not modified
- GetKeySpec() - getter, likely const candidate
- GetContainerName() - getter for name
- Any method that only reads container state

CContainerHolderFactory:
- GetContainerHolderAt() - if it just returns existing holder, may be const
- Count/size getters

For each method:
1. Analyze if it modifies member variables
2. Check if it calls non-const methods internally
3. If purely read-only, add const to both .h and .cpp

Pattern verification:
```cpp
// In header
const PCCERT_CONTEXT GetCertificate() const;

// In cpp
const PCCERT_CONTEXT CContainer::GetCertificate() const {
    return m_pCertContext;
}
```
</action>
  <verify>
    - `msbuild EIDCardLibrary.vcxproj /p:Configuration=Release /p:Platform=x64` compiles without errors
    - No new compiler warnings
  </verify>
  <done>
EIDCardLibrary class member functions that don't modify state are marked const.
</done>
</task>

</tasks>

<verification>
1. Run full solution build: `msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64`
2. Verify no new compiler warnings
3. Verify const member functions don't break existing callers (especially COM interfaces)
</verification>

<success_criteria>
- Member functions that don't modify state are marked const
- Code compiles successfully after changes
- No new compiler warnings introduced
- COM interface implementations unchanged (cannot be const)
- Const-correctness consistent between declarations and definitions
</success_criteria>

<output>
After completion, create `.planning/phases/16-const-correctness/16-03-SUMMARY.md`
</output>
