---
phase: 06-verification
plan: 03
type: execute
wave: 3
depends_on: [06-02]
files_modified: []
autonomous: false

user_setup:
  - service: "Windows Login Screen Testing"
    why: "Credential Provider requires interactive testing on Windows login screen"
    manual_setup:
      - task: "Prepare test user account on each Windows version"
        required: true
      - task: "Ensure smart card reader or virtual smart card is available"
        required: true
      - task: "Have test smart card with certificate ready"
        required: true
      - task: "Enable Credential Provider COM registration"
        required: true

must_haves:
  truths:
    - "Credential Provider appears on Windows login screen"
    - "Smart card insertion is detected by Credential Provider"
    - "PIN entry interface displays correctly"
    - "Credential submission triggers LSA authentication"
    - "COM registration persists across reboots"
  artifacts:
    - path: "C:\\Windows\\System32\\EIDCredentialProvider.dll"
      provides: "Installed Credential Provider DLL"
    - path: "HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Authentication\\Credential Providers\\{B4866A0A-DB08-4835-A26F-414B46F3244C}"
      provides: "Credential Provider COM registration"
    - path: "HKCR\\CLSID\\{B4866A0A-DB08-4835-A26F-414B46F3244C}"
      provides: "COM class registration"
  key_links:
    - from: "installer registration"
      to: "HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Authentication\\Credential Providers\\{B4866A0A-DB08-4835-A26F-414B46F3244C}"
      via: "regsvr32 or COM registration"
      pattern: "{B4866A0A-DB08-4835-A26F-414B46F3244C}"
    - from: "Winlogon"
      to: "EIDCredentialProvider.dll"
      via: "COM load at logon screen"
      pattern: "LoadLibrary.*EIDCredentialProvider"
---

<objective>
Test Credential Provider appearance and functionality on Windows login screen.

Purpose: Verify the Credential Provider v2 component (EIDCredentialProvider.dll) correctly registers, appears on the Windows login/lock screen, detects smart card insertion, and provides the PIN entry interface. This is the user-facing authentication component - if it doesn't appear, users cannot log in with smart cards.

Output: Test results documenting Credential Provider visibility and smart card detection on Windows 7, 10, and 11.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-build-system/01-03-SUMMARY.md
@.planning/phases/06-verification/06-01-SUMMARY.md
@.planning/phases/06-verification/06-02-SUMMARY.md

# Credential Provider Architecture
From README.md:
- EIDCredentialProvider.dll implements Credential Provider v2
- COM CLSID: {B4866A0A-DB08-4835-A26F-414B46F3244C}
- Implements: ICredentialProvider, ICredentialProviderCredential
- Key classes: CEIDProvider, CEIDCredential, CEIDFilter, CMessageCredential
- Loads into Winlogon.exe process
- Registered in Credential Providers registry key

# Smart Card Detection
Credential Provider should:
- Detect smart card insertion via SCardGetStatusChange
- Display certificate selection UI
- Prompt for PIN entry
- Submit credentials to LSA package for authentication

# Testing Scenarios
- Login screen (Ctrl+Alt+Del)
- Lock screen (Win+L)
- Unlock after sleep
- Credential UI (runas /smartcard)

# Dependency on 06-02
LSA package must be loaded (06-02) because Credential Provider submits credentials to LSA for authentication.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Credential Provider testing checklist</name>
  <files>.planning/phases/06-verification/06-03-CREDPROV-TEST-CHECKLIST.md</files>
  <action>
Create a detailed testing checklist document for Credential Provider testing. This document will guide the human tester through verification steps.

The checklist should include:

## Test Prerequisites
- [ ] LSA package tested and working (from 06-02)
- [ ] Test user account exists on system
- [ ] Smart card reader connected or virtual smart card created
- [ ] Test smart card with enrolled certificate available
- [ ] Administrator access for DLL registration

## Installation Steps
1. Copy EIDCredentialProvider.dll to C:\Windows\System32\
2. Register COM components: `regsvr32 C:\Windows\System32\EIDCredentialProvider.dll`
3. Verify registry entries created
4. Reboot or restart Winlogon

## Verification Steps
### Scenario 1: Login Screen
1. Lock the computer (Win+L)
2. At login screen, verify "Smart Card" or "EID Authentication" option appears
3. Insert smart card
4. Verify Credential Provider detects card and shows certificate
5. Enter PIN and verify authentication proceeds

### Scenario 2: Lock Screen
1. Log in to Windows
2. Lock computer (Win+L)
3. Verify Credential Provider appears on lock screen
4. Test smart card login from lock screen

### Scenario 3: Credential UI
1. Open Command Prompt
2. Run: `runas /smartcard`
3. Verify Credential Provider appears in Credential UI

## Event Viewer Verification
1. Check Event Viewer -> Windows Logs -> System
2. Look for Winlogon errors
3. Look for Credential Provider registration errors

Create this checklist file as a markdown document.
  </action>
  <verify>File 06-03-CREDPROV-TEST-CHECKLIST.md exists in phase directory with complete checklist content.</verify>
  <done>Detailed testing checklist created with all required steps for Credential Provider verification.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Credential Provider testing checklist, build artifacts from 06-01, and LSA package from 06-02</what-built>
  <how-to-verify>
Human tester required to perform the following on EACH Windows version (7, 10, 11):

## Prerequisite Setup (once per test machine)
1. Ensure LSA package is installed and tested (from 06-02)
2. Create test user account if not exists
3. Prepare smart card reader and test card

## Credential Provider Testing (repeat on Win7, Win10, Win11)

### Step 1: Installation
1. Copy EIDCredentialProvider.dll from build output (x64\Release\) to C:\Windows\System32\
2. Register COM components:
   ```
   regsvr32 C:\Windows\System32\EIDCredentialProvider.dll
   ```
3. Confirm registration success message
4. Verify registry entries:
   - `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Authentication\Credential Providers\{B4866A0A-DB08-4835-A26F-414B46F3244C}`
   - `HKCR\CLSID\{B4866A0A-DB08-4835-A26F-414B46F3244C}`

### Step 2: Test Login Screen Appearance
1. Lock the computer (Win+L or Ctrl+Alt+Del)
2. At login screen, look for:
   - "Smart Card" or "EID Authentication" tile/icon
   - Alternative credentials selector
3. **Document:** Does the EID Credential Provider appear? (Yes/No)

### Step 3: Test Smart Card Detection
1. While at login screen, insert smart card
2. Wait 2-3 seconds for detection
3. **Document:** Does Credential Provider detect the card? (Yes/No)
4. If yes, verify certificate information displays correctly

### Step 4: Test PIN Entry
1. If card detected, click on the smart card credential
2. **Document:** Does PIN entry interface appear? (Yes/No)
3. Enter PIN (use test PIN if applicable)
4. **Document:** Does authentication proceed? (Yes/No)

### Step 5: Test Lock Screen
1. Log in to Windows with password
2. Lock computer (Win+L)
3. Verify Credential Provider appears on lock screen
4. Test smart card login from lock screen

### Step 6: Check Event Viewer
1. Open Event Viewer (eventvwr.msc)
2. Navigate to Windows Logs -> System
3. Filter for "Winlogon" or "Credential Provider" events
4. **Document:** Any errors or warnings?

## Document Results
For each Windows version tested, report:
- [ ] DLL copied and registered successfully
- [ ] Registry entries verified
- [ ] Credential Provider appears on login screen (Yes/No)
- [ ] Smart card detection working (Yes/No)
- [ ] PIN entry interface displays (Yes/No)
- [ ] Authentication proceeds (Yes/No - note if tested with actual smart card)
- [ ] Event Viewer errors (list any)
- [ ] Overall test result (PASS/FAIL)

**Note:** Full authentication flow (actual login) requires an enrolled smart card with matching certificate. If test card is not available, verify UI appearance and card detection only.

Provide the test results in your response. Use the format:
```
Windows 7: [PASS/FAIL/PARTIAL] - [notes]
Windows 10: [PASS/FAIL/PARTIAL] - [notes]
Windows 11: [PASS/FAIL/PARTIAL] - [notes]
```
  </how-to-verify>
  <resume-signal>Provide Credential Provider test results for Windows 7, 10, and 11. Type "PROCEED" when testing is complete or "BLOCKER" if critical issues found.</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Document Credential Provider test results</name>
  <files>.planning/phases/06-verification/06-03-CREDPROV-TEST-RESULTS.md</files>
  <action>
Based on the human tester's results from Task 2, create a comprehensive test results document.

Document should include:
- Test date and tester information
- Windows versions tested (with build numbers)
- Test results per version (PASS/FAIL/PARTIAL)
- Credential Provider appearance status (visible/invisible on login screen)
- Smart card detection status
- PIN entry interface status
- Event Viewer logs (if errors occurred)
- Screenshot descriptions (login screen, credential tiles)
- Any anomalies or issues discovered
- Blocker identification (if any version failed)
- Regression analysis (compare to pre-C++23 behavior if known)

**PARTIAL status**: Use when UI appears but full authentication not tested (e.g., no enrolled smart card available)

If any version FAILED, document:
- COM registration status
- Registry state
- DLL load status in Winlogon (via Process Explorer)
- Event Viewer error codes
- Potential causes (COM registration issues, missing dependencies)

If all versions PASSED, document:
- Confirmation of Credential Provider C++23 compatibility
- UI appears correctly on all Windows versions
- Smart card detection working
- Ready for next testing phase (Configuration Wizard)
  </action>
  <verify>File 06-03-CREDPROV-TEST-RESULTS.md exists with complete test documentation including all three Windows versions.</verify>
  <done>Credential Provider test results documented with pass/fail status for Windows 7, 10, and 11. Any blockers clearly identified.</done>
</task>

</tasks>

<verification>
Overall verification for 06-03 (Credential Provider Testing):

1. **Test Checklist**: Complete checklist created with all verification steps
2. **Human Testing Results**: Tester reports results for Windows 7, 10, and 11
3. **UI Appearance**: Credential Provider tile appears on login/lock screen
4. **Smart Card Detection**: Smart card insertion detected and certificate shown
5. **PIN Entry**: PIN entry interface displays correctly
6. **Event Analysis**: No Winlogon or COM errors in Event Viewer
7. **Documentation**: Test results document created with all findings

**Critical Success Criteria:**
- Credential Provider MUST appear on login screen for all three Windows versions
- Smart card detection MUST work
- PIN entry interface MUST display

**Acceptable Partial:**
- UI appears and card detection works, but full authentication not tested (no enrolled smart card)
- Document as PARTIAL, proceed to next phase

**Potential Issues:**
- COM registration failures
- UI not appearing (registry issues)
- Smart card detection not working (Smart Card API issues)
- C++23 code causing UI rendering problems
</verification>

<success_criteria>
1. Testing checklist document created
2. Credential Provider appears on login screen (Win7, Win10, Win11)
3. Smart card insertion detected correctly
4. PIN entry interface displays
5. Event Viewer shows no COM/Winlogon errors
6. Test results document created with complete findings
7. No C++23-related UI regressions

**If blockers found**: Document issue, create gap closure plan, do NOT proceed to 06-04
</success_criteria>

<output>
After completion, create `.planning/phases/06-verification/06-03-SUMMARY.md` with:
- Test results summary (PASS/FAIL/PARTIAL per Windows version)
- UI appearance status (visible/invisible)
- Smart card detection status
- Any issues discovered during testing
- Event Viewer error logs (if any)
- Screenshot references (login screen, credential tiles)
- Assessment of C++23 compatibility impact on Credential Provider
- Blocker declaration if any version failed
</output>
