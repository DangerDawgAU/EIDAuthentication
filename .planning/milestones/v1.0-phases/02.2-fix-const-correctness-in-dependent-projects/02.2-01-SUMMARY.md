---
phase: 02.2-fix-const-correctness-in-dependent-projects
plan: 01
subsystem: build-system
tags: [cpp23, const-correctness, strictStrings, credential-provider, static-buffers]

# Dependency graph
requires:
  - phase: 01-build-system
    provides: C++23 configuration in all projects
  - phase: 02.1-fix-c-23-conformance-errors
    provides: C++23 conformance error fixes (C4596, C7510, C3861)
provides:
  - Fixed const-correctness errors in EIDCredentialProvider/common.h
  - Fixed const-correctness errors in EIDCredentialProvider/helpers.cpp
  - Static buffer pattern for CREDENTIAL_PROVIDER_FIELD_DESCRIPTOR initialization
affects: [02.2-02a, 02.2-02b]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Static wchar_t arrays for string literals used in struct initialization with non-const pointer members
    - LPWSTR-compatible static buffers for Windows credential provider field descriptors

key-files:
  created: []
  modified:
    - EIDCredentialProvider/common.h
    - EIDCredentialProvider/helpers.cpp

key-decisions:
  - "Use static wchar_t arrays for struct member initialization when the member is LPWSTR (non-const pointer)"
  - "Plan's suggested fix (removing const from array declaration) was insufficient - static buffer pattern required"

patterns-established:
  - "Pattern for CREDENTIAL_PROVIDER_FIELD_DESCRIPTOR: Declare static wchar_t buffer, use in aggregate initialization"

# Metrics
duration: 12min
completed: 2026-02-15
---

# Phase 02.2 Plan 01: EIDCredentialProvider Const-Correctness Summary

**Fixed 9 C2440 const-correctness errors in EIDCredentialProvider using static wchar_t buffers for LPWSTR struct members and function variables, enabling C++23 /Zc:strictStrings compilation.**

## Performance

- **Duration:** 12 min
- **Started:** 2026-02-15T07:47:32Z
- **Completed:** 2026-02-15T07:59:42Z
- **Tasks:** 3
- **Files modified:** 2

## Accomplishments
- Fixed CREDENTIAL_PROVIDER_FIELD_DESCRIPTOR array initializations in common.h (6 fields + 3 message fields)
- Fixed PWSTR initialization in helpers.cpp ProtectAndCopyString function
- Verified zero C2440 errors from common.h and helpers.cpp in build output
- Established static buffer pattern for LPWSTR struct members

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix const-correctness in common.h field descriptors** - `41679f5` (fix)
2. **Task 2: Fix const-correctness in helpers.cpp line 139** - `6494030` (fix)
3. **Task 3: Verify EIDCredentialProvider builds successfully** - Verified (no new commit needed)

**Plan metadata:** (pending final commit)

## Files Created/Modified
- `EIDCredentialProvider/common.h` - Added static wchar_t s_wszEmptyLabel[] buffer, replaced L"" literals with s_wszEmptyLabel in field descriptor arrays
- `EIDCredentialProvider/helpers.cpp` - Added static wchar_t s_wszEmpty[] buffer, replaced L"" literal with s_wszEmpty in ProtectAndCopyString

## Decisions Made
- **Static buffer pattern required:** The plan's suggested fix (removing `const` from array declarations) was insufficient because the underlying issue is that string literals are `const wchar_t[]` in C++23 with /Zc:strictStrings, and cannot convert to `LPWSTR` (non-const) regardless of whether the enclosing array is const or not.
- **Single shared buffer for empty strings:** Used one static buffer `s_wszEmptyLabel` for all empty field labels in common.h since they are never modified.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Static buffer pattern required instead of removing const**
- **Found during:** Task 1 (common.h const-correctness)
- **Issue:** Plan specified removing `const` from array declarations to allow string literal decay to non-const pointers. This doesn't work in C++23 with /Zc:strictStrings - string literals are always const.
- **Fix:** Created static wchar_t buffer `s_wszEmptyLabel[]` and used it in place of `L""` literals in all CREDENTIAL_PROVIDER_FIELD_DESCRIPTOR initializations
- **Files modified:** EIDCredentialProvider/common.h
- **Verification:** Build passes with zero C2440 errors from common.h
- **Committed in:** 41679f5

---

**Total deviations:** 1 auto-fixed (1 bug)
**Impact on plan:** Fix was necessary for the plan to work. The plan's assumption about string literal decay was incorrect for C++23 strict strings mode.

## Issues Encountered
- Initial fix attempt (removing `const` from array) did not resolve C2440 errors - had to investigate and apply correct static buffer pattern
- Build blocked by pre-existing error in EIDCardLibrary (missing cardmod.h) - not related to this plan's scope
- One remaining C2440 error in CEIDCredential.cpp (line 649) - outside scope of this plan

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- EIDCredentialProvider common.h and helpers.cpp compile cleanly with C++23
- Plans 02.2-02a and 02.2-02b for EIDConfigurationWizard can proceed
- CEIDCredential.cpp error (line 649) may need separate fix if blocking solution build

---
*Phase: 02.2-fix-const-correctness-in-dependent-projects*
*Completed: 2026-02-15*

## Self-Check: PASSED

**Files verified:**
- EIDCredentialProvider/common.h: EXISTS
- EIDCredentialProvider/helpers.cpp: EXISTS

**Commits verified:**
- 41679f5: FOUND
- 6494030: FOUND
