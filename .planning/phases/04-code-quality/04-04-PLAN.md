---
phase: 04-code-quality
plan: 04
type: execute
wave: 2
depends_on: ["04-01", "04-02", "04-03"]
files_modified:
  - EIDCardLibrary/StoredCredentialManagement.cpp
  - EIDCardLibrary/StoredCredentialManagement.h
  - EIDConfigurationWizard/CContainerHolder.cpp
  - EIDCredentialProvider/CEIDCredential.cpp
autonomous: false
user_setup: []

must_haves:
  truths:
    - "std::format used in non-LSASS code (EIDConfigurationWizard, EIDCredentialProvider)"
    - "QUAL-02 documented as NOT APPLICABLE (no CRTP patterns)"
    - "std::string::contains() pattern documented for future use"
    - "std::span used for internal buffer handling"
    - "No std::format in LSASS components"
    - "No std::span stored in class members"
  artifacts:
    - path: ".planning/phases/04-code-quality/04-VERIFICATION.md"
      provides: "Verification of all Phase 4 requirements"
      contains: "QUAL-0[1-4]"
  key_links:
    - from: "Phase 4 completion"
      to: "Phase 5 documentation"
      via: "All quality improvements verified and documented"
      pattern: "VERIFICATION.*PASSED"
---

<objective>
Verify Phase 4 Code Quality improvements are complete and working

Purpose: Confirm all code quality improvements (std::format, std::span, string utilities) are correctly implemented and compile successfully. This checkpoint ensures QUAL-01 through QUAL-04 requirements are satisfied before moving to Phase 5 (Documentation).

Output: VERIFICATION.md documenting all improvements and confirming requirements met
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-code-quality/04-RESEARCH.md
@.planning/REQUIREMENTS.md
@.planning/phases/04-code-quality/04-01-SUMMARY.md
@.planning/phases/04-code-quality/04-02-SUMMARY.md
@.planning/phases/04-code-quality/04-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify QUAL-01 - std::format in non-LSASS code only</name>
  <files></files>
  <action>
1. Verify std::format usage in EIDConfigurationWizard/CContainerHolder.cpp:
   - Confirm `#include <format>` present
   - Confirm std::format used for error message formatting
   - Confirm swprintf_s replaced

2. Verify std::format usage in EIDCredentialProvider/CEIDCredential.cpp:
   - Confirm `#include <format>` present
   - Confirm std::format used for PIN retry message
   - Confirm swprintf_s replaced

3. Verify NO std::format in LSASS components:
   - EIDCardLibrary: grep -r "include <format>" --include="*.cpp" --include="*.h" | should return nothing
   - EIDAuthenticationPackage: grep -r "include <format>" --include="*.cpp" --include="*.h" | should return nothing
   - EIDNativeLogon: grep -r "include <format>" --include="*.cpp" --include="*.h" | should return nothing
   - EIDPasswordChangeNotification: grep -r "include <format>" --include="*.cpp" --include="*.h" | should return nothing

Expected: 2 files use std::format, 0 LSASS files use std::format
  </action>
  <verify>grep -r "std::format\|include <format>" --include="*.cpp" "C:/Users/user/Documents/EIDAuthentication/EIDConfigurationWizard" "C:/Users/user/Documents/EIDAuthentication/EIDCredentialProvider" | head -5</verify>
  <done>QUAL-01 verified: std::format in 2 non-LSASS files, 0 LSASS files</done>
</task>

<task type="auto">
  <name>Task 2: Verify QUAL-02 - Deducing This NOT APPLICABLE</name>
  <files>.planning/REQUIREMENTS.md</files>
  <action>
1. Check REQUIREMENTS.md for QUAL-02 status:
   - Confirm marked as "NOT APPLICABLE"
   - Confirm justification references absence of CRTP patterns
   - Confirm documentation is clear

2. Verify no CRTP patterns were added:
   - grep for "template.*class.*Derived" patterns
   - grep for "static_cast.*Derived.*this" patterns
   - Should return ZERO matches (excluding documentation)

Expected: QUAL-02 documented as not applicable, no CRTP code added
  </action>
  <verify>grep -A3 "QUAL-02" "C:/Users/user/Documents/EIDAuthentication/.planning/REQUIREMENTS.md"</verify>
  <done>QUAL-02 verified: Documented as NOT APPLICABLE with clear justification</done>
</task>

<task type="auto">
  <name>Task 3: Verify QUAL-03 - std::string::contains() pattern</name>
  <files></files>
  <action>
1. Note: Codebase grep found NO existing `.find() != npos` patterns to replace
2. Document that std::string::contains() is available for future code:
   - C++23 enables contains() method
   - Pattern: `if (str.contains(substring))` instead of `if (str.find(substring) != std::string::npos)`
   - No existing code needed changes

3. Verify contains() is available by checking compiler support:
   - MSVC 19.31+ (VS 2022 17.1+) supports contains()
   - Project uses /std:c++23preview which includes this feature

Expected: QUAL-03 satisfied - contains() available, no existing code needed changes
  </action>
  <verify>grep -r "\.find.*!=.*npos" --include="*.cpp" "C:/Users/user/Documents/EIDAuthentication/EIDCardLibrary" "C:/Users/user/Documents/EIDAuthentication/EIDConfigurationWizard" "C:/Users/user/Documents/EIDAuthentication/EIDCredentialProvider" || echo "No find/npos patterns found"</verify>
  <done>QUAL-03 verified: std::string::contains() available, no existing patterns to replace</done>
</task>

<task type="auto">
  <name>Task 4: Verify QUAL-04 - std::span for buffer handling</name>
  <files>EIDCardLibrary/StoredCredentialManagement.h EIDCardLibrary/StoredCredentialManagement.cpp</files>
  <action>
1. Verify StoredCredentialManagement.h:
   - Confirm `#include <span>` present
   - Confirm internal functions declared with std::span parameters
   - Confirm ProcessSecretBufferInternal declared

2. Verify StoredCredentialManagement.cpp:
   - Confirm `#include <span>` present
   - Confirm ProcessSecretBufferInternal implemented with std::span
   - Confirm exported functions convert to span and call internal helpers

3. Verify NO std::span in class members:
   - grep for "span.*m_" pattern
   - Should return ZERO matches (lifetime safety)

4. Verify API boundaries unchanged:
   - StorePrivateData signature: PBYTE pbSecret, USHORT usSecretSize (unchanged)
   - StorePrivateDataDebug signature: PBYTE pbSecret, USHORT usSecretSize (unchanged)

Expected: Internal functions use span, exports maintain C-style, no member storage
  </action>
  <verify>grep -n "ProcessSecretBufferInternal\|std::span" "C:/Users/user/Documents/EIDAuthentication/EIDCardLibrary/StoredCredentialManagement.cpp" | head -5</verify>
  <done>QUAL-04 verified: std::span used internally, exports C-style, no member storage</done>
</task>

<task type="auto">
  <name>Task 5: Build verification - all projects compile</name>
  <files></files>
  <action>
1. Build EIDCardLibrary project:
   - msbuild EIDCardLibrary/EIDCardLibrary.vcxproj /p:Configuration=Release /p:Platform=x64
   - Should compile with zero errors

2. Build EIDConfigurationWizard project:
   - msbuild EIDConfigurationWizard/EIDConfigurationWizard.vcxproj /p:Configuration=Release /p:Platform=x64
   - Should compile with zero errors

3. Build EIDCredentialProvider project:
   - msbuild EIDCredentialProvider/EIDCredentialProvider.vcxproj /p:Configuration=Release /p:Platform=x64
   - Should compile with zero errors

4. Note: Full solution build blocked by pre-existing cardmod.h SDK dependency (not Phase 4 issue)

Expected: All 3 modified projects compile successfully with C++23
  </action>
  <verify>msbuild EIDCardLibrary/EIDCardLibrary.vcxproj /p:Configuration=Release /p:Platform=x64 2>&1 | tail -10</verify>
  <done>Build verification: EIDCardLibrary, EIDConfigurationWizard, EIDCredentialProvider compile with C++23</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>All Phase 4 code quality improvements implemented</what-built>
  <how-to-verify>
1. Review 04-VERIFICATION.md (to be created by this plan)
2. Confirm all QUAL-01 through QUAL-04 requirements show as PASSED
3. Verify summary lists:
   - std::format in 2 non-LSASS files
   - QUAL-02 marked NOT APPLICABLE
   - std::span in internal buffer functions
   - No std::format in LSASS components
   - No std::span in class members
4. Check that build verification passed for all 3 modified projects
5. If all checks pass, type "approved" to continue to Phase 5
  </how-to-verify>
  <resume-signal>Type "approved" if all requirements verified, or describe issues found</resume-signal>
</task>

<task type="auto">
  <name>Task 7: Create VERIFICATION.md documenting Phase 4 results</name>
  <files>.planning/phases/04-code-quality/04-VERIFICATION.md</files>
  <action>
Create 04-VERIFICATION.md with sections for each QUAL requirement:

```markdown
# Phase 4: Code Quality - Verification

**Verified:** 2026-02-15

## QUAL-01: std::format in non-LSASS code
**Status:** PASSED
- std::format used in EIDConfigurationWizard/CContainerHolder.cpp (error formatting)
- std::format used in EIDCredentialProvider/CEIDCredential.cpp (PIN retry message)
- NO std::format in LSASS components (EIDCardLibrary, EIDAuthenticationPackage, EIDNativeLogon, EIDPasswordChangeNotification)
- **Security:** No exception-throwing code in LSASS context

## QUAL-02: Deducing This for CRTP patterns
**Status:** NOT APPLICABLE
- Codebase contains ZERO CRTP implementations
- Deducing `this` is specifically for modernizing CRTP code
- No candidates for deducing `this` modernization exist

## QUAL-03: std::string::contains() for string operations
**Status:** PASSED
- std::string::contains() available with C++23 (/std:c++23preview)
- No existing `.find() != npos` patterns needed replacement
- Pattern available for future code: `str.contains(substring)`

## QUAL-04: std::span for buffer handling
**Status:** PASSED
- Internal functions use std::span for bounds-safe buffer access
- ProcessSecretBufferInternal/ProcessSecretBufferDebugInternal use std::span
- Exported API boundaries maintain C-style signatures (PBYTE, DWORD)
- NO std::span stored in class members (lifetime safety)

## Build Verification
**Status:** PASSED
- EIDCardLibrary compiles with C++23
- EIDConfigurationWizard compiles with C++23
- EIDCredentialProvider compiles with C++23

## Phase 4 Overall
**Status:** COMPLETE
- All applicable requirements satisfied
- No LSASS safety violations
- All modified projects build successfully
```
  </action>
  <verify>ls -la "C:/Users/user/Documents/EIDAuthentication/.planning/phases/04-code-quality/04-VERIFICATION.md"</verify>
  <done>04-VERIFICATION.md documents all Phase 4 requirements as PASSED</done>
</task>

</tasks>

<verification>
1. QUAL-01 verified: std::format in non-LSASS only
2. QUAL-02 verified: NOT APPLICABLE documented
3. QUAL-03 verified: contains() available
4. QUAL-04 verified: std::span used internally
5. Build verification passed
6. VERIFICATION.md created
7. User approved checkpoint
</verification>

<success_criteria>
1. All QUAL-01 through QUAL-04 requirements verified
2. 04-VERIFICATION.md created with all statuses
3. Build verification passed for modified projects
4. User approval obtained at checkpoint
5. Ready for Phase 5 (Documentation)
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-quality/04-04-SUMMARY.md`
</output>
