---
phase: "37-nesting-reduction"
plan: "01"
type: "execute"
wave: 1
depends_on: ["36-complexity-reduction"]
files_modified:
  - "EIDCardLibrary/StoredCredentialManagement.cpp"
  - "EIDCredentialProvider/CEIDProvider.cpp"
  - "EIDCredentialProvider/CEIDCredential.cpp"
autonomous: true
requirements: ["STRUCT-03", "STRUCT-04"]

must_haves:
  truths:
    - "Guard clauses added at function entry for early return"
    - "Deep nesting reduced in functions not protected by SEH"
    - "SEH blocks documented as won't-fix (no extraction from __try)"
    - "Build passes with zero errors after nesting reduction"
  artifacts:
    - path: "EIDCardLibrary/StoredCredentialManagement.cpp"
      provides: "Credential management with reduced nesting where safe"
    - path: "EIDCredentialProvider/CEIDProvider.cpp"
      provides: "Credential provider with reduced nesting"
    - path: "EIDCredentialProvider/CEIDCredential.cpp"
      provides: "Credential object with reduced nesting"
  key_links:
    - from: "SEH-protected functions"
      to: "Won't-fix documentation"
      via: "__try/__except/__finally patterns"
      pattern: "__try\\s*\\{"
---

<objective>
Reduce deep nesting (>3 levels) in non-SEH-protected functions via guard clauses and early return patterns. SEH-protected code is documented as won't-fix since extraction from __try blocks is not possible.

Purpose: Improve code readability and maintainability while preserving SEH safety constraints.
Output: Functions with reduced nesting depth, documented SEH won't-fix decisions.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY.md
@sonarqube_issues/README.md

# Context from Prior Phases
Pattern established in v1.3 Phase 24: Extract nested handlers to static functions with early return pattern.

## Key Constraint
SEH-protected code (using __try/__except/__finally) CANNOT have code extracted from __try blocks. The codebase has ~166 SEH block occurrences across 21 files. These must be documented as won't-fix for nesting reduction.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add guard clauses for early return in StoredCredentialManagement.cpp non-SEH functions</name>
  <files>EIDCardLibrary/StoredCredentialManagement.cpp</files>
  <action>
Reduce nesting in non-SEH-protected helper functions in StoredCredentialManagement.cpp by adding guard clauses at function entry points.

**Functions to analyze for nesting reduction (SEH-protected functions are won't-fix):**
- GetUsernameFromCertContext: SEH-protected (__try/__finally) - DOCUMENT AS WON'T-FIX
- HasStoredCredential: Simple delegation, no deep nesting
- GetCertContextFromHash: SEH-protected (__try/__finally) - DOCUMENT AS WON'T-FIX
- GetCertContextFromRid: SEH-protected (__try/__finally) - DOCUMENT AS WON'T-FIX
- CreateCredential: SEH-protected (__try/__finally) - DOCUMENT AS WON'T-FIX
- UpdateCredential (LUID version): SEH-protected (__try/__finally) - DOCUMENT AS WON'T-FIX
- UpdateCredential (RID version): Check for SEH, apply guard clauses if not protected
- DeleteCredential: Check for SEH, apply guard clauses if not protected
- RetrievePrivateData: Check for SEH, apply guard clauses if not protected
- StorePrivateData: Check for SEH, apply guard clauses if not protected

**Guard clause pattern to apply:**
```cpp
// Before (nested if):
BOOL Function(Type* ptr) {
    __try {
        if (!ptr) {
            dwError = ERROR_INVALID_PARAMETER;
            __leave;
        }
        // ... rest of code nested
    }
    __finally { ... }
}

// After (for non-SEH functions):
BOOL Function(Type* ptr) {
    if (!ptr) {
        SetLastError(ERROR_INVALID_PARAMETER);
        return FALSE;
    }
    // ... rest of code at reduced nesting level
}
```

**For SEH-protected functions:** Add comment documenting won't-fix:
```cpp
// SonarQube S134: Won't Fix - SEH-protected function (__try/__finally)
// Code cannot be extracted from __try blocks per LSASS safety requirements
```

**Scope:** Focus on non-SEH helper functions. Document SEH blocks as won't-fix with justification.
  </action>
  <verify>
grep -c "__try" EIDCardLibrary/StoredCredentialManagement.cpp returns same count before and after
grep -c "Won.t Fix - SEH" EIDCardLibrary/StoredCredentialManagement.cpp increases
  </verify>
  <done>
SEH-protected functions documented as won't-fix. Non-SEH functions have guard clauses where applicable. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add guard clauses in CEIDProvider.cpp callback and initialization</name>
  <files>EIDCredentialProvider/CEIDProvider.cpp</files>
  <action>
Reduce nesting in CEIDProvider.cpp functions using guard clauses and early return patterns.

**Functions to analyze:**
- CEIDProvider::Callback: Has nested if statements for szCardName checks
- CEIDProvider::Initialize: Has nested if statements for credential creation
- CEIDProvider::SetUsageScenario: Check for deep nesting

**Guard clause patterns to apply:**
1. In Callback function for message handling:
```cpp
// Before:
case EIDCPRSConnecting:
    if (szCardName) {
        if (_pMessageCredential) {
            _pMessageCredential->SetStatus(Reading);
            // nested code
        }
    }
    break;

// After:
case EIDCPRSConnecting:
    if (!szCardName) break;  // guard clause
    if (_pMessageCredential) {
        _pMessageCredential->SetStatus(Reading);
        // reduced nesting
    }
    break;
```

2. In Initialize for credential creation:
```cpp
// Before:
if (!_pMessageCredential) {
    hr = CMessageCredential::Create(...);
    if (SUCCEEDED(hr)) {
        // nested creation code
    }
}

// After:
if (_pMessageCredential) return S_OK;  // early exit - already created
hr = CMessageCredential::Create(...);
if (FAILED(hr)) return hr;  // guard clause
// reduced nesting for remaining code
```

**Verify no SEH blocks in this file before applying changes.**
  </action>
  <verify>
grep -c "__try" EIDCredentialProvider/CEIDProvider.cpp returns 0
Build compiles without errors
  </verify>
  <done>
CEIDProvider.cpp has reduced nesting via guard clauses. No SEH blocks present.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add guard clauses in CEIDCredential.cpp initialization</name>
  <files>EIDCredentialProvider/CEIDCredential.cpp</files>
  <action>
Reduce nesting in CEIDCredential.cpp functions using guard clauses and early return patterns.

**Functions to analyze:**
- CEIDCredential::Initialize: Has sequential SUCCEEDED(hr) checks that can use early return
- CEIDCredential::GetSerialization: Check for deep nesting in serialization logic
- CEIDCredential::ReportResult: Check for deep nesting

**Guard clause pattern for Initialize:**
```cpp
// Before:
HRESULT CEIDCredential::Initialize() {
    HRESULT hr = S_OK;
    for (...) {
        // copy descriptors
    }
    if (SUCCEEDED(hr)) {
        SHStrDupW(...);
    }
    if (SUCCEEDED(hr)) {
        hr = SHStrDupW(...);
    }
    // multiple nested SUCCEEDED checks
    return S_OK;
}

// After (using early return on failure):
HRESULT CEIDCredential::Initialize() {
    HRESULT hr = S_OK;
    for (...) {
        // copy descriptors
        if (FAILED(hr)) return hr;  // early exit
    }
    hr = SHStrDupW(...);
    if (FAILED(hr)) return hr;
    // reduced nesting for remaining operations
    return S_OK;
}
```

**Note:** Be careful with cleanup in destructor - early returns don't need explicit cleanup since destructor handles it.

**Verify no SEH blocks in this file before applying changes.**
  </action>
  <verify>
grep -c "__try" EIDCredentialProvider/CEIDCredential.cpp returns 0
Build compiles without errors
  </verify>
  <done>
CEIDCredential.cpp has reduced nesting via guard clauses. No SEH blocks present.
  </done>
</task>

<task type="auto">
  <name>Task 4: Build verification and won't-fix documentation</name>
  <files>EIDCardLibrary/StoredCredentialManagement.cpp, EIDCredentialProvider/CEIDProvider.cpp, EIDCredentialProvider/CEIDCredential.cpp</files>
  <action>
1. Build the entire solution to verify no compilation errors:
   ```
   msbuild EIDCredentialProvider.sln /p:Configuration=Release /p:Platform=x64
   ```

2. Document won't-fix decisions for SEH-protected code:
   - Add inline comments where SEH prevents nesting reduction
   - Format: "// SonarQube S134: Won't Fix - SEH-protected code cannot be extracted from __try blocks"

3. Verify no new warnings introduced:
   - Compare warning count before and after changes
   - Any new warnings must be addressed

4. Run static analysis if available:
   - Verify clang-tidy or MSVC Code Analysis passes
  </action>
  <verify>
msbuild returns 0 errors
No new warnings compared to baseline
grep -c "Won.t Fix - SEH" returns count >= SEH block occurrences documented
  </verify>
  <done>
Build passes with zero errors. SEH won't-fix decisions documented. No new warnings introduced.
  </done>
</task>

</tasks>

<verification>
1. All 7 projects build successfully with zero errors
2. No new warnings introduced
3. SEH-protected functions documented as won't-fix with justification
4. Non-SEH functions have guard clauses reducing nesting depth where applicable
5. No code extracted from __try blocks (SEH safety preserved)
</verification>

<success_criteria>
1. Guard clauses added at function entry for early return in non-SEH functions
2. Deep nesting reduced using helper functions where safe (non-SEH code)
3. SEH blocks documented as won't-fix (no extraction from __try)
4. Build passes with zero errors after nesting reduction
</success_criteria>

<output>
After completion, create `.planning/phases/37-nesting-reduction/37-01-SUMMARY.md`
</output>
