---
phase: 39-integration-changes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - EIDCardLibrary/EIDCardLibrary.h
  - EIDCardLibrary/CContainerHolderFactory.cpp
  - EIDCardLibrary/smartcardmodule.cpp
  - EIDCardLibrary/CertificateValidation.cpp
  - EIDCardLibrary/CertificateUtilities.cpp
  - EIDCardLibrary/Package.cpp
  - EIDCardLibrary/Tracing.cpp
  - EIDCardLibrary/StoredCredentialManagement.cpp
  - EIDCredentialProvider/CEIDCredential.cpp
  - EIDCredentialProvider/helpers.cpp
  - EIDCredentialProvider/CMessageCredential.cpp
  - EIDCredentialProvider/common.h
  - EIDConfigurationWizard/global.h
  - EIDConfigurationWizard/EIDConfigurationWizard.cpp
  - EIDConfigurationWizard/EIDConfigurationWizardPage02.cpp
  - EIDConfigurationWizard/EIDConfigurationWizardPage03.cpp
  - EIDConfigurationWizard/EIDConfigurationWizardPage04.cpp
  - EIDConfigurationWizard/DebugReport.cpp
  - EIDConfigurationWizard/Common.cpp
  - EIDConfigurationWizard/CContainerHolder.cpp
  - EIDAuthenticationPackage/EIDSecuritySupportProvider.cpp
autonomous: true
requirements:
  - MODERN-03
  - MODERN-04

must_haves:
  truths:
    - "Small C-style arrays (<256 bytes) are converted to std::array"
    - "Large stack buffers (>1KB) remain as C-style arrays"
    - "std::string/std::vector conversions are documented as won't-fix"
    - "Build passes with zero errors after all conversions"
  artifacts:
    - path: "EIDCardLibrary/EIDCardLibrary.h"
      provides: "Protocol message structures with fixed-size arrays"
      contains: "std::array"
    - path: "EIDCardLibrary/Tracing.cpp"
      provides: "Tracing buffer conversions"
      contains: "std::array"
  key_links:
    - from: "EIDCardLibrary.h structures"
      to: "network protocol"
      via: "challenge-response messages"
      pattern: "Signature\\[8\\]|Hash\\[.*\\]"
    - from: "stack allocated buffers"
      to: "LSASS process"
      via: "function call frames"
      pattern: "\\w+\\s*\\[\\d+\\]"
---

<objective>
Convert safe C-style arrays to std::array where stack size permits, and document won't-fix categories for LSASS safety.

Purpose: Improve type safety and bounds checking for fixed-size buffers while maintaining LSASS process stability.
Output: ~30 std::array conversions, won't-fix documentation for large buffers and heap-allocating containers.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY.md
@sonarqube_issues/README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert small protocol message arrays to std::array</name>
  <files>EIDCardLibrary/EIDCardLibrary.h, EIDCardLibrary/smartcardmodule.cpp, EIDCardLibrary/StoredCredentialManagement.cpp</files>
  <action>
Convert small C-style arrays in protocol structures and local variables to std::array.

**Target conversions (small arrays, safe for stack):**
1. `EIDCardLibrary.h` protocol structures:
   - `BYTE Signature[8]` in EID_NEGOCIATE_MESSAGE, EID_CHALLENGE_MESSAGE, EID_RESPONSE_MESSAGE
   - `UCHAR Hash[CERT_HASH_LENGTH]` in EID_NEGOCIATE_MESSAGE
   - Already constexpr: `constexpr char EID_MESSAGE_SIGNATURE[8]` - this is fine as-is (C-style array in constexpr context is acceptable)

2. `smartcardmodule.cpp`:
   - `BYTE bAtr[32]` - ATR buffer (32 bytes, safe)
   - `TCHAR szReaderTemp[256]` - reader name (512 bytes TCHAR, safe for Wizard but keep C-style for LSASS compatibility)

3. `StoredCredentialManagement.cpp`:
   - `unsigned char data[16]` - 16-byte MD5 buffer (safe)
   - `unsigned char bHash[16]` - 16-byte hash (safe)

**Implementation pattern:**
```cpp
// Before:
BYTE Signature[8];
// After:
std::array&lt;BYTE, 8&gt; Signature;

// Before:
unsigned char data[16];
// After:
std::array&lt;unsigned char, 16&gt; data;
```

**Include required header:** `#include &lt;array&gt;`

**Do NOT convert:**
- Any array larger than 256 bytes total (stack safety)
- Arrays used with Windows APIs that require raw pointer decay (use `.data()` method if needed)
- Global mutable arrays (like szReader[256], szCard[256] in ConfigurationWizard)
  </action>
  <verify>
Build command: `msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:EIDCardLibrary`
Expected: Build succeeds with 0 errors
  </verify>
  <done>
Protocol message structures use std::array for fixed-size fields, small local buffers converted, build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert small local buffers to std::array in LSASS-loaded code</name>
  <files>EIDCardLibrary/CertificateValidation.cpp, EIDCardLibrary/Tracing.cpp, EIDCardLibrary/CertificateUtilities.cpp, EIDCardLibrary/Package.cpp</files>
  <action>
Convert small local C-style arrays in LSASS-loaded code (EIDCardLibrary, EIDAuthenticationPackage) to std::array.

**Safe conversions (small buffers, less than 256 bytes):**

1. `CertificateValidation.cpp`:
   - `BYTE pbHash[100]` - 100 bytes (safe)
   - DO NOT convert `BYTE Data[4096]` - 4KB stack buffer, too large

2. `Tracing.cpp`:
   - `UCHAR buffer[10]` - 10-byte debug buffer (safe)
   - DO NOT convert: `WCHAR Section[100]`, `WCHAR Buffer[256]`, `WCHAR Buffer2[356]`, `WCHAR Buffer[512]`, `WCHAR AuditBuffer[600]`, `WCHAR ContextBuffer[256]`, `WCHAR FinalBuffer[512]`, `WCHAR ErrorBuffer[256]`, `WCHAR FrameBuffer[128]` - these are tracing buffers that may be used with Windows APIs requiring raw pointers

3. `CertificateUtilities.cpp`:
   - `BYTE SerialNumber[8]` - 8 bytes (safe)
   - DO NOT convert: `TCHAR szCertName[1024]`, `TCHAR szComputerName[257]`, `TCHAR szProviderName[1024]`, `CHAR szContainerName[1024]`, `BYTE Data[4096]`, `TCHAR szMainContainerName[1024]` - large buffers

4. `Package.cpp`:
   - DO NOT convert: `WCHAR Buffer[1000]`, `TCHAR szExeName[256]`, `WCHAR szAdministratorGroupName[256]`, `WCHAR szDomainName[256]` - used with Windows APIs

**Implementation notes:**
- Use `std::array&lt;T, N&gt;` for small, fixed-size buffers
- Access raw pointer with `.data()` when needed for Windows APIs
- Ensure `SecureZeroMemory` works with `.data()` pointer
  </action>
  <verify>
Build command: `msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:EIDCardLibrary`
Expected: Build succeeds with 0 errors
  </verify>
  <done>
Small local buffers in LSASS code converted to std::array, large buffers preserved as C-style, build passes
  </done>
</task>

<task type="auto">
  <name>Task 3: Convert small buffers in Credential Provider and Configuration Wizard</name>
  <files>EIDCredentialProvider/CEIDCredential.cpp, EIDCredentialProvider/helpers.cpp, EIDCredentialProvider/CMessageCredential.cpp, EIDCredentialProvider/common.h, EIDConfigurationWizard/EIDConfigurationWizardPage02.cpp, EIDConfigurationWizard/EIDConfigurationWizardPage03.cpp, EIDConfigurationWizard/EIDConfigurationWizardPage04.cpp, EIDConfigurationWizard/DebugReport.cpp, EIDConfigurationWizard/Common.cpp, EIDConfigurationWizard/CContainerHolder.cpp</files>
  <action>
Convert small C-style arrays in Credential Provider and Configuration Wizard to std::array.

**Credential Provider conversions:**
1. `CEIDCredential.cpp`:
   - `WCHAR Message[256]`, `WCHAR MessageFormatted[256]`, `WCHAR szCertificateDetail[256]` - These are used with Windows string APIs, evaluate each case:
   - Message buffers used with `swprintf_s` - safe to convert
   - DO NOT convert if used with Windows APIs requiring exact C-array semantics

2. `helpers.cpp`:
   - `WCHAR szUserName[256]`, `WCHAR szPassword[256]` - credential buffers
   - DO NOT convert: These contain sensitive credential data and are used with Windows credential APIs

3. `CMessageCredential.cpp`:
   - `WCHAR szDisableForcePolicy[256]` - policy string, evaluate

**Configuration Wizard conversions:**
1. `EIDConfigurationWizardPage02.cpp`:
   - `TCHAR szATR[256]`, `TCHAR szMessageFormat[256]`, `TCHAR szMessage[356]`, `TCHAR szName[1024]`, `TCHAR szParameter[1024]`
   - DO NOT convert: Used with Windows string formatting APIs

2. `EIDConfigurationWizardPage03.cpp`:
   - `wchar_t szBuffer2[1024]`, `wchar_t szLocalDate[255]`, `wchar_t szLocalTime[255]`
   - DO NOT convert: Used with Windows time/formatting APIs

3. `EIDConfigurationWizardPage04.cpp`:
   - `TCHAR szMessage[256]` - Used with Windows message box APIs

4. `DebugReport.cpp`:
   - `TCHAR szMessage[256]`, `TCHAR szCaption[256]`, `TCHAR szNamedPipeName[256]`, `TCHAR szParameter[356]`, `TCHAR szName[1024]`, `TCHAR szFile[256]`
   - DO NOT convert: Used with Windows pipe and file APIs

5. `Common.cpp`:
   - `TCHAR szUser[255]`, `TCHAR szDomain[255]`, `TCHAR szComputerName[255]`
   - DO NOT convert: Used with Windows account APIs

6. `CContainerHolder.cpp`:
   - `TCHAR szName[1024]`, `TCHAR szParameters[8000]`
   - DO NOT convert: Used with Windows crypto APIs

**Conclusion:** Most Credential Provider and Wizard arrays interface with Windows APIs that require C-style arrays. Focus only on internal temporary buffers that are NOT passed to Windows APIs.

**Safe to convert:**
- Internal message formatting buffers NOT passed to Windows APIs
- Temporary computation buffers
  </action>
  <verify>
Build command: `msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:EIDCredentialProvider;EIDConfigurationWizard`
Expected: Build succeeds with 0 errors
  </verify>
  <done>
Safe small buffers in Credential Provider and Wizard converted, Windows API interfacing arrays preserved as C-style
  </done>
</task>

<task type="auto">
  <name>Task 4: Document won't-fix categories for SonarQube</name>
  <files>sonarqube_issues/WONT_FIX_CATEGORIES.md</files>
  <action>
Create a comprehensive won't-fix documentation file for SonarQube issue categorization related to C-style arrays and containers.

**Create file: `sonarqube_issues/WONT_FIX_CATEGORIES.md`**

Document the following won't-fix categories with justifications:

1. **Large stack buffers (more than 1KB)** - Keep as C-style arrays
   - `BYTE Data[4096]` in CertificateValidation.cpp
   - `TCHAR szParameters[8000]` in CContainerHolder.cpp
   - `TCHAR szProviderName[1024]`, `CHAR szContainerName[1024]` in multiple files
   - Justification: Stack size safety in LSASS context - large std::array adds no value and increases stack frame

2. **Global mutable arrays** - Keep as C-style arrays
   - `WCHAR szReader[256]`, `WCHAR szCard[256]`, `WCHAR szUserName[256]`, `WCHAR szPassword[256]` in EIDConfigurationWizard/global.h
   - Justification: External linkage, Windows API compatibility, sensitive credential data

3. **Windows API interfacing arrays** - Keep as C-style arrays
   - Arrays passed to Windows APIs requiring raw pointers
   - Justification: Windows API compatibility, no benefit from std::array wrapper

4. **std::string/std::vector** - Won't fix, document as won't-fix
   - ~181 issues suggesting std::string instead of C-style char array
   - Justification: LSASS heap safety - dynamic memory allocation is dangerous in LSASS context. C-style buffers with SecureZeroMemory are the correct pattern.

**For each won't-fix category, provide:**
- Issue pattern (SonarQube rule ID if known)
- Estimated issue count
- Technical justification
- Code examples where applicable
  </action>
  <verify>
File exists at `sonarqube_issues/WONT_FIX_CATEGORIES.md` with documented won't-fix categories
  </verify>
  <done>
Won't-fix categories documented for SonarQube, ready for issue resolution marking
  </done>
</task>

<task type="auto">
  <name>Task 5: Full solution build verification</name>
  <files>(No file modifications - verification only)</files>
  <action>
Perform a full solution rebuild to verify all std::array conversions compile correctly.

**Build steps:**
1. Clean solution: `msbuild EIDAuthentication.sln /t:Clean /p:Configuration=Release /p:Platform=x64`
2. Rebuild all: `msbuild EIDAuthentication.sln /t:Rebuild /p:Configuration=Release /p:Platform=x64`

**Verification criteria:**
- Zero compilation errors
- No new warnings introduced
- All 7 projects build successfully:
  - EIDCardLibrary
  - EIDAuthenticationPackage
  - EIDCredentialProvider
  - EIDPasswordChangeNotification
  - EIDConfigurationWizard
  - EIDConfigurationWizardElevated
  - EIDLogManager

**If build fails:**
- Examine compilation errors
- Check for missing `#include &lt;array&gt;` headers
- Verify `.data()` usage for Windows API calls
- Revert problematic conversions and document as won't-fix
  </action>
  <verify>
Build command: `msbuild EIDAuthentication.sln /t:Rebuild /p:Configuration=Release /p:Platform=x64`
Expected: Build succeeds with 0 errors, 0 new warnings
  </verify>
  <done>
Full solution builds with zero errors after std::array conversions, all projects compile successfully
  </done>
</task>

</tasks>

<verification>
1. All small protocol message arrays converted to std::array
2. Small local buffers in LSASS code converted where safe
3. Large buffers (more than 1KB) preserved as C-style arrays
4. Global mutable arrays preserved as C-style arrays
5. Windows API interfacing arrays preserved as C-style arrays
6. Won't-fix categories documented in sonarqube_issues/WONT_FIX_CATEGORIES.md
7. Full solution rebuild passes with zero errors
8. No new warnings introduced
</verification>

<success_criteria>
1. Approximately 10-15 std::array conversions completed (small, safe buffers only)
2. Large stack buffers kept as C-style arrays (stack safety)
3. std::string/std::vector documented as won't-fix with LSASS heap safety justification
4. Build passes with zero errors after integration changes
5. Won't-fix documentation created for SonarQube issue resolution
</success_criteria>

<output>
After completion, create `.planning/phases/39-integration-changes/39-01-SUMMARY.md`
</output>
