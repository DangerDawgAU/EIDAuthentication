---
phase: 25-code-refactoring-complexity
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - EIDConfigurationWizard/EIDConfigurationWizardPage04.cpp
autonomous: true
requirements: [REFACT-01, REFACT-02]

must_haves:
  truths:
    - "WndProc_04CHECKS WM_NOTIFY handler has reduced cognitive complexity"
    - "Helper functions extract common patterns for credential list handling"
    - "Build passes with zero errors"
  artifacts:
    - path: "EIDConfigurationWizard/EIDConfigurationWizardPage04.cpp"
      provides: "Configuration wizard page 04 with reduced complexity"
      contains: "static.*Handle"
  key_links:
    - from: "WndProc_04CHECKS"
      to: "helper functions"
      via: "function call"
      pattern: "Handle\\w+\\s*\\("
---

<objective>
Extract helper functions from WndProc_04CHECKS WM_NOTIFY handler in EIDConfigurationWizardPage04.cpp to reduce cognitive complexity by separating distinct operations.

Purpose: Make the window procedure more readable by extracting distinct operations into focused helper functions.
Output: EIDConfigurationWizardPage04.cpp with extracted helpers and reduced cognitive complexity.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-code-refactoring-complexity/25-RESEARCH.md
@EIDConfigurationWizard/EIDConfigurationWizardPage04.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract credential list refresh helper from WndProc_04CHECKS</name>
  <files>EIDConfigurationWizard/EIDConfigurationWizardPage04.cpp</files>
  <action>
The WndProc_04CHECKS function has a complex NM_CLICK/NM_RETURN handler (lines 588-626) that handles refresh operations. Extract the refresh logic into a helper function.

**Current code pattern (lines 588-626):**
The NM_CLICK/NM_RETURN case has multiple operations:
1. Check for "idrefresh" click
2. Clear data and disconnect notification
3. Prompt for card
4. Reconnect and refresh

**Create this helper function before WndProc_04CHECKS (around line 22):**
```cpp
// Helper: Handle refresh button click - reconnect to smart card and refresh credential list
// Returns TRUE if refresh succeeded, FALSE if cancelled or failed
static BOOL HandleRefreshRequest(HWND hWnd)
{
    if (!pCredentialList) return FALSE;

    // Clear all data
    PropSheet_SetWizButtons(hWnd, PSWIZB_BACK);
    pCredentialList->DisconnectNotification(szReader);
    dwCurrentCredential = 0xFFFFFFFF;
    ListView_DeleteAllItems(GetDlgItem(hWnd, IDC_04LIST));
    ListView_DeleteAllItems(GetDlgItem(hWnd, IDC_04CHECKS));

    // Prompt for card
    if (!AskForCard(szReader, dwReaderSize, szCard, dwCardSize))
    {
        LONG lReturn = GetLastError();
        if (lReturn != SCARD_W_CANCELLED_BY_USER)
        {
            MessageBoxWin32Ex(lReturn, hWnd);
        }
        return FALSE;
    }

    // Reconnect and trigger refresh
#pragma warning(push)
#pragma warning(disable: 4302)
    SetCursor(LoadCursorW(nullptr, MAKEINTRESOURCEW(IDC_WAIT)));
#pragma warning(pop)
    pCredentialList->ConnectNotification(szReader, szCard, 0);
#pragma warning(push)
#pragma warning(disable: 4302)
    SetCursor(LoadCursorW(nullptr, MAKEINTRESOURCEW(IDC_ARROW)));
#pragma warning(pop)

    // Send activation message to refresh UI
    NMHDR nmh;
    nmh.code = PSN_SETACTIVE;
    SendMessage(hWnd, WM_NOTIFY, 0, (LPARAM)&nmh);
    return TRUE;
}
```

**Update the NM_CLICK/NM_RETURN handler (lines 588-626):**
```cpp
case NM_CLICK:
case NM_RETURN:
    {
        PNMLINK pNMLink = (PNMLINK)lParam;
        LITEM item = pNMLink->item;
        if (wcscmp(item.szID, L"idrefresh") == 0)
        {
            HandleRefreshRequest(hWnd);
        }
    }
    break;
```

**Why this helps:**
- Extracts the refresh logic into a focused function
- Reduces cognitive complexity in the main message handler
- Makes the refresh operation self-documenting
- Preserves the exact behavior including cursor changes and error handling
  </action>
  <verify>
    # Build EIDConfigurationWizard to verify changes compile
    cd C:/Users/user/Documents/EIDAuthentication
    msbuild EIDConfigurationWizard/EIDConfigurationWizard.vcxproj /p:Configuration=Release /p:Platform=x64 /t:Build /v:minimal 2>&1 | head -50
  </verify>
  <done>
    - Helper function HandleRefreshRequest exists in EIDConfigurationWizardPage04.cpp
    - NM_CLICK/NM_RETURN handler uses the helper
    - Build passes with zero errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract credential selection change handler</name>
  <files>EIDConfigurationWizard/EIDConfigurationWizardPage04.cpp</files>
  <action>
The LVN_ITEMCHANGED handler (lines 526-553) handles selection changes in the credential list. Extract this logic into a helper function.

**Current code pattern (lines 526-553):**
Complex selection handling with multiple conditions for selected vs deselected state.

**Create this helper function before WndProc_04CHECKS:**
```cpp
// Helper: Handle credential selection change in the list view
static void HandleCredentialSelectionChange(HWND hWnd, LPNMITEMACTIVATE pnmItem)
{
    if (!pCredentialList) return;

    if (pnmItem->uNewState & LVIS_SELECTED)
    {
        if ((DWORD)pnmItem->iItem < pCredentialList->ContainerHolderCount())
        {
            fHasDeselected = FALSE;
            dwCurrentCredential = (DWORD)pnmItem->iItem;
            PopulateListViewCheckData(GetDlgItem(hWnd, IDC_04LIST), GetDlgItem(hWnd, IDC_04CHECKS));

            if (pCredentialList->GetContainerHolderAt(dwCurrentCredential)->GetIconIndex())
            {
                PropSheet_SetWizButtons(hWnd, PSWIZB_NEXT | PSWIZB_BACK);
            }
            else
            {
                PropSheet_SetWizButtons(hWnd, PSWIZB_BACK);
            }
        }
    }
    else
    {
        // Deselection - clear check list and reset state
        ListView_DeleteAllItems(GetDlgItem(hWnd, IDC_04CHECKS));
        PropSheet_SetWizButtons(hWnd, PSWIZB_BACK);
        fHasDeselected = TRUE;
        PostMessage(hWnd, WM_MYMESSAGE, 0, 0);
    }
}
```

**Update the LVN_ITEMCHANGED handler:**
```cpp
case LVN_ITEMCHANGED:
    if (pnmh->idFrom == IDC_04LIST && pCredentialList)
    {
        HandleCredentialSelectionChange(hWnd, (LPNMITEMACTIVATE)lParam);
    }
    break;
```

**Why this helps:**
- Extracts selection logic into a focused function
- Reduces cognitive complexity by naming the operation
- Makes the selection/deselection logic clearer
- Preserves all existing behavior including the WM_MYMESSAGE post for reselection
  </action>
  <verify>
    # Build EIDConfigurationWizard to verify changes compile
    cd C:/Users/user/Documents/EIDAuthentication
    msbuild EIDConfigurationWizard/EIDConfigurationWizard.vcxproj /p:Configuration=Release /p:Platform=x64 /t:Build /v:minimal 2>&1 | head -50
  </verify>
  <done>
    - Helper function HandleCredentialSelectionChange exists in EIDConfigurationWizardPage04.cpp
    - LVN_ITEMCHANGED handler uses the helper
    - Build passes with zero errors
  </done>
</task>

</tasks>

<verification>
1. Build EIDConfigurationWizard project - must succeed with zero errors
2. Verify helper functions are static file-local (not exported)
3. Verify window procedure logic is preserved (same behavior, clearer code)
</verification>

<success_criteria>
- Two helper functions extracted (HandleRefreshRequest, HandleCredentialSelectionChange)
- WndProc_04CHECKS cognitive complexity reduced
- Build passes with zero errors
- All wizard navigation behavior preserved
</success_criteria>

<output>
After completion, create `.planning/phases/25-code-refactoring-complexity/25-02-SUMMARY.md`
</output>
