---
phase: 36-complexity-reduction
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - EIDCardLibrary/StoredCredentialManagement.cpp
  - EIDCardLibrary/StoredCredentialManagement.h
  - EIDCardLibrary/CertificateValidation.cpp
  - EIDCardLibrary/CertificateValidation.h
  - docs/COMPLEXITY_WONTFIX.md
autonomous: true
requirements:
  - STRUCT-01
  - STRUCT-02
must_haves:
  truths:
    - "High cognitive complexity functions have helper functions extracted"
    - "SEH-protected code blocks documented as won't-fix"
    - "Helper functions maintain SEH safety"
    - "Build passes with zero errors"
  artifacts:
    - "EIDCardLibrary/StoredCredentialManagement.cpp"
    - "EIDCardLibrary/CertificateValidation.cpp"
    - "docs/COMPLEXITY_WONTFIX.md"
  key_links:
    - "CreateCredential -> EncryptWithCertificate helper"
    - "CreateCredential -> EncryptWithDPAPI helper"
    - "ValidateCertificateChain -> BuildCertificateChain helper"
---

<objective>
Reduce cognitive complexity in high-complexity functions by extracting helper functions, while documenting SEH-protected code as won't-fix.

**Purpose:** Improve code maintainability by breaking down complex functions into smaller, focused helpers. SEH blocks cannot be refactored due to LSASS safety requirements.

**Output:**
- Extracted helper functions in key files
- Documentation of won't-fix SEH blocks
- Build verification
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md

## Background

Per SonarQube analysis, ~30 functions have cognitive complexity that exceeds recommended thresholds. The primary complexity drivers are:

1. **StoredCredentialManagement.cpp** - CreateCredential function (~200 lines) with multiple encryption paths
2. **CertificateValidation.cpp** - Certificate chain validation with extensive error handling
3. **EIDAuthenticationPackage.cpp** - LSA authentication handling with SEH blocks
4. **Package.cpp** - Credential packing and buffer management

### SEH Constraint

**CRITICAL:** Functions using `__try`/`__except`/`__finally` blocks cannot have code extracted from within the SEH block. The `__try` block must contain all related code to ensure proper exception handling in LSASS context.

Files with SEH blocks (won't-fix for extraction):
- StoredCredentialManagement.cpp (60+ SEH blocks)
- EIDAuthenticationPackage.cpp (20+ SEH blocks)
- CContainer.cpp (6 SEH blocks)
- CContainerHolderFactory.cpp (2 SEH blocks)
- CompleteToken.cpp (6 SEH blocks)
- GPO.cpp (2 SEH blocks)

### Extraction Rules

1. **CAN extract:** Code BEFORE `__try` block (validation, setup)
2. **CAN extract:** Code AFTER `__finally` block (result processing)
3. **CANNOT extract:** Code INSIDE `__try` block
4. **CANNOT extract:** Code INSIDE `__except` or `__finally` handlers
</context>

<tasks>

<task type="auto">
<name>Task 1: Extract encryption helpers from CreateCredential</name>
<files>EIDCardLibrary/StoredCredentialManagement.cpp, EIDCardLibrary/StoredCredentialManagement.h</files>
<action>
Extract helper functions from `CStoredCredentialManager::CreateCredential` to reduce cognitive complexity. The function has two main encryption paths (certificate-based and DPAPI-based) that can be extracted.

Create the following helper functions in the anonymous namespace or as static functions:

1. `EncryptPasswordWithCertificate(PCCERT_CONTEXT pCertContext, PWSTR szPassword, USHORT usPasswordLen, PBYTE* ppEncryptedPassword, PUSHORT pusEncryptedPasswordSize, PBYTE* ppSymmetricKey, PUSHORT pusSymmetricKeySize, HCRYPTKEY* phSymmetricKey)`
   - Extracts lines 342-441 from CreateCredential
   - Handles RSA encryption path with symmetric key generation
   - Returns encrypted password, symmetric key, and key handle
   - Uses SEH internally (new __try block for this helper)

2. `EncryptPasswordWithDPAPI(PWSTR szPassword, USHORT usPasswordSize, PBYTE* ppEncryptedData, PUSHORT pusEncryptedSize)`
   - Extracts lines 447-492 from CreateCredential
   - Handles DPAPI encryption path
   - Returns encrypted data and size

3. `BuildSecretData(PEID_PRIVATE_DATA pSecret, PCCERT_CONTEXT pCertContext, PBYTE pEncryptedPassword, USHORT usEncryptedPasswordSize, PBYTE pSymmetricKey, USHORT usSymmetricKeySize, bool fEncryptPassword)`
   - Extracts the data layout and copying logic
   - Handles both certificate and DPAPI data layouts

4. `CalculateSecretSize(PCCERT_CONTEXT pCertContext, USHORT usEncryptedPasswordSize, USHORT usSymmetricKeySize, bool fEncryptPassword)`
   - Extracts size calculation logic
   - Returns total size needed for EID_PRIVATE_DATA buffer

Add declarations to StoredCredentialManagement.h for any functions that need to be accessible across translation units (internal linkage helpers stay in .cpp).

**IMPORTANT:** Do NOT extract code from inside existing `__try` blocks. The extraction points are:
- Before the main `__try` block (validation logic)
- Encryption operations can be wrapped in their own SEH in helper functions
- After the `__finally` block (none in this function)

**Do NOT:**
- Change the overall SEH structure of CreateCredential
- Use std::string, std::vector, or any heap-allocating STL containers
- Add exception handling (SEH only)
</action>
<verify>
Build command: `msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:EIDCardLibrary /v:minimal`
Expected: Build succeeds with 0 errors
Manual check: Verify CreateCredential function has reduced line count and extracted helpers are called
</verify>
<done>
- CreateCredential function reduced in complexity by calling extracted helpers
- Helper functions declared and implemented
- Build passes with zero errors
- No heap-allocating STL types used in helpers
</done>
</task>

<task type="auto">
<name>Task 2: Extract certificate validation helpers</name>
<files>EIDCardLibrary/CertificateValidation.cpp, EIDCardLibrary/CertificateValidation.h</files>
<action>
Extract helper functions from `ValidateCertificateChain` and related certificate validation functions to reduce cognitive complexity.

Create the following helper functions:

1. `InitializeChainParameters(ChainValidationParams* params, bool fRequireSmartCardLogon)`
   - Extracts chain parameter initialization logic
   - Sets up Enhanced Key Usage, chain para, and policy structures
   - Currently in InitChainValidationParams - extend if needed

2. `BuildCertificateChain(PCCERT_CONTEXT pCertContext, ChainValidationParams* params, PCCERT_CHAIN_CONTEXT* ppChainContext)`
   - Extracts CertGetCertificateChain call and error handling
   - Returns chain context on success

3. `VerifyChainPolicy(PCCERT_CHAIN_CONTEXT pChainContext, ChainValidationParams* params)`
   - Extracts CertVerifyCertificateChainPolicy call and error handling
   - Returns policy verification result

4. `CheckEKUUsage(PCCERT_CONTEXT pCertContext, bool fRequireSmartCardLogon)`
   - Extracts Enhanced Key Usage checking logic
   - Validates smart card logon OID if required

5. `LogChainValidationError(DWORD dwError, PCCERT_CHAIN_CONTEXT pChainContext)`
   - Extracts error logging logic with chain details
   - Centralizes error message formatting

**IMPORTANT:** CertificateValidation.cpp does NOT use SEH blocks (uses Result&lt;T&gt; pattern). Safe to refactor normally.

Add declarations to CertificateValidation.h for internal helper functions using internal linkage (anonymous namespace or static).
</action>
<verify>
Build command: `msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:EIDCardLibrary /v:minimal`
Expected: Build succeeds with 0 errors
Manual check: Verify ValidateCertificateChain has reduced line count and helper calls
</verify>
<done>
- ValidateCertificateChain and related functions reduced in complexity
- Helper functions implemented and called from main validation functions
- Build passes with zero errors
- No change to external API (functions still return same types)
</done>
</task>

<task type="auto">
<name>Task 3: Create SEH won't-fix documentation</name>
<files>docs/COMPLEXITY_WONTFIX.md</files>
<action>
Create documentation file explaining why certain complexity issues are marked as won't-fix due to SEH constraints.

Create `docs/COMPLEXITY_WONTFIX.md` with the following structure:

1. Header with date, phase, and requirement reference
2. SEH Constraint Rationale section explaining LSASS context
3. Won't-Fix Files and Functions section with tables:
   - StoredCredentialManagement.cpp (60+ SEH blocks)
   - EIDAuthenticationPackage.cpp (20+ SEH blocks)
   - CContainer.cpp (6 SEH blocks)
   - CContainerHolderFactory.cpp (2 SEH blocks)
   - CompleteToken.cpp (6 SEH blocks)
   - GPO.cpp (2 SEH blocks)
4. Allowed Extractions section listing what CAN be extracted
5. SonarQube Documentation section with won't-fix justification template
6. Related Documentation links

The document should explain:
- Why SEH blocks cannot be refactored (exception handling scope)
- What extractions ARE allowed (pre-SEH, post-SEH, new helpers with own SEH)
- How to document won't-fix in SonarQube

Create the docs directory if it does not exist.
</action>
<verify>
File exists check: `if exist docs\COMPLEXITY_WONTFIX.md echo OK`
Expected: File exists with won't-fix documentation
</verify>
<done>
- docs/COMPLEXITY_WONTFIX.md created
- All SEH-protected files documented
- Won't-fix justification template provided for SonarQube
</done>
</task>

<task type="auto">
<name>Task 4: Build verification</name>
<files>N/A (build verification only)</files>
<action>
Run full build verification to ensure all complexity reduction changes compile correctly.

Execute the following build commands:

1. Build EIDCardLibrary (most affected project):
   ```
   msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:EIDCardLibrary /v:minimal
   ```

2. Build all projects:
   ```
   msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:Build /v:minimal
   ```

3. Verify no new warnings introduced (compare warning count to baseline if available)

If build fails:
- Review error messages
- Fix compilation errors in modified files
- Re-run build

If new warnings appear:
- Evaluate if warnings are acceptable (may be expected from refactor)
- Document any new warnings in phase summary
</action>
<verify>
Build command: `msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:Build /v:minimal 2>&1 | findstr /C:"error " /C:"Build succeeded"`
Expected: "Build succeeded" with 0 errors
</verify>
<done>
- All 7 projects build with zero errors
- No unexpected new warnings
- Build output logged for verification
</done>
</task>

</tasks>

<verification>
## Overall Phase Verification

1. **Complexity reduction achieved:**
   - CreateCredential function has extracted helpers
   - Certificate validation functions have extracted helpers
   - Functions maintain same external behavior

2. **SEH safety maintained:**
   - No code extracted from inside existing `__try` blocks
   - New helper functions use SEH where needed
   - No heap-allocating STL types introduced

3. **Documentation complete:**
   - docs/COMPLEXITY_WONTFIX.md exists
   - All SEH-protected files documented
   - SonarQube justification template provided

4. **Build verification:**
   - All projects compile with zero errors
   - No unexpected warnings
</verification>

<success_criteria>
1. High cognitive complexity functions have helper functions extracted
2. SEH-protected code documented as won't-fix (cannot extract from __try blocks)
3. Helper functions maintain SEH safety (no heap allocation in LSASS context)
4. Build passes with zero errors after complexity reduction
</success_criteria>

<output>
After completion, create `.planning/phases/36-complexity-reduction/36-01-SUMMARY.md`
</output>
