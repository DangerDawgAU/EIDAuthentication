---
phase: 28-diagnostics-logging
plan: 04
type: execute
wave: 3
depends_on:
  - 28-02
  - 28-03
files_modified:
  - EIDAuthenticationPackage/EIDSecuritySupportProvider.cpp
autonomous: true
requirements:
  - DIAG-01
  - DIAG-02

must_haves:
  truths:
    - "Security support provider error messages include operation context"
    - "SSPI function error paths have adequate tracing for debugging"
  artifacts:
    - path: "EIDAuthenticationPackage/EIDSecuritySupportProvider.cpp"
      provides: "Enhanced SSPI error tracing"
      min_lines: 700
  key_links:
    - from: "SpAcquireCredentialsHandle"
      to: "EIDLogErrorWithContext"
      via: "error path enhancement"
      pattern: "EIDLogErrorWithContext"
---

<objective>
Enhance error messages in the security support provider (EIDSecuritySupportProvider.cpp) with operation context.

Purpose: The SSPI layer handles credential acquisition and authentication. Enhance error paths with context for easier debugging of SSPI-related issues.

Output: EIDSecuritySupportProvider.cpp with enhanced error tracing using EIDLogErrorWithContext.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-diagnostics-logging/28-RESEARCH.md
@.planning/phases/28-diagnostics-logging/28-01-PLAN.md
@EIDAuthenticationPackage/EIDSecuritySupportProvider.cpp
@EIDCardLibrary/Tracing.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance error messages in EIDSecuritySupportProvider.cpp</name>
  <files>EIDAuthenticationPackage/EIDSecuritySupportProvider.cpp</files>
  <action>
Enhance generic error traces with operation context using EIDLogErrorWithContext.

Based on grep results, enhance these error paths:

1. Line ~371: GetKeyArgument:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"GetKeyArgument not ok 0x%08x", Status);

// AFTER:
EIDLogErrorWithContext("GetKeyArgument", HRESULT_FROM_NT(Status), nullptr);
```

2. Line ~406: EIDAlloc:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"EIDAlloc is 0x%08x", Status);

// AFTER:
EIDLogErrorWithContext("EIDAlloc", HRESULT_FROM_NT(Status), nullptr);
```

3. Lines ~417, ~434, ~476, ~513: CopyFromClientBuffer:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"CopyFromClientBuffer is 0x%08x", Status);

// AFTER:
EIDLogErrorWithContext("CopyFromClientBuffer", HRESULT_FROM_NT(Status), nullptr);
```

4. Line ~490: CredUnmarshalCredential:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"CredUnmarshalCredential is 0x%08x UseUnicode=%d", GetLastError(), UseUnicode);

// AFTER:
EIDLogErrorWithContext("CredUnmarshalCredential", HRESULT_FROM_WIN32(GetLastError()), L"UseUnicode=%d", UseUnicode);
```

5. Lines ~680, ~686: AllocateClientBuffer/CopyToClientBuffer:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"AllocateClientBuffer status = 0x%08x",status);

// AFTER:
EIDLogErrorWithContext("AllocateClientBuffer", HRESULT_FROM_NT(status), nullptr);
```

6. Line ~694: SECPKG_CRED_ATTR_NAMES:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"SECPKG_CRED_ATTR_NAMES status = 0x%08x",status);

// AFTER:
EIDLogErrorWithContext("QueryContextAttributes", HRESULT_FROM_NT(status), L"attr=SECPKG_CRED_ATTR_NAMES");
```

CRITICAL: Never log sensitive credential data in traces.
</action>
  <verify>
cd C:/Users/user/Documents/EIDAuthentication && cmake --build build --config Release --target EIDAuthenticationPackage 2>&1 | head -50
grep -c "EIDLogErrorWithContext" EIDAuthenticationPackage/EIDSecuritySupportProvider.cpp
</verify>
  <done>
Key error paths in EIDSecuritySupportProvider.cpp use EIDLogErrorWithContext
Build passes without errors
No sensitive data logged
</done>
</task>

</tasks>

<verification>
1. Build EIDAuthenticationPackage project successfully
2. Error paths use EIDLogErrorWithContext instead of generic "0x%08x" traces
3. No sensitive data (credential data) logged
</verification>

<success_criteria>
- SSPI error paths have operation context for troubleshooting
- Build passes with no new warnings
</success_criteria>

<output>
After completion, create `.planning/phases/28-diagnostics-logging/28-04-SUMMARY.md`
</output>
