---
phase: 28-diagnostics-logging
plan: 02
type: execute
wave: 2
depends_on:
  - 28-01
files_modified:
  - EIDCredentialProvider/CEIDCredential.cpp
  - EIDCredentialProvider/CEIDProvider.cpp
autonomous: true
requirements:
  - DIAG-01
  - DIAG-02

must_haves:
  truths:
    - "Credential provider error messages include operation context for troubleshooting"
    - - "not SUCCEEDED" traces enhanced with operation name and relevant state
    - "Key credential provider code paths have entry/exit tracing for coverage"
  artifacts:
    - path: "EIDCredentialProvider/CEIDCredential.cpp"
      provides: "Enhanced error messages in credential serialization flow"
      min_lines: 700
    - path: "EIDCredentialProvider/CEIDProvider.cpp"
      provides: "Enhanced error messages in provider lifecycle methods"
      min_lines: 520
  key_links:
    - from: "CEIDCredential::GetSerialization"
      to: "EIDLogErrorWithContext"
      via: "error path enhancement"
      pattern: "EIDLogErrorWithContext"
---

<objective>
Enhance error messages in the credential provider (CEIDCredential.cpp, CEIDProvider.cpp) with operation context.

Purpose: Replace the 17+ "not SUCCEEDED hr=0x%08x" generic traces with contextual error messages that include the operation name and relevant state values. This directly addresses DIAG-01 for the most visible error paths in the login UI flow.

Output: CEIDCredential.cpp and CEIDProvider.cpp with enhanced error tracing using the new EIDLogErrorWithContext helper.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-diagnostics-logging/28-RESEARCH.md
@.planning/phases/28-diagnostics-logging/28-01-PLAN.md
@EIDCredentialProvider/CEIDCredential.cpp
@EIDCredentialProvider/CEIDProvider.cpp
@EIDCardLibrary/Tracing.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance error messages in CEIDCredential.cpp</name>
  <files>EIDCredentialProvider/CEIDCredential.cpp</files>
  <action>
Replace generic "not SUCCEEDED" traces with contextual error messages using EIDLogErrorWithContext.

CRITICAL: Read the file first to understand context around each trace. Replace traces at these locations (identified from grep):

1. Line ~136: "not SUCCEEDED" without hr - add context about what operation:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"not SUCCEEDED");

// AFTER:
EIDLogErrorWithContext("SetSelected", hr, L"m_dwIndex=%u", m_dwIndex);
```

2. Line ~216: In GetStringValue - add field context:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"not SUCCEEDED hr=0x%08x",hr);

// AFTER:
EIDLogErrorWithContext("GetStringValue", hr, L"field=%d", dwFieldId);
```

3. Line ~244: In GetBitmapValue - add field context:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"not SUCCEEDED hr=0x%08x",hr);

// AFTER:
EIDLogErrorWithContext("GetBitmapValue", hr, L"field=%d", dwFieldId);
```

4. Line ~270: In GetCheckboxValue - add field context:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"not SUCCEEDED hr=0x%08x",hr);

// AFTER:
EIDLogErrorWithContext("GetCheckboxValue", hr, L"field=%d", dwFieldId);
```

5. Line ~304: In GetComboBoxValueCount - add field context:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"not SUCCEEDED hr=0x%08x",hr);

// AFTER:
EIDLogErrorWithContext("GetComboBoxValueCount", hr, L"field=%d", dwFieldId);
```

6. Line ~333: In GetComboBoxValueAt - add field and index context:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"not SUCCEEDED hr=0x%08x",hr);

// AFTER:
EIDLogErrorWithContext("GetComboBoxValueAt", hr, L"field=%d, index=%u", dwFieldId, dwItem);
```

7. Line ~363: In SetCheckboxValue - add field context:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"not SUCCEEDED hr=0x%08x",hr);

// AFTER:
EIDLogErrorWithContext("SetCheckboxValue", hr, L"field=%d, checked=%d", dwFieldId, fChecked);
```

8. Line ~452: In SetComboBoxSelectedValue - add field context:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"not SUCCEEDED hr=0x%08x",hr);

// AFTER:
EIDLogErrorWithContext("SetComboBoxSelectedValue", hr, L"field=%d", dwFieldId);
```

9. Lines ~586, ~591, ~601, ~607, ~614, ~618: In GetSerialization - these are already partially contextual but can be improved:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"RetrieveNegotiateAuthPackage not SUCCEEDED hr=0x%08x",hr);

// AFTER:
EIDLogErrorWithContext("RetrieveNegotiateAuthPackage", hr, nullptr);
```

Apply the same pattern to EIDUnlockLogonPack, EIDUnlockLogonInit, ProtectIfNecessaryAndCopyPassword, GetComputerNameW traces.

CRITICAL: Do NOT log PIN, password, or any sensitive data in these traces.
</action>
  <verify>
cd C:/Users/user/Documents/EIDAuthentication && cmake --build build --config Release --target EIDCredentialProvider 2>&1 | head -50
grep -c "not SUCCEEDED" EIDCredentialProvider/CEIDCredential.cpp || echo "No 'not SUCCEEDED' remaining"
grep -c "EIDLogErrorWithContext" EIDCredentialProvider/CEIDCredential.cpp
</verify>
  <done>
All 17+ "not SUCCEEDED" traces in CEIDCredential.cpp replaced with EIDLogErrorWithContext
Each error trace includes operation name and relevant state context
Build passes without errors
</done>
</task>

<task type="auto">
  <name>Task 2: Enhance error messages in CEIDProvider.cpp</name>
  <files>EIDCredentialProvider/CEIDProvider.cpp</files>
  <action>
Replace generic "not SUCCEEDED" traces with contextual error messages using EIDLogErrorWithContext.

1. Line ~393: In some provider method - add context:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"not SUCCEEDED hr=0x%08x",hr);

// AFTER:
EIDLogErrorWithContext("CredentialListOperation", hr, nullptr);
```

2. Line ~488: In SetSerialization - add context:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"not SUCCEEDED hr=0x%08x",hr);

// AFTER:
EIDLogErrorWithContext("SetSerialization", hr, nullptr);
```

3. Line ~512: In another provider method - add context:
```cpp
// BEFORE:
EIDCardLibraryTrace(WINEVENT_LEVEL_WARNING,L"not SUCCEEDED hr=0x%08x",hr);

// AFTER:
EIDLogErrorWithContext("ProviderOperation", hr, nullptr);
```

CRITICAL: Read the file first to understand the actual method names and provide appropriate context for each trace.
</action>
  <verify>
cd C:/Users/user/Documents/EIDAuthentication && cmake --build build --config Release --target EIDCredentialProvider 2>&1 | head -50
grep -c "not SUCCEEDED" EIDCredentialProvider/CEIDProvider.cpp || echo "No 'not SUCCEEDED' remaining"
grep -c "EIDLogErrorWithContext" EIDCredentialProvider/CEIDProvider.cpp
</verify>
  <done>
All "not SUCCEEDED" traces in CEIDProvider.cpp replaced with EIDLogErrorWithContext
Each error trace includes operation name and relevant state context
Build passes without errors
</done>
</task>

</tasks>

<verification>
1. Build EIDCredentialProvider project successfully
2. Count of "not SUCCEEDED" traces in CEIDCredential.cpp reduced from 17+ to 0
3. Count of "not SUCCEEDED" traces in CEIDProvider.cpp reduced from 3 to 0
4. All enhanced traces use EIDLogErrorWithContext with operation context
5. No sensitive data (PIN, password) logged in any trace
</verification>

<success_criteria>
- All generic "not SUCCEEDED" traces in credential provider replaced with contextual errors
- Error messages include operation name, error code, and relevant state
- Build passes with no new warnings
</success_criteria>

<output>
After completion, create `.planning/phases/28-diagnostics-logging/28-02-SUMMARY.md`
</output>
