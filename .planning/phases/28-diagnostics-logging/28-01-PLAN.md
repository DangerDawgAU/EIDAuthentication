---
phase: 28-diagnostics-logging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - EIDCardLibrary/Tracing.h
  - EIDCardLibrary/Tracing.cpp
autonomous: true
requirements:
  - DIAG-01
  - DIAG-03

must_haves:
  truths:
    - "Error messages include operation name and error code for troubleshooting"
    - "Stack trace capture available for critical error paths in LSASS context"
    - "Structured logging prefixes enable filtering in security monitoring tools"
  artifacts:
    - path: "EIDCardLibrary/Tracing.h"
      provides: "Enhanced error logging helper function and stack trace utility"
      contains: "EIDLogErrorWithContext"
    - path: "EIDCardLibrary/Tracing.cpp"
      provides: "Implementation of enhanced error logging with stack trace support"
      min_lines: 460
  key_links:
    - from: "EIDCardLibrary/Tracing.cpp"
      to: "CaptureStackBackTrace Win32 API"
      via: "dbghelp.h include and dbghelp.lib linkage"
      pattern: "CaptureStackBackTrace"
---

<objective>
Add diagnostic helper functions for enhanced error messages and LSASS-safe stack trace capture.

Purpose: Provide reusable infrastructure for DIAG-01 (enhanced error messages) and DIAG-03 (structured logging) that can be called from error paths throughout the codebase. This plan creates the foundation; subsequent plans use these helpers.

Output: Enhanced Tracing.h/cpp with EIDLogErrorWithContext helper and optional stack trace capture.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-diagnostics-logging/28-RESEARCH.md
@EIDCardLibrary/Tracing.h
@EIDCardLibrary/Tracing.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add EIDLogErrorWithContext helper function to Tracing.h</name>
  <files>EIDCardLibrary/Tracing.h</files>
  <action>
Add a new helper function declaration and macro for enhanced error logging with context:

1. Add function declaration after the existing EIDSecurityAudit macro (around line 80):
```cpp
// Enhanced error logging with operation context
// Provides structured error messages for easier debugging
// Format: "[ERROR_TYPE] Operation 'name' failed: hr=0x%08X, context_info
#define EIDLogErrorWithContext(operation, hr, ...) \
    EIDLogErrorWithContextEx(__FILE__, __LINE__, __FUNCTION__, operation, hr, __VA_ARGS__)

void EIDLogErrorWithContextEx(
    PCSTR szFile,
    DWORD dwLine,
    PCSTR szFunction,
    const char* operation,
    HRESULT hr,
    PCWSTR szAdditionalContext,
    ...);
```

2. Add stack trace capture function declaration:
```cpp
// LSASS-safe stack trace capture for error diagnostics
// Uses CaptureStackBackTrace (not std::stacktrace - Phase 27 finding)
// Stack-allocated buffers only - no dynamic memory
#define EIDLogStackTrace(errorCode) \
    EIDLogStackTraceEx(__FILE__, __LINE__, __FUNCTION__, errorCode)

void EIDLogStackTraceEx(
    PCSTR szFile,
    DWORD dwLine,
    PCSTR szFunction,
    DWORD errorCode);
```

CRITICAL CONSTRAINTS (from PROJECT.md/STATE.md):
- No dynamic memory allocation (std::string, new, malloc)
- noexcept functions only in LSASS context
- Stack-allocated buffers only
- No sensitive data logging (PIN, password, key)
</action>
  <verify>
grep -n "EIDLogErrorWithContext" EIDCardLibrary/Tracing.h
grep -n "EIDLogStackTraceEx" EIDCardLibrary/Tracing.h
</verify>
  <done>
EIDLogErrorWithContext macro and EIDLogErrorWithContextEx function declared in Tracing.h
EIDLogStackTrace macro and EIDLogStackTraceEx function declared in Tracing.h
</done>
</task>

<task type="auto">
  <name>Task 2: Implement EIDLogErrorWithContext and EIDLogStackTrace in Tracing.cpp</name>
  <files>EIDCardLibrary/Tracing.cpp</files>
  <action>
Add implementation of the enhanced error logging functions after EIDSecurityAuditEx (around line 457):

1. Implement EIDLogErrorWithContextEx:
```cpp
// Enhanced error logging with structured context
// Format: [ERROR_CONTEXT] Function:line - Operation 'name' failed: hr=0x%08X, additional_context
void EIDLogErrorWithContextEx(
    PCSTR szFile,
    DWORD dwLine,
    PCSTR szFunction,
    const char* operation,
    HRESULT hr,
    PCWSTR szAdditionalContext,
    ...)
{
    UNREFERENCED_PARAMETER(szFile);

    WCHAR ContextBuffer[256] = {0};
    WCHAR FinalBuffer[512] = {0};
    int ret;

    if (bFirst)
    {
        EIDCardLibraryTracingRegister();
    }

    // Format additional context if provided
    if (szAdditionalContext != nullptr)
    {
        va_list ap;
        va_start(ap, szAdditionalContext);
        ret = _vsnwprintf_s(ContextBuffer, ARRAYSIZE(ContextBuffer), _TRUNCATE, szAdditionalContext, ap);
        va_end(ap);
        if (ret < 0)
        {
            wcscpy_s(ContextBuffer, L"(context formatting error)");
        }
    }

    // Format final message with structured prefix
    if (szAdditionalContext != nullptr && ContextBuffer[0] != L'\0')
    {
        swprintf_s(FinalBuffer, ARRAYSIZE(FinalBuffer),
            L"[ERROR_CONTEXT] %S:%d - Operation '%S' failed: hr=0x%08X, %s",
            szFunction, dwLine, operation, hr, ContextBuffer);
    }
    else
    {
        swprintf_s(FinalBuffer, ARRAYSIZE(FinalBuffer),
            L"[ERROR_CONTEXT] %S:%d - Operation '%S' failed: hr=0x%08X",
            szFunction, dwLine, operation, hr);
    }

#ifdef _DEBUG
    OutputDebugString(FinalBuffer);
    OutputDebugString(L"\r\n");
#endif

    EventWriteString(hPub, WINEVENT_LEVEL_ERROR, 0, FinalBuffer);
}
```

2. Implement EIDLogStackTraceEx using CaptureStackBackTrace (Phase 27 recommendation):
```cpp
// LSASS-safe stack trace capture for error diagnostics
// Uses CaptureStackBackTrace - reliable in LSASS context (Phase 27 finding)
// Stack-allocated buffer only - no dynamic memory allocation
void EIDLogStackTraceEx(
    PCSTR szFile,
    DWORD dwLine,
    PCSTR szFunction,
    DWORD errorCode)
{
    UNREFERENCED_PARAMETER(szFile);

    // Stack-allocated buffer - LSASS safe
    constexpr USHORT MAX_STACK_FRAMES = 16;
    PVOID stack[MAX_STACK_FRAMES];

    if (bFirst)
    {
        EIDCardLibraryTracingRegister();
    }

    // Log error context at ERROR level
    WCHAR ErrorBuffer[256];
    swprintf_s(ErrorBuffer, ARRAYSIZE(ErrorBuffer),
        L"[STACK_TRACE] %S:%d - Error code 0x%08X, call stack follows:",
        szFunction, dwLine, errorCode);

#ifdef _DEBUG
    OutputDebugString(ErrorBuffer);
    OutputDebugString(L"\r\n");
#endif
    EventWriteString(hPub, WINEVENT_LEVEL_ERROR, 0, ErrorBuffer);

    // Capture stack back trace
    USHORT frames = CaptureStackBackTrace(
        2,  // Skip this function and immediate caller
        MAX_STACK_FRAMES,
        stack,
        nullptr
    );

    // Log each frame at VERBOSE level (only visible when tracing enabled)
    for (USHORT i = 0; i < frames; ++i)
    {
        WCHAR FrameBuffer[128];
        swprintf_s(FrameBuffer, ARRAYSIZE(FrameBuffer),
            L"[STACK_TRACE]   frame[%u] = 0x%p", i, stack[i]);

#ifdef _DEBUG
        OutputDebugString(FrameBuffer);
        OutputDebugString(L"\r\n");
#endif
        EventWriteString(hPub, WINEVENT_LEVEL_VERBOSE, 0, FrameBuffer);
    }
}
```

CRITICAL: Verify dbghelp.h is already included (line 31) and dbghelp.lib linked (line 40) in existing code.
</action>
  <verify>
cd C:/Users/user/Documents/EIDAuthentication && cmake --build build --config Release --target EIDCardLibrary 2>&1 | head -50
grep -n "EIDLogErrorWithContextEx" EIDCardLibrary/Tracing.cpp
grep -n "EIDLogStackTraceEx" EIDCardLibrary/Tracing.cpp
grep -n "CaptureStackBackTrace" EIDCardLibrary/Tracing.cpp
</verify>
  <done>
EIDLogErrorWithContextEx implemented with structured [ERROR_CONTEXT] prefix
EIDLogStackTraceEx implemented using CaptureStackBackTrace with stack-allocated buffer
Both functions compile without errors
No dynamic memory allocation used (LSASS-safe)
</done>
</task>

</tasks>

<verification>
1. Build EIDCardLibrary project successfully
2. Verify EIDLogErrorWithContext macro and EIDLogErrorWithContextEx function exist in Tracing.h
3. Verify EIDLogStackTrace macro and EIDLogStackTraceEx function exist in Tracing.h
4. Verify implementations use stack-allocated buffers only (no std::string, new, malloc)
5. Verify CaptureStackBackTrace is used (not std::stacktrace)
</verification>

<success_criteria>
- EIDLogErrorWithContext helper provides structured error logging with operation context
- EIDLogStackTrace provides LSASS-safe stack trace capture using CaptureStackBackTrace
- All new functions are noexcept and use stack-allocated buffers only
- Build passes with no new warnings
</success_criteria>

<output>
After completion, create `.planning/phases/28-diagnostics-logging/28-01-SUMMARY.md`
</output>
