---
phase: 24-sonarqube-nesting-issues
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - EIDConfigurationWizard/EIDConfigurationWizardPage03.cpp
autonomous: true
requirements:
  - SONAR-04
user_setup: []

must_haves:
  truths:
    - "WndProc_03NEW function has reduced nesting depth in PSN_WIZNEXT handler"
    - "Option handlers extracted as file-local static functions"
    - "Build passes with zero errors"
  artifacts:
    - path: "EIDConfigurationWizard/EIDConfigurationWizardPage03.cpp"
      provides: "Wizard page 3 message handling with extracted helpers"
      contains: "static.*Handle.*Option"
  key_links:
    - from: "WndProc_03NEW"
      to: "HandleDeleteOption, HandleCreateOption, HandleUseThisOption, HandleImportOption"
      via: "function call"
      pattern: "Handle.*Option.*hWnd"
---

<objective>
Extract deeply nested option handlers from WndProc_03NEW function in EIDConfigurationWizardPage03.cpp to reduce nesting depth and improve readability.

Purpose: Reduce SonarQube nesting depth issues (~15 issues) in the configuration wizard page 3 by extracting option handlers into separate static functions.

Output: Refactored EIDConfigurationWizardPage03.cpp with reduced nesting in WndProc_03NEW.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-sonarqube-nesting-issues/24-RESEARCH.md

@EIDConfigurationWizard/EIDConfigurationWizardPage03.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract option handlers from WndProc_03NEW PSN_WIZNEXT handler</name>
  <files>EIDConfigurationWizard/EIDConfigurationWizardPage03.cpp</files>
  <action>
Extract four option handlers from the deeply nested PSN_WIZNEXT case in WndProc_03NEW:

1. Create `HandleDeleteOption(HWND hWnd)` - handles IDC_03DELETE checkbox logic
   - Takes hWnd parameter
   - Calls ClearCard and handles error display
   - Returns TRUE if navigation should be blocked, FALSE otherwise

2. Create `HandleCreateOption(HWND hWnd, PCCERT_CONTEXT pRootCert)` - handles IDC_03_CREATE checkbox logic
   - Takes hWnd and pRootCertificate pointer
   - Gets validity years, creates root cert, creates smart card cert
   - Returns TRUE if navigation should be blocked, FALSE otherwise

3. Create `HandleUseThisOption(HWND hWnd, PCCERT_CONTEXT pRootCert)` - handles IDC_03USETHIS checkbox logic
   - Takes hWnd and pRootCertificate pointer
   - Gets validity years, creates smart card cert
   - Returns TRUE if navigation should be blocked, FALSE otherwise

4. Create `HandleImportOption(HWND hWnd)` - handles IDC_03IMPORT checkbox logic
   - Takes hWnd parameter
   - Gets filename and password, calls ImportFileToSmartCard
   - Returns TRUE if navigation should be blocked, FALSE otherwise

Guidelines:
- Add forward declarations near top of file (after includes)
- Mark functions as `static` for file-local scope
- Use early return pattern within handlers
- Preserve exact error handling behavior (MessageBoxWin32Ex, SetWindowLongPtr)
- Keep pRootCertificate as global access within handlers (do not pass by reference)
- Get validity years inside each handler that needs it (consolidate the UI read)
  </action>
  <verify>
1. Build the EIDConfigurationWizard project: `msbuild EIDConfigurationWizard.vcxproj /p:Configuration=Release /p:Platform=x64`
2. Verify no new compiler warnings introduced
3. Verify the four new static functions exist and are called from WndProc_03NEW
  </verify>
  <done>
WndProc_03NEW PSN_WIZNEXT handler has reduced nesting (3 levels instead of 5+). Four static helper functions (HandleDeleteOption, HandleCreateOption, HandleUseThisOption, HandleImportOption) are added and called. Build passes with no errors.
</done>
</task>

<task type="auto">
  <name>Task 2: Apply early return pattern to PSN_WIZNEXT handler</name>
  <files>EIDConfigurationWizard/EIDConfigurationWizardPage03.cpp</files>
  <action>
Refactor the PSN_WIZNEXT case to use early return pattern after extracting handlers:

Before (current structure):
```cpp
case PSN_WIZNEXT:
    if (IsDlgButtonChecked(hWnd, IDC_03DELETE)) {
        // nested handler code
    }
    if (IsDlgButtonChecked(hWnd, IDC_03_CREATE)) {
        // nested handler code
    }
    else if (IsDlgButtonChecked(hWnd, IDC_03USETHIS)) {
        // nested handler code
    }
    else if (IsDlgButtonChecked(hWnd, IDC_03IMPORT)) {
        // nested handler code
    }
    break;
```

After (target structure):
```cpp
case PSN_WIZNEXT:
    if (IsDlgButtonChecked(hWnd, IDC_03DELETE) && HandleDeleteOption(hWnd))
        return TRUE;
    if (IsDlgButtonChecked(hWnd, IDC_03_CREATE) && HandleCreateOption(hWnd, pRootCertificate))
        return TRUE;
    if (IsDlgButtonChecked(hWnd, IDC_03USETHIS) && HandleUseThisOption(hWnd, pRootCertificate))
        return TRUE;
    if (IsDlgButtonChecked(hWnd, IDC_03IMPORT) && HandleImportOption(hWnd))
        return TRUE;
    break;
```

Key changes:
- Each handler returns TRUE if navigation should be blocked (error case)
- Use short-circuit && to call handler only when checkbox is checked
- Early return TRUE prevents further processing
- No deep else-if chains needed
  </action>
  <verify>
1. Build passes: `msbuild EIDConfigurationWizard.vcxproj /p:Configuration=Release /p:Platform=x64`
2. Manual inspection: PSN_WIZNEXT case has linear structure with no deep nesting
3. Each handler call is on single line with conditional check
  </verify>
  <done>
PSN_WIZNEXT handler is refactored to use guard-style pattern. Nesting depth reduced from 5+ to 2 levels. Handler logic is delegated to extracted functions. Build passes.
</done>
</task>

</tasks>

<verification>
1. Build EIDConfigurationWizard project successfully
2. Verify four new static helper functions exist
3. Verify WndProc_03NEW PSN_WIZNEXT case has reduced nesting
4. No new compiler warnings
</verification>

<success_criteria>
- WndProc_03NEW function has nesting depth at or below 3 levels in PSN_WIZNEXT handler
- Four option handler functions extracted (HandleDeleteOption, HandleCreateOption, HandleUseThisOption, HandleImportOption)
- Build passes with zero errors
- Functionality preserved (same error handling behavior)
</success_criteria>

<output>
After completion, create `.planning/phases/24-sonarqube-nesting-issues/24-01-SUMMARY.md`
</output>
