---
phase: 23-sonarqube-const-issues
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
requirements: [SONAR-03]

must_haves:
  truths:
    - "All remaining global variable const issues are documented with won't-fix justifications"
    - "No global variables that should be const are left undocumented"
    - "Build passes with zero errors after any const changes"
  artifacts:
    - path: ".planning/phases/23-sonarqube-const-issues/23-01-SUMMARY.md"
      provides: "Complete documentation of won't-fix global variable categories"
      min_lines: 50
  key_links:
    - from: "RESEARCH.md"
      to: "23-01-SUMMARY.md"
      via: "Won't-fix categories"
      pattern: "Won.t-Fix.*Categories"
---

<objective>
Verify all remaining global variable const issues are legitimately mutable, document won't-fix categories with justifications, and confirm build passes.

Purpose: Complete SONAR-03 by establishing that remaining ~63 global variable const issues cannot be fixed without breaking functionality.
Output: Documented won't-fix categories for Phase 30 Final SonarQube Scan.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-sonarqube-const-issues/23-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify remaining global variables are legitimately mutable</name>
  <files></files>
  <action>
Search for all global variable declarations in the codebase and verify each remaining SonarQube-flagged global falls into one of these won't-fix categories:

**Won't-Fix Category 1: LSA Function Pointers (Package.cpp)**
- `MyAllocateHeap`, `MyFreeHeap`, `MyImpersonate` - Set at runtime by LSA during package initialization
- These MUST remain mutable as they are assigned during LSA initialization

**Won't-Fix Category 2: Tracing State (Tracing.cpp, TraceExport.cpp)**
- `bFirst`, `g_csTraceInitialized`, `IsTracingEnabled`, `g_hTraceOutputFile` - Modified at runtime
- Tracing state is enabled/disabled dynamically and file handles are opened during operation

**Won't-Fix Category 3: DLL State (Dll.cpp)**
- `g_cRef`, `g_hinst` - Standard COM DLL lifecycle state
- Reference count modified by AddRef/Release, hInstance set by DllMain

**Won't-Fix Category 4: UI State (EIDConfigurationWizard*.cpp)**
- `dwCurrentCredential`, `fHasDeselected`, `fGotoNewScreen`, `dwWizardError`, `pRootCertificate` - Modified during wizard operation
- These track user selections and navigation state

**Won't-Fix Category 5: Handle Variables (Various files)**
- `hFile`, `hInternalLogWriteHandle` - Set/opened during operation
- File handles are opened when needed and cannot be const

**Won't-Fix Category 6: Windows API Buffers (CertificateUtilities.cpp, CertificateValidation.cpp, DebugReport.cpp)**
- `s_szOidClientAuth[]`, `s_szOidServerAuth[]`, `s_szOidSmartCardLogon[]`, etc.
- CERT_ENHKEY_USAGE.rgpszUsageIdentifier is LPSTR* (non-const char**)
- With /Zc:strictStrings, string literals are const and cannot convert to LPSTR
- These MUST be writable arrays for Windows CryptoAPI

**Already Fixed (no action needed):**
- `TraceAllocation` in Package.cpp - already `const BOOL`
- `dwReaderSize`, `dwCardSize`, `dwUserNameSize`, `dwPasswordSize` in EIDConfigurationWizard.cpp - already `const DWORD`

Verify by:
1. Grep for global variable patterns: `^(static\s+)?(DWORD|BOOL|HANDLE|HINSTANCE|LONG|UINT|wchar_t|char|P\w+)\s+\w+\s*=`
2. For each found global, confirm it matches a won't-fix category above
3. Search for any globals that might NOT match a won't-fix category - these would be actual conversion candidates
</action>
  <verify>
Grep results confirm all found globals match won't-fix categories OR identify 1-2 actual conversion candidates that can be safely marked const.
</verify>
  <done>
All remaining global variables confirmed as legitimately mutable with won't-fix justifications, OR specific conversion candidates identified with file/line locations.
</done>
</task>

<task type="auto">
  <name>Task 2: Build verification</name>
  <files></files>
  <action>
Build the entire solution to confirm no code changes are needed (or verify any changes compile correctly).

```bash
MSBuild.exe EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:Rebuild /m
```

Expected outcome: 0 errors, existing warnings only (64 warnings from Windows SDK ntstatus.h macro redefinitions are pre-existing and expected).

If any global was converted to const in Task 1, verify:
- The build succeeds
- No new warnings introduced
- The const global is truly initialized with a constant expression at declaration
</action>
  <verify>
Build completes with 0 errors. Any code changes compile successfully.
</verify>
  <done>
Full solution build passes with zero errors, confirming no breaking changes from const conversions (if any).
</done>
</task>

<task type="auto">
  <name>Task 3: Document won't-fix categories for SonarQube resolution</name>
  <files>.planning/phases/23-sonarqube-const-issues/23-01-SUMMARY.md</files>
  <action>
Create the phase summary documenting all won't-fix global variable categories with justifications for Phase 30 Final SonarQube Scan.

The summary must include:

**Won't-Fix Categories:**

1. **LSA Function Pointers** (3 globals in Package.cpp)
   - `MyAllocateHeap`, `MyFreeHeap`, `MyImpersonate`
   - Justification: Assigned at runtime during LSA package initialization via SetAlloc(), SetFree(), SetImpersonate()

2. **Tracing State** (4 globals in Tracing.cpp, TraceExport.cpp)
   - `bFirst`, `g_csTraceInitialized`, `IsTracingEnabled`, `g_hTraceOutputFile`
   - Justification: Modified at runtime by EnableCallback() and during tracing operations

3. **DLL State** (2 globals in Dll.cpp)
   - `g_cRef`, `g_hinst`
   - Justification: Standard COM DLL lifecycle - reference counting and instance handle

4. **UI State** (5+ globals in EIDConfigurationWizard*.cpp)
   - `dwCurrentCredential`, `fHasDeselected`, `fGotoNewScreen`, `dwWizardError`, `pRootCertificate`
   - Justification: Modified during wizard operation for user selections and navigation

5. **Handle Variables** (2+ globals in EIDLogManager.cpp, DebugReport.cpp)
   - `hFile`, `hInternalLogWriteHandle`
   - Justification: Set/opened during file operations

6. **Windows API Buffers** (10+ globals in CertificateUtilities.cpp, CertificateValidation.cpp)
   - `s_szOidClientAuth[]`, `s_szOidServerAuth[]`, etc.
   - Justification: CryptoAPI requires non-const LPSTR* for CERT_ENHKEY_USAGE.rgpszUsageIdentifier

**Already Fixed (Phase 16/22):**
- `TraceAllocation` - already `const BOOL`
- `dwReaderSize`, `dwCardSize`, `dwUserNameSize`, `dwPasswordSize` - already `const DWORD`

**Total Won't Fix: ~63 global variable const issues**

All remaining issues are legitimately mutable state required for program operation.
</action>
  <verify>
Summary file exists with complete won't-fix category documentation.
</verify>
  <done>
23-01-SUMMARY.md created with complete won't-fix documentation for Phase 30 SonarQube resolution.
</done>
</task>

</tasks>

<verification>
1. All global variables verified as legitimately mutable OR actual conversion candidates identified
2. Build passes with 0 errors
3. Won't-fix categories documented with specific justification for each category
4. Summary file created for Phase 30 reference
</verification>

<success_criteria>
- All remaining global variable const issues documented as won't-fix with justification
- Build passes with no new warnings
- Phase 30 has clear reference for SonarQube issue resolution
</success_criteria>

<output>
After completion, create `.planning/phases/23-sonarqube-const-issues/23-01-SUMMARY.md`
</output>
