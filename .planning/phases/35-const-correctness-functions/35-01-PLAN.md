---
phase: 35-const-correctness-functions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - EIDCardLibrary/CContainer.h
  - EIDCardLibrary/CContainer.cpp
  - EIDCardLibrary/CContainerHolderFactory.h
  - EIDCardLibrary/CContainerHolderFactory.cpp
  - EIDConfigurationWizard/CContainerHolder.h
  - EIDConfigurationWizard/CContainerHolder.cpp
  - EIDCredentialProvider/CEIDCredential.h
  - EIDCredentialProvider/CEIDCredential.cpp
  - EIDCredentialProvider/CMessageCredential.h
  - EIDCredentialProvider/CMessageCredential.cpp
autonomous: true
requirements:
  - CONST-03
  - CONST-04
user_setup: []

must_haves:
  truths:
    - "Member functions that don't modify object state are marked const"
    - "COM interface methods remain unchanged (won't-fix per CONST-04)"
    - "Windows callback methods remain unchanged (won't-fix per CONST-04)"
    - "Build passes with zero errors after const additions"
  artifacts:
    - path: "EIDCardLibrary/CContainer.h"
      provides: "CContainer class declaration with const methods"
      contains: "const"
    - path: "EIDCardLibrary/CContainer.cpp"
      provides: "CContainer implementation with const methods"
    - path: "EIDCardLibrary/CContainerHolderFactory.h"
      provides: "CContainerHolderFactory template with const methods"
      contains: "const"
    - path: "EIDConfigurationWizard/CContainerHolder.h"
      provides: "CContainerHolderTest class with const methods"
      contains: "const"
    - path: "EIDCredentialProvider/CEIDCredential.h"
      provides: "CEIDCredential class with const GetContainer method"
      contains: "GetContainer() const"
    - path: "EIDCredentialProvider/CMessageCredential.h"
      provides: "CMessageCredential class with const GetStatus method"
      contains: "GetStatus() const"
  key_links:
    - from: "CContainer methods"
      to: "internal member variables"
      via: "const method signature"
      pattern: "\\)\\s*const"
---

<objective>
Mark member functions const where they don't modify object state, improving API clarity and enabling compiler optimizations.

Purpose: Const-correct member functions document intent and prevent accidental state modification.
Output: Updated class headers and implementations with const on appropriate methods.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Relevant source files already analyzed
@EIDCardLibrary/CContainer.h
@EIDCardLibrary/CContainer.cpp
@EIDCardLibrary/CContainerHolderFactory.h
@EIDCardLibrary/CContainerHolderFactory.cpp
@EIDConfigurationWizard/CContainerHolder.h
@EIDConfigurationWizard/CContainerHolder.cpp
@EIDCredentialProvider/CEIDCredential.h
@EIDCredentialProvider/CEIDCredential.cpp
@EIDCredentialProvider/CMessageCredential.h
@EIDCredentialProvider/CMessageCredential.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Mark CContainer member functions const</name>
  <files>EIDCardLibrary/CContainer.h, EIDCardLibrary/CContainer.cpp</files>
  <action>
    Analyze and mark the following CContainer methods as const:

    Already const (no changes needed):
    - GetProviderName() const - already const
    - GetContainerName() const - already const
    - GetKeySpec() const - already const
    - GetCertificate() const - already const
    - IsOnReader() const - already const
    - GetCSPInfo() const - already const
    - FreeCSPInfo() const - already const
    - Erase() const - already const
    - ViewCertificate() const - already const
    - TriggerRemovePolicy() const - already const

    Candidate for const (but cannot be const - has side effects):
    - GetUserName() - CANNOT be const (lazy-loads _szUserName member, modifies state)
    - GetRid() - CANNOT be const (lazy-loads _dwRid member, modifies state)
    - AllocateLogonStruct() - CANNOT be const (allocates memory, uses GetRid which modifies state)

    No changes required for CContainer - all appropriate methods are already const.
    Document this finding for the phase summary.
  </action>
  <verify>
    grep -c "const" EIDCardLibrary/CContainer.h should show 11+ occurrences (existing const methods)
    Build: msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:EIDCardLibrary
  </verify>
  <done>CContainer analysis complete - all appropriate methods already marked const, GetUserName/GetRid/AllocateLogonStruct correctly non-const due to lazy initialization</done>
</task>

<task type="auto">
  <name>Task 2: Mark CContainerHolderFactory methods const</name>
  <files>EIDCardLibrary/CContainerHolderFactory.h, EIDCardLibrary/CContainerHolderFactory.cpp</files>
  <action>
    Analyze CContainerHolderFactory template methods for const eligibility:

    Candidate for const (read-only operations that don't modify _CredentialList or other members):
    - HasContainerHolder() - CAN be const (only reads _CredentialList.size())
    - ContainerHolderCount() - CAN be const (only reads _CredentialList.size())

    Methods that CANNOT be const:
    - Lock() - modifies CriticalSection state
    - Unlock() - modifies CriticalSection state
    - SetUsageScenario() - modifies _cpus and _dwFlags
    - ConnectNotification() - calls methods that modify _CredentialList
    - DisconnectNotification() - modifies _CredentialList
    - CreateContainer() - modifies _CredentialList
    - CreateItemFromCertificateBlob() - calls CreateContainer
    - GetContainerHolderAt() - uses Lock/Unlock pattern internally

    Changes to make:
    1. In CContainerHolderFactory.h, change:
       - `BOOL HasContainerHolder();` to `BOOL HasContainerHolder() const;`
       - `DWORD ContainerHolderCount();` to `DWORD ContainerHolderCount() const;`

    2. In CContainerHolderFactory.cpp, change:
       - `BOOL CContainerHolderFactory<T>::HasContainerHolder()` to `BOOL CContainerHolderFactory<T>::HasContainerHolder() const`
       - `DWORD CContainerHolderFactory<T>::ContainerHolderCount()` to `DWORD CContainerHolderFactory<T>::ContainerHolderCount() const`

    Note: These methods use Lock()/Unlock() internally which modify CriticalSection, but this is acceptable
    for const methods as CriticalSection is mutable synchronization state (similar to mutable mutex in C++).
  </action>
  <verify>
    grep "HasContainerHolder() const" EIDCardLibrary/CContainerHolderFactory.h
    grep "ContainerHolderCount() const" EIDCardLibrary/CContainerHolderFactory.h
    Build: msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:EIDCardLibrary
  </verify>
  <done>HasContainerHolder() and ContainerHolderCount() marked const in header and implementation</done>
</task>

<task type="auto">
  <name>Task 3: Mark CContainerHolderTest methods const</name>
  <files>EIDConfigurationWizard/CContainerHolder.h, EIDConfigurationWizard/CContainerHolder.cpp</files>
  <action>
    Analyze CContainerHolderTest methods for const eligibility:

    Already const (no changes needed):
    - GetContainer() const - already const
    - GetIconIndex() const - already const
    - HasSignatureUsageOnly() const - already const
    - SupportEncryption() const - already const
    - GetCheckCount() const - already const
    - GetImage() const - already const
    - GetDescription() const - already const
    - GetSolveDescription() const - already const

    Methods that CANNOT be const:
    - IsTrusted() - sets _dwTrustError member (documented in header as "Not const - has side effect")
    - Solve() - modifies system state via registry
    - SetUsageScenario() - modifies _cpus/_dwFlags (though currently does nothing)
    - Release() - deletes the object

    No changes required for CContainerHolderTest - all appropriate methods already marked const.
    Document this finding for the phase summary.
  </action>
  <verify>
    grep -c "const" EIDConfigurationWizard/CContainerHolder.h should show 9+ occurrences (existing const methods)
    Build: msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:EIDConfigurationWizard
  </verify>
  <done>CContainerHolderTest analysis complete - all appropriate methods already marked const, IsTrusted correctly non-const due to side effect</done>
</task>

<task type="auto">
  <name>Task 4: Mark CMessageCredential::GetStatus const</name>
  <files>EIDCredentialProvider/CMessageCredential.h, EIDCredentialProvider/CMessageCredential.cpp</files>
  <action>
    Analyze CMessageCredential::GetStatus for const eligibility:

    Current signature in header:
    ```cpp
    DWORD GetStatus()
    {
        return _dwStatus;
    }
    ```

    This method only reads _dwStatus and does not modify any member state.
    CAN be const.

    Changes to make:
    1. In CMessageCredential.h, change:
       - `DWORD GetStatus()` to `DWORD GetStatus() const`

    The method is defined inline in the header, so only the header needs to be changed.
  </action>
  <verify>
    grep "GetStatus() const" EIDCredentialProvider/CMessageCredential.h
    Build: msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:EIDCredentialProvider
  </verify>
  <done>GetStatus() marked const in CMessageCredential header</done>
</task>

<task type="auto">
  <name>Task 5: Verify CEIDCredential::GetContainer already const</name>
  <files>EIDCredentialProvider/CEIDCredential.h, EIDCredentialProvider/CEIDCredential.cpp</files>
  <action>
    Verify CEIDCredential::GetContainer is already marked const.

    Current signature in header (CEIDCredential.h line 88):
    ```cpp
    CContainer* GetContainer() const;
    ```

    Current implementation in CEIDCredential.cpp line 141:
    ```cpp
    CContainer* CEIDCredential::GetContainer() const
    {
        return _pContainer;
    }
    ```

    Already const - no changes required.

    Document for phase summary that this method is already correctly marked const.
  </action>
  <verify>
    grep "GetContainer() const" EIDCredentialProvider/CEIDCredential.h
    grep "GetContainer() const" EIDCredentialProvider/CEIDCredential.cpp
    Build: msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64
  </verify>
  <done>CEIDCredential::GetContainer verified already const</done>
</task>

<task type="auto">
  <name>Task 6: Document COM interface won't-fix methods (CONST-04)</name>
  <files>EIDCredentialProvider/CEIDCredential.h, EIDCredentialProvider/CMessageCredential.h, EIDCredentialProvider/CEIDProvider.h, EIDCredentialProvider/CEIDFilter.h</files>
  <action>
    Document all COM interface methods as won't-fix per CONST-04.

    These methods CANNOT be made const because they are part of COM interfaces
    (ICredentialProvider, ICredentialProviderCredential, ICredentialProviderFilter)
    and changing their signatures would break the interface contract.

    CEIDCredential COM interface methods (won't-fix):
    - Advise(), UnAdvise() - ICredentialProviderCredential
    - SetSelected(), SetDeselected() - ICredentialProviderCredential
    - GetFieldState(), GetStringValue(), GetBitmapValue() - ICredentialProviderCredential
    - GetCheckboxValue(), GetComboBoxValueCount(), GetComboBoxValueAt() - ICredentialProviderCredential
    - GetSubmitButtonValue(), SetStringValue(), SetCheckboxValue() - ICredentialProviderCredential
    - SetComboBoxSelectedValue(), CommandLinkClicked() - ICredentialProviderCredential
    - GetSerialization(), ReportResult() - ICredentialProviderCredential
    - QueryInterface(), AddRef(), Release() - IUnknown

    CMessageCredential COM interface methods (won't-fix):
    - Same ICredentialProviderCredential methods as CEIDCredential
    - QueryInterface(), AddRef(), Release() - IUnknown

    CEIDProvider COM interface methods (won't-fix):
    - SetUsageScenario(), SetSerialization() - ICredentialProvider
    - Advise(), UnAdvise() - ICredentialProvider
    - GetFieldDescriptorCount(), GetFieldDescriptorAt() - ICredentialProvider
    - GetCredentialCount(), GetCredentialAt() - ICredentialProvider
    - QueryInterface(), AddRef(), Release() - IUnknown

    CEIDFilter COM interface methods (won't-fix):
    - Filter(), UpdateRemoteCredential() - ICredentialProviderFilter
    - QueryInterface(), AddRef(), Release() - IUnknown

    No code changes - documentation only for phase summary.
    Justification: COM interface methods cannot have const added because the interface
    contract is defined by Windows and cannot be modified.
  </action>
  <verify>
    Verify all IFACEMETHODIMP methods remain unchanged
    grep -c "IFACEMETHODIMP" EIDCredentialProvider/*.cpp
  </verify>
  <done>COM interface methods documented as won't-fix per CONST-04 - cannot change Windows API contracts</done>
</task>

<task type="auto">
  <name>Task 7: Build verification</name>
  <files>All modified files</files>
  <action>
    Perform full build verification after all const changes:

    1. Clean build all 7 projects:
       msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:Rebuild

    2. Verify zero build errors

    3. Verify no new warnings introduced

    Projects to verify:
    - EIDCardLibrary
    - EIDCredentialProvider
    - EIDAuthenticationPackage
    - EIDConfigurationWizard
    - EIDConfigurationWizardElevated
    - EIDLogManager
    - EIDPasswordChangeNotification
  </action>
  <verify>
    msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:Rebuild
    Exit code should be 0 (success)
  </verify>
  <done>All 7 projects build with zero errors after const additions</done>
</task>

</tasks>

<verification>
1. Verify HasContainerHolder() is marked const in CContainerHolderFactory.h
2. Verify ContainerHolderCount() is marked const in CContainerHolderFactory.h
3. Verify GetStatus() is marked const in CMessageCredential.h
4. Verify CEIDCredential::GetContainer() remains const
5. Verify CContainer methods remain correctly const/non-const
6. Verify all 7 projects build successfully
7. Document COM interface methods as won't-fix
</verification>

<success_criteria>
1. CContainerHolderFactory::HasContainerHolder() marked const
2. CContainerHolderFactory::ContainerHolderCount() marked const
3. CMessageCredential::GetStatus() marked const
4. COM interface methods documented as won't-fix (cannot change signatures)
5. Build passes with zero errors after const additions
6. No new warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/35-const-correctness-functions/35-01-SUMMARY.md`
</output>
