---
phase: 33-independent-style-issues
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - EIDCredentialProvider/common.h
  - EIDCredentialProvider/CMessageCredential.h
  - EIDConfigurationWizard/CContainerHolder.h
  - EIDCardLibrary/EIDCardLibrary.h
  - EIDCardLibrary/StoredCredentialManagement.h
  - EIDCardLibrary/GPO.h
  - EIDCardLibrary/StoredCredentialManagement.cpp
  - EIDAuthenticationPackage/EIDSecuritySupportProvider.cpp
  - EIDAuthenticationPackage/EIDAuthenticationPackage.cpp
  - EIDCardLibrary/CertificateUtilities.cpp
  - EIDCardLibrary/CContainer.cpp
  - EIDCardLibrary/CompleteToken.cpp
  - EIDCardLibrary/CSmartCardNotifier.cpp
  - EIDConfigurationWizard/CContainerHolder.cpp
  - EIDConfigurationWizard/Common.cpp
  - EIDConfigurationWizard/DebugReport.cpp
  - EIDCredentialProvider/helpers.cpp
  - EIDCredentialProvider/CEIDCredential.cpp
  - EIDCredentialProvider/CEIDProvider.cpp
  - EIDCredentialProvider/CMessageCredential.cpp
  - EIDCardLibrary/StringConversion.cpp
  - EIDCardLibrary/Tracing.cpp
  - EIDAuthenticationPackage/EIDSecuritySupportProviderUserMode.cpp
autonomous: true
requirements:
  - MODERN-02
  - MODERN-05
  - MODERN-06
must_haves:
  truths:
    - "C-style casts are replaced with named C++ casts (static_cast, reinterpret_cast, const_cast)"
    - "Internal enum types are converted to enum class with scoped enumerators"
    - "Windows API enum types are documented as won't-fix with API compatibility justification"
    - "All 7 projects build successfully after style changes"
  artifacts:
    - path: "EIDCardLibrary/EIDCardLibrary.h"
      provides: "Core enum definitions for message types and states"
      contains: "enum class"
    - path: "EIDCardLibrary/GPO.h"
      provides: "GPO policy enum definition"
      contains: "enum class"
    - path: "EIDCardLibrary/StoredCredentialManagement.h"
      provides: "Private data type enum"
      contains: "enum class"
    - path: "EIDConfigurationWizard/CContainerHolder.h"
      provides: "CheckType enum"
      contains: "enum class"
    - path: "EIDCredentialProvider/CMessageCredential.h"
      provides: "Credential status enum"
      contains: "enum class"
    - path: "EIDAuthenticationPackage/EIDSecuritySupportProvider.cpp"
      provides: "C-style cast replacements in SSP code"
      pattern: "static_cast|reinterpret_cast"
  key_links:
    - from: "enum class definitions"
      to: "struct field types"
      via: "type-safe enum usage"
      pattern: "EID_.*_TYPE"
    - from: "EIDAlloc calls"
      to: "pointer variables"
      via: "static_cast<Type*>"
      pattern: "static_cast<.*\\*>\\s*EIDAlloc"
---

<objective>
Replace C-style casts with named C++ casts and convert internal enum types to enum class for type safety, while documenting Windows API enum types as won't-fix.

Purpose: Modernize code style to use C++ named casts for better type safety and convert unscoped enums to enum class where safe, reducing implicit conversions and improving code maintainability.

Output: Updated source files with modern C++ casts and enum class definitions, plus won't-fix documentation for Windows API compatibility enums.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key constraints from PROJECT.md:
# - LSASS context: No exceptions, no console I/O, static CRT required
# - Windows 7 support: Must use v143 toolset (v145 drops Win7)
# - C++23 flag: Use `/std:c++23preview`
# - C-style APIs: Preserve HRESULT/BOOL at exported boundaries
# - std::string: Generally unsafe in LSASS - uses dynamic allocation

# Enum types found in codebase:
# 1. SAMPLE_FIELD_ID (common.h) - used as array indices, CREDENTIAL_PROVIDER_FIELD_DESCRIPTOR compatibility
# 2. SAMPLE_MESSAGE_FIELD_ID (common.h) - same pattern
# 3. EID_INTERACTIVE_LOGON_SUBMIT_TYPE (EIDCardLibrary.h) - LSA struct member, fixed value 13
# 4. EID_PROFILE_BUFFER_TYPE (EIDCardLibrary.h) - LSA struct member, fixed value 2
# 5. EID_CREDENTIAL_PROVIDER_READER_STATE (EIDCardLibrary.h) - internal state machine
# 6. EID_CALLPACKAGE_MESSAGE (EIDCardLibrary.h) - LSA struct member, used in switch
# 7. EID_MESSAGE_STATE (EIDCardLibrary.h) - internal state machine
# 8. EID_MESSAGE_TYPE (EIDCardLibrary.h) - struct member, network protocol
# 9. EID_SSP_CALLER (EIDCardLibrary.h) - internal callback identification
# 10. CMessageCredentialStatus (CMessageCredential.h) - internal state
# 11. CheckType (CContainerHolder.h) - internal check type
# 12. GPOPolicy (GPO.h) - internal policy index
# 13. EID_PRIVATE_DATA_TYPE (StoredCredentialManagement.h) - struct member
# 14. USER_INFORMATION_CLASS (StoredCredentialManagement.cpp) - SAM API compatibility, won't-fix

# C-style cast categories found:
# 1. EIDAlloc returns -> pointer types (safe for static_cast)
# 2. CoTaskMemAlloc returns -> pointer types (safe for static_cast)
# 3. HeapAlloc returns -> pointer types (safe for static_cast)
# 4. Size calculations (wcslen, _tcslen) -> USHORT/DWORD (safe for static_cast)
# 5. Handle conversions (LSA_SEC_HANDLE) -> pointer types (reinterpret_cast)
# 6. Windows API struct pointer casts (PSecPkgContext_*) -> reinterpret_cast
# 7. (DWORD)-1 sentinel values -> static_cast
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert internal enum types to enum class</name>
  <files>
    EIDCardLibrary/EIDCardLibrary.h
    EIDCardLibrary/StoredCredentialManagement.h
    EIDCardLibrary/GPO.h
    EIDConfigurationWizard/CContainerHolder.h
    EIDCredentialProvider/CMessageCredential.h
  </files>
  <action>
Convert the following internal enum types to enum class. For each enum:
1. Change `enum NAME` to `enum class NAME`
2. Update all usages to use scoped enumerators (e.g., `NAME::Value`)
3. Add explicit casts where implicit conversions to int/DWORD occur

**Enums to convert (safe - internal use only):**

1. **EID_CREDENTIAL_PROVIDER_READER_STATE** (EIDCardLibrary.h)
   - Internal state machine for reader connection status
   - Update usages to `EID_CREDENTIAL_PROVIDER_READER_STATE::EIDCPRSConnecting` etc.

2. **EID_MESSAGE_STATE** (EIDCardLibrary.h)
   - Internal state machine for message handling
   - Update usages to `EID_MESSAGE_STATE::EIDMSNone` etc.

3. **EID_MESSAGE_TYPE** (EIDCardLibrary.h)
   - Network protocol message type
   - Note: struct member MessageType uses DWORD - may need cast at assignment

4. **EID_SSP_CALLER** (EIDCardLibrary.h)
   - Internal callback identification
   - Update usages to `EID_SSP_CALLER::EIDSSPInitialize` etc.

5. **EID_PRIVATE_DATA_TYPE** (StoredCredentialManagement.h)
   - Already has validation function `IsValidPrivateDataType()` that takes the enum type
   - Update usages to scoped form

6. **GPOPolicy** (GPO.h)
   - Already has validation function `IsValidPolicy()` that takes the enum type
   - Used as array index - may need `static_cast<int>()` in GetPolicyValue/SetPolicyValue

7. **CheckType** (CContainerHolder.h)
   - Internal check type enumeration
   - Update usages to `CheckType::CHECK_SIGNATUREONLY` etc.

8. **CMessageCredentialStatus** (CMessageCredential.h)
   - Internal credential state machine
   - Update usages to `CMessageCredentialStatus::Idle` etc.

**Enums that MUST remain unscoped (won't-fix):**
- SAMPLE_FIELD_ID, SAMPLE_MESSAGE_FIELD_ID: Used as CREDENTIAL_PROVIDER_FIELD_DESCRIPTOR indices (Windows API)
- EID_INTERACTIVE_LOGON_SUBMIT_TYPE: LSA struct member with fixed value 13 (Windows compatibility)
- EID_PROFILE_BUFFER_TYPE: LSA struct member with fixed value 2 (Windows compatibility)
- EID_CALLPACKAGE_MESSAGE: LSA struct member (EID_CALLPACKAGE_BUFFER.MessageType is DWORD)
- USER_INFORMATION_CLASS: SAM API enum with fixed value 18 (Windows API compatibility)

**For each enum class conversion:**
- Search for all usages of the enum values in .cpp files
- Add `EnumName::` prefix to each usage
- Add `static_cast<int>()` or `static_cast<DWORD>()` where array indexing or DWORD comparison occurs
- Build and verify compilation after each enum conversion
  </action>
  <verify>
    - Build succeeds with `msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:Build`
    - Grep confirms enum class definitions: `grep "enum class" EIDCardLibrary/EIDCardLibrary.h`
    - No implicit enum-to-int conversions without explicit cast
  </verify>
  <done>
    - 8 enum types converted to enum class
    - All usages updated to scoped form
    - Build passes with zero errors
    - Windows API enums documented as won't-fix with justification
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace C-style casts with named casts in EIDAuthenticationPackage</name>
  <files>
    EIDAuthenticationPackage/EIDSecuritySupportProvider.cpp
    EIDAuthenticationPackage/EIDAuthenticationPackage.cpp
    EIDAuthenticationPackage/EIDSecuritySupportProviderUserMode.cpp
  </files>
  <action>
Replace C-style casts with appropriate named C++ casts:

**Cast patterns to replace:**

1. **EIDAlloc allocation casts** - use `static_cast<Type*>`:
   ```cpp
   // Before: (PSECPKG_EXTENDED_INFORMATION) EIDAlloc(...)
   // After:  static_cast<PSECPKG_EXTENDED_INFORMATION>(EIDAlloc(...))
   ```

2. **Size calculation casts** - use `static_cast`:
   ```cpp
   // Before: (DWORD)(_tcslen(szName)+1) * sizeof(TCHAR)
   // After:  static_cast<DWORD>((_tcslen(szName)+1) * sizeof(TCHAR))

   // Before: (USHORT)(wcslen(szComputer) * sizeof(WCHAR))
   // After:  static_cast<USHORT>(wcslen(szComputer) * sizeof(WCHAR))
   ```

3. **Handle/pointer conversions** - use `reinterpret_cast`:
   ```cpp
   // Before: (LSA_SEC_HANDLE) pCredential
   // After:  reinterpret_cast<LSA_SEC_HANDLE>(pCredential)

   // Before: *NewContextHandle = (LSA_SEC_HANDLE) newContext
   // After:  *NewContextHandle = reinterpret_cast<LSA_SEC_HANDLE>(newContext)
   ```

4. **Struct pointer casts for Windows APIs** - use `reinterpret_cast`:
   ```cpp
   // Before: ContextSizes = (PSecPkgContext_Sizes) pBuffer
   // After:  ContextSizes = reinterpret_cast<PSecPkgContext_Sizes>(pBuffer)
   ```

5. **Sentinel value casts** - use `static_cast`:
   ```cpp
   // Before: (DWORD)-1
   // After:  static_cast<DWORD>(-1)
   ```

**Files to update:**
- EIDSecuritySupportProvider.cpp: ~30 cast replacements
- EIDAuthenticationPackage.cpp: ~10 cast replacements
- EIDSecuritySupportProviderUserMode.cpp: ~3 cast replacements

**Guidelines:**
- `static_cast`: Related type conversions (void* to typed*, numeric conversions)
- `reinterpret_cast`: Unrelated pointer types, handle conversions
- `const_cast`: Only when Windows API requires non-const (document reason)
- Do NOT change any cast that removes const without adding comment explaining Windows API requirement
  </action>
  <verify>
    - Build succeeds with `msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:Build`
    - Grep for remaining C-style casts: `grep -E "=\s*\([A-Z][A-Z_a-z0-9]*\s*\*?\)" EIDAuthenticationPackage/*.cpp` should show minimal/no results
  </verify>
  <done>
    - All EIDAlloc/CoTaskMemAlloc/HeapAlloc casts converted to static_cast
    - All handle conversions use reinterpret_cast
    - All size calculations use static_cast
    - Build passes with zero errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Replace C-style casts with named casts in EIDCardLibrary and EIDCredentialProvider</name>
  <files>
    EIDCardLibrary/CertificateUtilities.cpp
    EIDCardLibrary/CContainer.cpp
    EIDCardLibrary/CompleteToken.cpp
    EIDCardLibrary/CSmartCardNotifier.cpp
    EIDCardLibrary/StringConversion.cpp
    EIDCardLibrary/Tracing.cpp
    EIDCredentialProvider/helpers.cpp
    EIDCredentialProvider/CEIDCredential.cpp
    EIDCredentialProvider/CEIDProvider.cpp
    EIDCredentialProvider/CMessageCredential.cpp
    EIDConfigurationWizard/CContainerHolder.cpp
    EIDConfigurationWizard/Common.cpp
    EIDConfigurationWizard/DebugReport.cpp
  </files>
  <action>
Apply the same cast modernization pattern to remaining projects:

**EIDCardLibrary files:**
- CertificateUtilities.cpp: ~20 casts (mostly EIDAlloc and size calculations)
- CContainer.cpp: ~8 casts
- CompleteToken.cpp: ~15 casts (EIDAlloc, offset calculations)
- CSmartCardNotifier.cpp: ~5 casts
- StringConversion.cpp: ~2 casts (USHORT conversions)
- Tracing.cpp: ~1 cast

**EIDCredentialProvider files:**
- helpers.cpp: ~5 casts (CoTaskMemAlloc, GetProcAddress)
- CEIDCredential.cpp: ~3 casts
- CEIDProvider.cpp: ~3 casts
- CMessageCredential.cpp: ~2 casts

**EIDConfigurationWizard files:**
- CContainerHolder.cpp: ~3 casts
- Common.cpp: ~2 casts
- DebugReport.cpp: ~2 casts

**Use the same patterns as Task 2:**
- `static_cast<Type*>` for EIDAlloc, HeapAlloc, CoTaskMemAlloc
- `static_cast<USHORT/DWORD>()` for size calculations
- `reinterpret_cast<>()` for handle/struct pointer conversions
- `static_cast<DWORD>(-1)` for sentinel values

**Special cases:**
- `(LPCWSTR)szCredential` in CredUnmarshalCredentialW call: use `reinterpret_cast<LPCWSTR>(szCredential)`
- `(PVOID*)` output parameters: use `reinterpret_cast<PVOID*>(...)`
  </action>
  <verify>
    - Build succeeds with `msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:Build`
    - Grep for remaining C-style casts in modified files shows minimal results
  </verify>
  <done>
    - All EIDCardLibrary casts modernized
    - All EIDCredentialProvider casts modernized
    - All EIDConfigurationWizard casts modernized
    - Build passes with zero errors
  </done>
</task>

<task type="auto">
  <name>Task 4: Verify build and document won't-fix items</name>
  <files>
    .planning/phases/33-independent-style-issues/33-VERIFICATION.md
  </files>
  <action>
Perform final build verification and document won't-fix items:

**1. Full solution build:**
```bash
msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:Rebuild
```
Verify all 7 projects compile with zero errors and no new warnings.

**2. Create 33-VERIFICATION.md documenting won't-fix items:**

```markdown
# Phase 33 Verification - Independent Style Issues

## Won't-Fix Items

### Windows API Enum Types (MODERN-06)

The following enum types MUST remain as unscoped enums for Windows API compatibility:

1. **SAMPLE_FIELD_ID** (EIDCredentialProvider/common.h)
   - Used as CREDENTIAL_PROVIDER_FIELD_DESCRIPTOR.dwFieldID
   - Windows Credential Provider API expects DWORD, not enum class
   - Implicit conversion to DWORD is required

2. **SAMPLE_MESSAGE_FIELD_ID** (EIDCredentialProvider/common.h)
   - Same pattern as SAMPLE_FIELD_ID
   - Required for Credential Provider field indexing

3. **EID_INTERACTIVE_LOGON_SUBMIT_TYPE** (EIDCardLibrary/EIDCardLibrary.h)
   - Member of EID_INTERACTIVE_LOGON struct
   - Fixed value 13 (KerbCertificateLogon) for LSA compatibility
   - LSA expects DWORD-sized message type

4. **EID_PROFILE_BUFFER_TYPE** (EIDCardLibrary/EIDCardLibrary.h)
   - Member of EID_INTERACTIVE_PROFILE struct
   - Fixed value 2 (EIDInteractiveProfile) for LSA compatibility

5. **EID_CALLPACKAGE_MESSAGE** (EIDCardLibrary/EIDCardLibrary.h)
   - Member of EID_CALLPACKAGE_BUFFER struct
   - Used in LsaApCallPackage - DWORD type required

6. **USER_INFORMATION_CLASS** (EIDCardLibrary/StoredCredentialManagement.cpp)
   - SAM API enum with fixed value 18 (UserInternal1Information)
   - Must match Windows SAM RPC interface

**Justification:** These enums interact with Windows LSA, Credential Provider, and SAM APIs that expect DWORD-sized integers. Converting to enum class would require explicit casts at every API boundary, reducing code clarity and potentially introducing bugs.

## Converted Items (MODERN-05)

The following enums were successfully converted to enum class:
- EID_CREDENTIAL_PROVIDER_READER_STATE
- EID_MESSAGE_STATE
- EID_MESSAGE_TYPE
- EID_SSP_CALLER
- EID_PRIVATE_DATA_TYPE
- GPOPolicy
- CheckType
- CMessageCredentialStatus

## C-Style Cast Replacements (MODERN-02)

All C-style casts replaced with named casts:
- static_cast for related type conversions
- reinterpret_cast for handle/pointer type conversions
- const_cast only where Windows API requires non-const (none needed)

## Build Verification

- [ ] All 7 projects compile with zero errors
- [ ] No new warnings introduced
- [ ] Runtime behavior unchanged (casts are equivalent)
```

**3. Verify no regressions:**
- Ensure no functional changes, only style improvements
- Casts are semantically equivalent to originals
  </action>
  <verify>
    - `msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:Rebuild` succeeds
    - 33-VERIFICATION.md exists with won't-fix documentation
    - Build output shows 0 errors and 0 new warnings
  </verify>
  <done>
    - All 7 projects build successfully
    - Won't-fix items documented with Windows API compatibility justification
    - No new warnings introduced
    - Phase 33 complete and verified
  </done>
</task>

</tasks>

<verification>
1. Full solution rebuild with zero errors
2. Grep confirms enum class definitions for internal enums
3. Grep confirms minimal C-style casts remain (only Windows API required)
4. 33-VERIFICATION.md documents won't-fix items with justifications
</verification>

<success_criteria>
1. C-style casts replaced with named casts (static_cast, reinterpret_cast, const_cast)
2. Internal enum types converted to enum class (8 enums)
3. Windows API enum types documented as won't-fix with API compatibility justification (6 enums)
4. Build passes with zero errors after style changes
</success_criteria>

<output>
After completion, create `.planning/phases/33-independent-style-issues/33-01-SUMMARY.md`
</output>
