---
phase: 02-error-handling
plan: 02
type: execute
wave: 2
depends_on: [02-01a]
files_modified:
  - EIDCardLibrary/ErrorHandling.h
  - EIDCardLibrary/ErrorHandling.cpp
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Result<T> type alias defined for std::expected<T, HRESULT>"
    - "make_unexpected() helper creates std::unexpected<HRESULT> from error codes"
    - "to_bool() conversion helper converts Result<T> to BOOL with SetLastError"
    - "All error handling functions marked noexcept"
    - "ErrorHandling.h compiles with C++23 and includes <expected>"
  artifacts:
    - path: "EIDCardLibrary/ErrorHandling.h"
      provides: "Result<T> alias, make_unexpected(), to_bool(), win32_to_hr()"
      exports: ["EID::Result<T>", "EID::ResultVoid", "EID::make_unexpected", "EID::to_bool", "EID::win32_to_hr"]
      min_lines: 80
    - path: "EIDCardLibrary/ErrorHandling.cpp"
      provides: "Conversion function implementations (HRESULT to NTSTATUS mapping, if needed)"
      min_lines: 20
  key_links:
    - from: "EIDCardLibrary/ErrorHandling.h"
      to: "<expected> (C++23 standard library)"
      via: "#include <expected>"
      pattern: "#include <expected>"
    - from: "EIDCardLibrary/ErrorHandling.h"
      to: "Windows error handling (winerror.h, winnt.h)"
      via: "HRESULT, GetLastError(), SetLastError()"
      pattern: "HRESULT_FROM_WIN32|SetLastError"
    - from: "EIDCardLibrary/ErrorHandling.h"
      to: "EIDCardLibrary/EIDCardLibrary.h"
      via: "Included by EIDCardLibrary.h for global availability"
      pattern: "#include \"ErrorHandling.h\""
---

<objective>
Define Result<T> error handling types and helper utilities using C++23 std::expected for type-safe, exception-free error propagation.

Purpose: Replace the current BOOL + SetLastError()/GetLastError() pattern with std::expected<T, HRESULT> for internal functions. This provides type safety, eliminates forgotten error checks via [[nodiscard]], and enables monadic error propagation (.and_then(), .transform()) while maintaining compatibility with LSASS constraints (no exceptions).

Output: ErrorHandling.h/cpp providing Result<T> alias, error helpers, and conversion utilities for use in internal functions.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-error-handling/02-RESEARCH.md
@.planning/phases/02-error-handling/02-01a-SUMMARY.md
@.planning/phases/01-build-system/01-03-SUMMARY.md

# Locked decisions from STATE.md
- "LSASS context: No exceptions, no console I/O, static CRT required"
- "C-style APIs: Preserve HRESULT/BOOL at exported boundaries"

# Research patterns to apply
From 02-RESEARCH.md Pattern 1 (Result<T> Type Alias):
```cpp
namespace EID {
template<typename T>
using Result = std::expected<T, HRESULT>;

using ResultVoid = std::expected<void, HRESULT>;

[[nodiscard]] inline auto make_unexpected(HRESULT hr) noexcept {
    return std::unexpected(hr);
}
}
```

From 02-RESEARCH.md Pattern 3 (BOOL Boundary Conversion):
```cpp
template<typename T>
[[nodiscard]] inline BOOL to_bool(Result<T>&& result) noexcept {
    if (result) {
        return TRUE;
    }
    SetLastError(static_cast<DWORD>(result.error()));
    return FALSE;
}
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ErrorHandling.h with Result<T> type and helpers</name>
  <files>EIDCardLibrary/ErrorHandling.h</files>
  <action>
Create EIDCardLibrary/ErrorHandling.h with the following structure:

```cpp
#pragma once

#include <expected>
#include <winerror.h>

namespace EID {

// Primary result type using HRESULT as error type
// Replaces BOOL + SetLastError pattern for internal functions
template<typename T>
using Result = std::expected<T, HRESULT>;

// Void result for operations with no return value
using ResultVoid = std::expected<void, HRESULT>;

// Create an unexpected result from HRESULT error code
[[nodiscard]] inline auto make_unexpected(HRESULT hr) noexcept {
    return std::unexpected(hr);
}

// Convert Win32 error code to HRESULT
[[nodiscard]] inline HRESULT win32_to_hr(DWORD win32Error) noexcept {
    return HRESULT_FROM_WIN32(win32Error);
}

// Convert Result<T> to BOOL for API boundary
// Sets GetLastError() on error, returns TRUE on success
template<typename T>
[[nodiscard]] inline BOOL to_bool(Result<T>&& result) noexcept {
    if (result) {
        return TRUE;
    }
    SetLastError(static_cast<DWORD>(result.error()));
    return FALSE;
}

// Specialization for ResultVoid (no value to extract)
[[nodiscard]] inline BOOL to_bool(ResultVoid&& result) noexcept {
    if (result) {
        return TRUE;
    }
    SetLastError(static_cast<DWORD>(result.error()));
    return FALSE;
}

// Helper: Check if result indicates success
template<typename T>
[[nodiscard]] inline bool succeeded(const Result<T>& result) noexcept {
    return result.has_value();
}

// Helper: Check if result indicates success (ResultVoid overload)
[[nodiscard]] inline bool succeeded(const ResultVoid& result) noexcept {
    return result.has_value();
}

} // namespace EID
```

Requirements:
1. All functions marked noexcept (LSASS compatibility)
2. All value-returning functions marked [[nodiscard]] (prevent ignored errors)
3. Template functions defined in header (inline for ODR compliance)
4. Namespace EID prevents name collisions
5. HRESULT_FROM_WIN32 used for Win32 error conversion (standard Windows macro)

DO NOT:
- Add std::string to error types (allocations can throw)
- Throw exceptions (LSASS constraint)
- Use std::function or other allocating types
  </action>
  <verify>
Build EIDCardLibrary and verify ErrorHandling.h compiles without errors
Verify with grep: "nodiscard" present on all non-void helper functions
  </verify>
  <done>ErrorHandling.h exists with Result<T>, make_unexpected(), to_bool(), win32_to_hr() defined</done>
</task>

<task type="auto">
  <name>Task 2: Create ErrorHandling.cpp with HRESULT to NTSTATUS conversion (if needed)</name>
  <files>EIDCardLibrary/ErrorHandling.cpp</files>
  <action>
Create EIDCardLibrary/ErrorHandling.cpp with HRESULT to NTSTATUS conversion mapping.

LSA authentication functions use NTSTATUS error codes, while internal Result<T> uses HRESULT. Add conversion function:

```cpp
#include "ErrorHandling.h"
#include <ntstatus.h>

namespace EID {

// Convert HRESULT to NTSTATUS for LSA authentication functions
// Mapping: Common HRESULT codes to their NTSTATUS equivalents
[[nodiscard]] NTSTATUS hr_to_ntstatus(HRESULT hr) noexcept {
    // Direct mappings for common codes
    switch (hr) {
        case S_OK:
            return STATUS_SUCCESS;
        case E_NOTIMPL:
            return STATUS_NOT_IMPLEMENTED;
        case E_NOINTERFACE:
            return STATUS_NOT_SUPPORTED;
        case E_POINTER:
            return STATUS_INVALID_PARAMETER;
        case E_ABORT:
            return STATUS_REQUEST_ABORTED;
        case E_FAIL:
        case E_UNEXPECTED:
            return STATUS_UNSUCCESSFUL;
        case E_ACCESSDENIED:
            return STATUS_ACCESS_DENIED;
        case E_OUTOFMEMORY:
            return STATUS_NO_MEMORY;
        case E_INVALIDARG:
            return STATUS_INVALID_PARAMETER;
        // Win32 error codes wrapped in HRESULT
        case HRESULT_FROM_WIN32(ERROR_SUCCESS):
            return STATUS_SUCCESS;
        case HRESULT_FROM_WIN32(ERROR_NOT_ENOUGH_MEMORY):
            return STATUS_NO_MEMORY;
        case HRESULT_FROM_WIN32(ERROR_INVALID_PARAMETER):
            return STATUS_INVALID_PARAMETER;
        case HRESULT_FROM_WIN32(ERROR_ACCESS_DENIED):
            return STATUS_ACCESS_DENIED;
        default:
            // For unmapped codes, convert FACILITY_WIN32 HRESULTs to NTSTATUS
            if (HRESULT_FACILITY(hr) == FACILITY_WIN32) {
                return static_cast<NTSTATUS>(HRESULT_CODE(hr));
            }
            // Generic failure for unknown HRESULTs
            return STATUS_UNSUCCESSFUL;
    }
}

} // namespace EID
```

Requirements:
1. Function marked noexcept (LSASS compatibility)
2. [[nodiscard]] to prevent ignored return
3. Mapping covers all common HRESULT codes used in EIDCardLibrary
4. Default case handles unmapped codes safely

Note: This function is used by 02-03 (API boundary conversion layer).
  </action>
  <verify>
Build EIDCardLibrary and verify ErrorHandling.cpp compiles without errors
Verify with grep: "noexcept" present on hr_to_ntstatus function
  </verify>
  <done>ErrorHandling.cpp exists with hr_to_ntstatus() conversion mapping defined</done>
</task>

<task type="auto">
  <name>Task 3: Add ErrorHandling.h include to EIDCardLibrary.h</name>
  <files>EIDCardLibrary/EIDCardLibrary.h</files>
  <action>
Add #include "ErrorHandling.h" to EIDCardLibrary.h after existing includes, before namespace/enum definitions.

Placement: After #pragma warning(pop) block (after line 40), before constexpr const char* AUTHENTICATIONPACKAGENAME (line 31).

```cpp
#pragma warning(pop)

#include "ErrorHandling.h"

#define EIDAlloc(value) EIDAllocEx(__FILE__,__LINE__,__FUNCTION__,value)
```

This makes EID::Result<T> and helpers available throughout EIDCardLibrary without additional includes.

DO NOT:
- Place include before #pragma warning(pop) (would re-enable disabled warnings)
- Add include before system headers (ordering convention)
  </action>
  <verify>
Build EIDCardLibrary and verify EIDCardLibrary.h compiles without errors
Verify other .cpp files can use EID::Result<T> without additional includes
  </verify>
  <done>EIDCardLibrary.h includes ErrorHandling.h for global Result<T> availability</done>
</task>

</tasks>

<verification>
1. Build EIDCardLibrary project with C++23 (all configurations)
2. Verify ErrorHandling.h compiles with <expected> header (requires VS 2022 17.6+)
3. Verify all helper functions marked noexcept and [[nodiscard]]
4. Test instantiation: `EID::Result<int> r = 5; EID::Result<int> e = EID::make_unexpected(E_FAIL);`
5. Verify to_bool() conversion preserves error codes in GetLastError()
6. Confirm no allocations in error paths (no std::string, std::vector, etc.)
</verification>

<success_criteria>
1. ErrorHandling.h provides Result<T>, ResultVoid, make_unexpected(), to_bool(), win32_to_hr(), succeeded()
2. ErrorHandling.cpp provides hr_to_ntstatus() for LSA boundary conversion
3. All functions marked noexcept and [[nodiscard]] where applicable
4. EIDCardLibrary.h includes ErrorHandling.h for project-wide availability
5. Ready for 02-03 (API boundary conversion layer creation)
</success_criteria>

<output>
After completion, create `.planning/phases/02-error-handling/02-02-SUMMARY.md`
</output>
