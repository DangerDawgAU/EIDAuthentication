---
phase: 31-macro-to-constexpr
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - EIDCredentialProvider/common.h
  - EIDLogManager/EIDLogManager.cpp
  - EIDCardLibrary/EIDCardLibrary.h
autonomous: true
requirements:
  - MACRO-01
  - MACRO-02
  - MACRO-03
user_setup: []
must_haves:
  truths:
    - "Simple value macros are converted to constexpr"
    - "Resource compiler macros remain as #define (RC.exe requires it)"
    - "Flow-control macros remain as #define (SEH/context requirements)"
    - "Build passes with zero errors"
  artifacts:
    - path: "EIDCredentialProvider/common.h"
      provides: "MAX_ULONG constexpr conversion"
      contains: "constexpr ULONG MAX_ULONG"
    - path: "EIDLogManager/EIDLogManager.cpp"
      provides: "CLSCTX_INPROC_SERVER constexpr conversion"
      contains: "constexpr LONG CLSCTX_INPROC_SERVER"
    - path: "EIDCardLibrary/EIDCardLibrary.h"
      provides: "CERT_HASH_LENGTH as macro (RC constraint documented)"
      contains: "#define CERT_HASH_LENGTH"
  key_links:
    - from: "All .rc files"
      to: "Resource ID macros (IDD_*, IDC_*, IDS_*, IDB_*)"
      via: "#include resource.h"
      pattern: "#define.*IDD_|#define.*IDC_"
    - from: "smartcardmodule.cpp"
      to: "CHECK_DWORD/CHECK_BOOL/CHECK_ALLOC"
      via: "SEH __leave flow control"
      pattern: "__leave"
---

<objective>
Convert simple value macros to constexpr while documenting resource compiler and flow-control macros as won't-fix with appropriate justifications.

Purpose: Enables Phase 34 (const correctness) which depends on macros being constexpr. Type-safe constexpr constants are superior to preprocessor macros for compile-time values.

Output: 3 simple value macros converted to constexpr, all other macros categorized with won't-fix justifications.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/research/SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Convert MAX_ULONG macro to constexpr</name>
  <files>EIDCredentialProvider/common.h</files>
  <action>
In EIDCredentialProvider/common.h line 33, convert the MAX_ULONG macro to constexpr:

Replace:
```cpp
#define MAX_ULONG  ((ULONG)(-1))
```

With:
```cpp
constexpr ULONG MAX_ULONG = static_cast<ULONG>(-1);
```

Note: This macro is used as a sentinel value for ULONG limits. The constexpr form provides type safety while maintaining the same compile-time evaluation.
  </action>
  <verify>Build EIDCredentialProvider project and verify no errors</verify>
  <done>MAX_ULONG defined as constexpr ULONG with same value, all usages compile successfully</done>
</task>

<task type="auto">
  <name>Convert CLSCTX_INPROC_SERVER macro to constexpr</name>
  <files>EIDLogManager/EIDLogManager.cpp</files>
  <action>
In EIDLogManager/EIDLogManager.cpp line 29, convert the local CLSCTX_INPROC_SERVER definition to constexpr:

Replace:
```cpp
#define CLSCTX_INPROC_SERVER  1
```

With:
```cpp
constexpr LONG CLSCTX_INPROC_SERVER_LOCAL = 1;
```

And update the usage at approximately line 140 (the CoCreateInstance call) to use the new constexpr constant.

Note: This is a local override of the Windows SDK CLSCTX_INPROC_SERVER enum value. The project uses a custom value here for EIDLogManager specifically. Renaming to CLSCTX_INPROC_SERVER_LOCAL avoids confusion with the SDK definition while maintaining functionality.
  </action>
  <verify>Build EIDLogManager project and verify no errors</verify>
  <done>CLSCTX_INPROC_SERVER_LOCAL defined as constexpr, usage updated, build passes</done>
</task>

<task type="auto">
  <name>Document CERT_HASH_LENGTH macro as won't-fix (Windows SDK conflict)</name>
  <files>EIDCardLibrary/EIDCardLibrary.h</files>
  <action>
The CERT_HASH_LENGTH macro at line 38 cannot be converted to constexpr because:

1. Windows SDK (WinCred.h) defines CERT_HASH_LENGTH as 20 (SHA-1)
2. This codebase uses SHA-256 (32 bytes) for security upgrade
3. The macro uses `#undef` then `#define` to override the SDK value
4. constexpr cannot override a macro with the same name (preprocessor runs first)

Add documentation comment explaining the won't-fix status:

```cpp
// The Windows SDK (WinCred.h) defines CERT_HASH_LENGTH as 20 (SHA-1), but we use SHA-256 (32)
// Undefine first to ensure our definition takes precedence without warnings
// WON'T-FIX (MACRO-02): Cannot convert to constexpr because Windows SDK defines this as a macro.
// The preprocessor #undef/#define pattern is required to override the SDK value.
#undef CERT_HASH_LENGTH
#define CERT_HASH_LENGTH 32  // SHA-256 hashes are used for cert hashes (security upgrade from SHA-1)
```

No code change required - just documentation update.
  </action>
  <verify>Build EIDCardLibrary and verify comment is present</verify>
  <done>CERT_HASH_LENGTH documented with won't-fix justification for MACRO-02</done>
</task>

<task type="auto">
  <name>Verify build passes after macro conversions</name>
  <files>All 7 projects</files>
  <action>
Run a full solution build to verify all macro conversions compile correctly:

```bash
cd C:/Users/user/Documents/EIDAuthentication
msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:Rebuild /m
```

Verify:
1. Zero build errors
2. No new warnings introduced
3. All 7 projects compile successfully
  </action>
  <verify>msbuild returns exit code 0 with zero errors</verify>
  <done>All 7 projects build with zero errors after macro conversions</done>
</task>

</tasks>

<verification>
1. Search for remaining convertible macros that were missed:
   - `grep -r "#define [A-Z_]*[0-9]*$" --include="*.h" --include="*.cpp"` finds simple value macros
   - Verify all found are either converted or documented as won't-fix

2. Confirm won't-fix categories are complete:
   - Resource compiler macros (IDD_*, IDC_*, IDS_*, IDB_*, _APS_*): documented as MACRO-02
   - Flow-control macros (CHECK_*, IMPL_*, EIDCardLibrary*, EIDAlloc, EIDFree): documented as MACRO-03
   - SDK configuration macros (WIN32_NO_STATUS, SECURITY_WIN32, _CRTDBG_MAP_ALLOC): documented as MACRO-03
   - Third-party header macros (cardmod.h): external file, not our code
</verification>

<success_criteria>
1. MAX_ULONG converted to constexpr in EIDCredentialProvider/common.h
2. CLSCTX_INPROC_SERVER converted to constexpr in EIDLogManager/EIDLogManager.cpp
3. CERT_HASH_LENGTH documented as won't-fix with MACRO-02 justification
4. All 7 projects build with zero errors
5. Won't-fix macro categories documented in code comments or VERIFICATION.md
</success_criteria>

<output>
After completion, create `.planning/phases/31-macro-to-constexpr/31-01-SUMMARY.md` documenting:
- Which macros were converted to constexpr
- Which macros remain as #define and why (MACRO-02, MACRO-03 categories)
- Build verification results
</output>
