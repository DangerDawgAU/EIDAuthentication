---
phase: 22-sonarqube-macro-issues
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - EIDCardLibrary/CertificateUtilities.cpp
  - EIDConfigurationWizard/EIDConfigurationWizardPage04.cpp
  - EIDConfigurationWizard/EIDConfigurationWizardPage05.cpp
autonomous: true
requirements:
  - SONAR-02

must_haves:
  truths:
    - "Numeric constants use constexpr with explicit types"
    - "Custom window messages use constexpr UINT"
    - "Build passes with no new warnings"
  artifacts:
    - path: "EIDCardLibrary/CertificateUtilities.cpp"
      provides: "BITLEN_TO_CHECK as constexpr inside struct"
      contains: "static constexpr DWORD BITLEN_TO_CHECK"
    - path: "EIDConfigurationWizard/EIDConfigurationWizardPage04.cpp"
      provides: "WM_MYMESSAGE as constexpr UINT"
      contains: "constexpr UINT WM_MYMESSAGE"
    - path: "EIDConfigurationWizard/EIDConfigurationWizardPage05.cpp"
      provides: "WM_MYMESSAGE as constexpr UINT"
      contains: "constexpr UINT WM_MYMESSAGE"
  key_links:
    - from: "macro constant"
      to: "constexpr variable"
      via: "type-safe constant conversion"
      pattern: "constexpr.*=.*WM_USER|constexpr.*=.*\\d+"
---

<objective>
Convert numeric constant macros to `constexpr` in CertificateUtilities.cpp and the EIDConfigurationWizard dialog pages.

Purpose: Replace preprocessor macros with typed `constexpr` constants for improved type safety and debugger visibility. The conversions target simple numeric values and custom window message definitions.

Output: Three files with macros converted to constexpr:
- CertificateUtilities.cpp: BITLEN_TO_CHECK converted to static constexpr
- EIDConfigurationWizardPage04.cpp: WM_MYMESSAGE converted to constexpr UINT
- EIDConfigurationWizardPage05.cpp: WM_MYMESSAGE converted to constexpr UINT
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-sonarqube-macro-issues/22-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert BITLEN_TO_CHECK macro to constexpr in CertificateUtilities.cpp</name>
  <files>EIDCardLibrary/CertificateUtilities.cpp</files>
  <action>
Convert the BITLEN_TO_CHECK macro inside the RSAPRIVKEY struct (around line 1271) to a static constexpr member.

**Context:** The macro is defined inside `#ifdef _DEBUG` block within the RSAPRIVKEY struct and used for array sizes. The struct definition spans lines 1267-1281.

**Before (lines 1267-1281):**
```cpp
struct RSAPRIVKEY {
	BLOBHEADER blobheader;
	RSAPUBKEY rsapubkey;
#ifdef _DEBUG
	#define BITLEN_TO_CHECK 2048
	BYTE modulus[BITLEN_TO_CHECK/8];
	BYTE prime1[BITLEN_TO_CHECK/16];
	BYTE prime2[BITLEN_TO_CHECK/16];
	BYTE exponent1[BITLEN_TO_CHECK/16];
	BYTE exponent2[BITLEN_TO_CHECK/16];
	BYTE coefficient[BITLEN_TO_CHECK/16];
	BYTE privateExponent[BITLEN_TO_CHECK/8];
#endif
};
```

**After:**
```cpp
struct RSAPRIVKEY {
	BLOBHEADER blobheader;
	RSAPUBKEY rsapubkey;
#ifdef _DEBUG
	static constexpr DWORD BITLEN_TO_CHECK = 2048;
	BYTE modulus[BITLEN_TO_CHECK/8];
	BYTE prime1[BITLEN_TO_CHECK/16];
	BYTE prime2[BITLEN_TO_CHECK/16];
	BYTE exponent1[BITLEN_TO_CHECK/16];
	BYTE exponent2[BITLEN_TO_CHECK/16];
	BYTE coefficient[BITLEN_TO_CHECK/16];
	BYTE privateExponent[BITLEN_TO_CHECK/8];
#endif
};
```

**Rationale:**
- Use `static constexpr` for struct member constants (C++11 feature)
- Explicitly type as `DWORD` since this is Windows cryptographic code
- The constexpr can be used in array size expressions (compile-time constant)
- This maintains the same behavior as the macro but with type safety
  </action>
  <verify>Build the EIDCardLibrary project: `msbuild EIDCardLibrary/EIDCardLibrary.vcxproj /p:Configuration=Release /p:Platform=x64`</verify>
  <done>RSAPRIVKEY struct contains `static constexpr DWORD BITLEN_TO_CHECK = 2048;` instead of `#define BITLEN_TO_CHECK 2048`</done>
</task>

<task type="auto">
  <name>Task 2: Convert WM_MYMESSAGE macro to constexpr in EIDConfigurationWizardPage04.cpp</name>
  <files>EIDConfigurationWizard/EIDConfigurationWizardPage04.cpp</files>
  <action>
Convert the WM_MYMESSAGE macro at line 422 from `#define` to `constexpr UINT`.

**Before (line 422):**
```cpp
#define WM_MYMESSAGE WM_USER + 10
```

**After:**
```cpp
constexpr UINT WM_MYMESSAGE = WM_USER + 10;
```

**Rationale:**
- Use `constexpr UINT` for Windows message constants
- `WM_USER` is a macro defined by Windows SDK, but it can be used in constexpr expressions
- The arithmetic `WM_USER + 10` will be evaluated at compile time
- This constant is used in the window procedure switch statement and PostMessage calls
- No functional change - the value is still a compile-time constant suitable for switch case labels
  </action>
  <verify>Build the EIDConfigurationWizard project: `msbuild EIDConfigurationWizard/EIDConfigurationWizard.vcxproj /p:Configuration=Release /p:Platform=x64`</verify>
  <done>Line 422 contains `constexpr UINT WM_MYMESSAGE = WM_USER + 10;` instead of `#define WM_MYMESSAGE WM_USER + 10`</done>
</task>

<task type="auto">
  <name>Task 3: Convert WM_MYMESSAGE macro to constexpr in EIDConfigurationWizardPage05.cpp</name>
  <files>EIDConfigurationWizard/EIDConfigurationWizardPage05.cpp</files>
  <action>
Convert the WM_MYMESSAGE macro at line 86 from `#define` to `constexpr UINT`.

**Before (line 86):**
```cpp
#define WM_MYMESSAGE WM_USER + 10
```

**After:**
```cpp
constexpr UINT WM_MYMESSAGE = WM_USER + 10;
```

**Rationale:**
- Same conversion pattern as Task 2 for consistency across the codebase
- This is a separate file with its own local WM_MYMESSAGE constant
- Used in the same way: window procedure switch statement and PostMessage calls
  </action>
  <verify>Build the EIDConfigurationWizard project and verify no new warnings</verify>
  <done>Line 86 contains `constexpr UINT WM_MYMESSAGE = WM_USER + 10;` instead of `#define WM_MYMESSAGE WM_USER + 10`</done>
</task>

</tasks>

<verification>
1. Build EIDCardLibrary and EIDConfigurationWizard projects succeed with zero errors
2. No new compiler warnings introduced
3. Verify BITLEN_TO_CHECK conversion:
   - `grep -n "BITLEN_TO_CHECK" EIDCardLibrary/CertificateUtilities.cpp` should show `static constexpr DWORD BITLEN_TO_CHECK`
4. Verify WM_MYMESSAGE conversions:
   - `grep -n "WM_MYMESSAGE" EIDConfigurationWizard/EIDConfigurationWizardPage04.cpp` should show `constexpr UINT WM_MYMESSAGE`
   - `grep -n "WM_MYMESSAGE" EIDConfigurationWizard/EIDConfigurationWizardPage05.cpp` should show `constexpr UINT WM_MYMESSAGE`
   - Both should NOT show `#define WM_MYMESSAGE`
5. Verify the constants are still usable in switch statements (compile-time constants)
</verification>

<success_criteria>
- BITLEN_TO_CHECK converted to static constexpr DWORD in RSAPRIVKEY struct
- WM_MYMESSAGE converted to constexpr UINT in both Page04 and Page05
- Build passes with no new warnings
- Constants remain usable as compile-time expressions
</success_criteria>

<output>
After completion, create `.planning/phases/22-sonarqube-macro-issues/22-02-SUMMARY.md`
</output>
