---
phase: 22-sonarqube-macro-issues
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - EIDCardLibrary/CContainer.cpp
  - EIDCardLibrary/EIDAuthenticateVersion.h
autonomous: true
requirements:
  - SONAR-02

must_haves:
  truths:
    - "Simple value macros are converted to constexpr with proper typing"
    - "Build passes with no new warnings"
    - "constexpr constants provide type safety while maintaining compile-time evaluation"
  artifacts:
    - path: "EIDCardLibrary/CContainer.cpp"
      provides: "REMOVALPOLICYKEY as static constexpr"
      contains: "static constexpr TCHAR REMOVALPOLICYKEY"
    - path: "EIDCardLibrary/EIDAuthenticateVersion.h"
      provides: "EIDAuthenticateVersionText as constexpr"
      contains: "constexpr.*EIDAuthenticateVersionText"
  key_links:
    - from: "macro definition"
      to: "constexpr variable"
      via: "type-safe constant conversion"
      pattern: "static constexpr.*=.*TEXT"
---

<objective>
Convert simple value macros to `constexpr` typed constants in EIDCardLibrary files where the macro does not depend on preprocessor-specific features.

Purpose: Replace type-unsafe preprocessor macros with type-safe `constexpr` constants. This improves type checking, debugger visibility, and maintains zero runtime overhead (safe for LSASS context). `constexpr` is purely compile-time.

Output: Two files with macros converted to constexpr:
- CContainer.cpp: REMOVALPOLICYKEY converted to static constexpr
- EIDAuthenticateVersion.h: EIDAuthenticateVersionText converted to constexpr
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-sonarqube-macro-issues/22-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert REMOVALPOLICYKEY macro to static constexpr in CContainer.cpp</name>
  <files>EIDCardLibrary/CContainer.cpp</files>
  <action>
Convert the REMOVALPOLICYKEY macro at line 34 from `#define` to `static constexpr`.

**Before (line 34):**
```cpp
#define REMOVALPOLICYKEY TEXT("SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Removal Policy")
```

**After:**
```cpp
static constexpr TCHAR REMOVALPOLICYKEY[] = TEXT("SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Removal Policy");
```

**Rationale:**
- Use `static constexpr` for file-scope constants to ensure internal linkage (no ODR violations)
- Use array syntax `TCHAR[]` instead of pointer `const TCHAR*` for string literals - this is more efficient and avoids potential lifetime issues
- The `TEXT()` macro is allowed here because it's evaluated at preprocessing time before the constexpr is compiled
- This constant is used with RegOpenKeyEx which accepts LPCTSTR, so TCHAR compatibility is maintained
  </action>
  <verify>Build the EIDCardLibrary project: `msbuild EIDCardLibrary/EIDCardLibrary.vcxproj /p:Configuration=Release /p:Platform=x64`</verify>
  <done>Line 34 contains `static constexpr TCHAR REMOVALPOLICYKEY[]` instead of `#define REMOVALPOLICYKEY`</done>
</task>

<task type="auto">
  <name>Task 2: Convert EIDAuthenticateVersionText macro to constexpr</name>
  <files>EIDCardLibrary/EIDAuthenticateVersion.h</files>
  <action>
Convert the EIDAuthenticateVersionText macro at line 4 from `#define` to `constexpr`.

**Before:**
```cpp
#define EIDAuthenticateVersionText "EIDAuthenticateVersionText_mytext"
```

**After:**
```cpp
constexpr const char* EIDAuthenticateVersionText = "EIDAuthenticateVersionText_mytext";
```

**Note about EIDAuthenticateVersionNumeric:**
The macro `#define EIDAuthenticateVersionNumeric 1.1.1.1` is NOT valid C++ syntax (the `1.1.1.1` with dots is not a valid numeric literal). This appears to be a placeholder or documentation macro. Leave it as-is since it cannot be converted to a standard C++ constant without understanding its actual usage. It may be processed by external tools or scripts.

**Rationale:**
- Use `constexpr const char*` for ASCII string constants in headers
- This is not TCHAR-based, so no TEXT() macro dependency
- Being in a header, this will be visible in every translation unit that includes it
  </action>
  <verify>Build the EIDCardLibrary project and verify no new warnings</verify>
  <done>Line 4 contains `constexpr const char* EIDAuthenticateVersionText` instead of `#define EIDAuthenticateVersionText`</done>
</task>

</tasks>

<verification>
1. Build EIDCardLibrary project succeeds with zero errors
2. No new compiler warnings introduced
3. Verify REMOVALPOLICYKEY conversion:
   - `grep -n "REMOVALPOLICYKEY" EIDCardLibrary/CContainer.cpp` should show `static constexpr TCHAR REMOVALPOLICYKEY[]`
   - `grep -n "#define REMOVALPOLICYKEY" EIDCardLibrary/CContainer.cpp` should return no matches
4. Verify EIDAuthenticateVersionText conversion:
   - `grep -n "EIDAuthenticateVersionText" EIDCardLibrary/EIDAuthenticateVersion.h` should show `constexpr const char*`
   - `grep -n "#define EIDAuthenticateVersionText" EIDCardLibrary/EIDAuthenticateVersion.h` should return no matches
5. Verify usage of converted constants still compiles (they're referenced in the codebase)
</verification>

<success_criteria>
- REMOVALPOLICYKEY converted to static constexpr TCHAR array
- EIDAuthenticateVersionText converted to constexpr const char*
- Build passes with no new warnings
- EIDAuthenticateVersionNumeric left as macro (invalid C++ literal syntax)
</success_criteria>

<output>
After completion, create `.planning/phases/22-sonarqube-macro-issues/22-01-SUMMARY.md`
</output>
