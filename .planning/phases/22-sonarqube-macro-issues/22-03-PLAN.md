---
phase: 22-sonarqube-macro-issues
plan: 03
type: execute
wave: 2
depends_on:
  - 22-01
  - 22-02
files_modified: []
autonomous: true
requirements:
  - SONAR-02

must_haves:
  truths:
    - "All 7 projects build successfully with macro conversions applied"
    - "No new compiler warnings introduced by constexpr conversions"
    - "Constants are usable in their original contexts (switch statements, array sizes, etc.)"
  artifacts:
    - path: "Build output"
      provides: "Clean build verification"
      contains: "0 Error.*0 Warning"
  key_links:
    - from: "constexpr constants"
      to: "original usage sites"
      via: "compile-time evaluation"
      pattern: "switch.*WM_MYMESSAGE|array.*BITLEN_TO_CHECK"
---

<objective>
Verify that all macro-to-constexpr conversions compile correctly and do not introduce any new warnings or errors.

Purpose: Final verification of Phase 22 changes. Confirm that the constexpr conversions maintain compile-time constant behavior and are usable in all original contexts (switch statements, array sizes, registry operations).

Output: Build verification confirming all changes work correctly.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-sonarqube-macro-issues/22-RESEARCH.md
@.planning/phases/22-sonarqube-macro-issues/22-01-SUMMARY.md
@.planning/phases/22-sonarqube-macro-issues/22-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build all 7 projects with macro conversions</name>
  <files>N/A (verification only)</files>
  <action>
Build all projects in the solution to verify the constexpr conversions work correctly across all translation units.

**Build command:**
```bash
msbuild EIDAuthentication.sln /t:Rebuild /p:Configuration=Release /p:Platform=x64 /m
```

**Projects to verify:**
1. EIDCardLibrary - Contains REMOVALPOLICYKEY, BITLEN_TO_CHECK, EIDAuthenticateVersionText changes
2. EIDConfigurationWizard - Contains WM_MYMESSAGE changes
3. EIDAuthenticationPackage - May reference EIDCardLibrary constants
4. EIDCredentialProvider - May reference EIDCardLibrary constants
5. EIDLogManager - Independent (no changes, but verify no side effects)
6. EIDPasswordChangeNotification - Independent (no changes, but verify no side effects)
7. NNLsp - Independent (no changes, but verify no side effects)

**Verification criteria:**
- Build completes with 0 errors
- No new warnings introduced (compare warning count to baseline)
- All constexpr constants are usable at their usage sites
  </action>
  <verify>Build output shows "0 Error(s)" and no new warnings</verify>
  <done>All 7 projects build successfully with zero errors and no new warnings</done>
</task>

<task type="auto">
  <name>Task 2: Verify constexpr usage in compile-time contexts</name>
  <files>N/A (verification only)</files>
  <action>
Verify that the converted constexpr constants are usable in their original compile-time contexts.

**Check 1: WM_MYMESSAGE in switch statements**
The WM_MYMESSAGE constants are used in switch case labels, which require compile-time constants:
```bash
grep -n "case WM_MYMESSAGE:" EIDConfigurationWizard/EIDConfigurationWizardPage04.cpp
grep -n "case WM_MYMESSAGE:" EIDConfigurationWizard/EIDConfigurationWizardPage05.cpp
```
If these compile without error, the constexpr conversion is correct.

**Check 2: BITLEN_TO_CHECK in array sizes**
The BITLEN_TO_CHECK constant is used for array size declarations:
```bash
grep -n "BITLEN_TO_CHECK/8\|BITLEN_TO_CHECK/16" EIDCardLibrary/CertificateUtilities.cpp
```
These must compile as array size expressions, confirming constexpr behavior.

**Check 3: REMOVALPOLICYKEY with RegOpenKeyEx**
Verify the constexpr TCHAR array is usable with Windows registry API:
```bash
grep -n "REMOVALPOLICYKEY" EIDCardLibrary/CContainer.cpp
```
Should show both the definition and usage with RegOpenKeyEx.

**Check 4: EIDAuthenticateVersionText usage**
Check if this constant is actually used in the codebase:
```bash
grep -rn "EIDAuthenticateVersionText" EIDCardLibrary/
```
If no usage is found, it may be a placeholder for version information.
  </action>
  <verify>All grep commands show expected usage patterns; build succeeded confirms compile-time usability</verify>
  <done>All constexpr constants verified usable in their original contexts</done>
</task>

<task type="auto">
  <name>Task 3: Document remaining won't-fix macros</name>
  <files>N/A (documentation)</files>
  <action>
Document the macro categories that remain as `#define` with justifications.

**Won't Fix Categories:**

1. **Windows Header Configuration Macros** (~25 occurrences)
   - `WIN32_NO_STATUS` - Controls ntstatus.h inclusion behavior
   - `SECURITY_WIN32` - Controls sspi.h behavior
   - `_CRTDBG_MAP_ALLOC` - Configures CRT debug allocation
   - `_SEC_WINNT_AUTH_TYPES` - Controls security auth type definitions
   - These MUST remain as macros; they configure Windows SDK header behavior before includes

2. **Function-Like Macros with Preprocessor Features** (~10 occurrences)
   - `EIDCardLibraryTrace(...)` - Uses `__FILE__`, `__LINE__`, `__VA_ARGS__`
   - `EIDAlloc(...)`, `EIDFree(...)` - Uses `__FILE__`, `__LINE__`, `__FUNCTION__`
   - `CHECK_DWORD(...)`, `CHECK_BOOL(...)`, `CHECK_ALLOC(...)` - Uses token stringification
   - `ERRORTOTEXT(ERROR)` - Uses `#ERROR` stringification and `##` token pasting
   - `MYMACRO(...)` in CompleteProfile.cpp - Complex macro with multiple statements
   - These use preprocessor-only features with no C++ equivalent

3. **Resource ID Macros** (~50 occurrences)
   - `IDD_*`, `IDC_*`, `IDS_*`, `IDB_*` in resource.h files
   - `_APS_NEXT_*` values in resource.h
   - Resource compiler (.rc files) requires `#define`, not C++ constants

4. **TCHAR-Dependent Macros** (~1 occurrence)
   - `AUTHENTICATIONPACKAGENAMET` - Uses `TEXT()` macro for TCHAR compatibility
   - Must remain as macro to support TEXT() expansion

5. **Include Guards** (~10 occurrences)
   - `#ifndef __HEADER_H__` / `#define __HEADER_H__` / `#endif`
   - Standard C++ header protection pattern

6. **Windows SDK Macros** (~60 occurrences in include/cardmod.h)
   - `MAX_CONTAINER_NAME_LEN`, `MAX_PINS`, etc. in cardmod.h
   - This is a Windows SDK header file - do not modify

**Total Won't Fix: ~91+ macros**

This documentation will be referenced in Phase 30 (Final SonarQube Scan) for issue resolution notes.
  </action>
  <verify>Summary captured for Phase 30 reference</verify>
  <done>Won't-fix macro categories documented with justifications</done>
</task>

</tasks>

<verification>
1. Full solution build succeeds with zero errors
2. No new compiler warnings introduced
3. All converted constexpr constants verified usable in original contexts
4. Won't-fix macro categories documented with clear justifications
5. Phase 22 conversions complete:
   - REMOVALPOLICYKEY: macro -> static constexpr TCHAR[]
   - EIDAuthenticateVersionText: macro -> constexpr const char*
   - BITLEN_TO_CHECK: macro -> static constexpr DWORD
   - WM_MYMESSAGE (Page04): macro -> constexpr UINT
   - WM_MYMESSAGE (Page05): macro -> constexpr UINT
</verification>

<success_criteria>
- All 7 projects build successfully
- 5 macros converted to constexpr across 4 files
- No new warnings
- Won't-fix categories documented for SonarQube resolution
</success_criteria>

<output>
After completion, create `.planning/phases/22-sonarqube-macro-issues/22-03-SUMMARY.md`
</output>
