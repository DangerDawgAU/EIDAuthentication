---
phase: 07-security-reliability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - EIDCardLibrary/CompleteToken.cpp
  - EIDConfigurationWizard/EIDConfigurationWizardPage05.cpp
autonomous: true

must_haves:
  truths:
    - "Type punning uses std::bit_cast instead of unions"
    - "No unreachable code remains in switch statements"
    - "Code compiles successfully with C++23"
  artifacts:
    - path: "EIDCardLibrary/CompleteToken.cpp"
      provides: "Token creation for LSA authentication"
      contains: "CheckAuthorizationInternal"
    - path: "EIDConfigurationWizard/EIDConfigurationWizardPage05.cpp"
      provides: "Wizard password page dialog"
      contains: "WndProc_05PASSWORD"
  key_links:
    - from: "CompleteToken.cpp::CheckAuthorizationInternal"
      to: "FILETIME/LARGE_INTEGER"
      via: "type punning via union"
      pattern: "ExpirationTime\\.(Low|High)Part = FileTime\\.(dwLow|dwHigh)DateTime"
    - from: "EIDConfigurationWizardPage05.cpp::WndProc_05PASSWORD"
      to: "switch statement"
      via: "WM_MYMESSAGE case"
      pattern: "case WM_MYMESSAGE:.*return TRUE;.*break;"
---

<objective>
Fix SonarQube reliability bugs - type punning through unions (cpp:S3624) and unreachable break statement (cpp:S128).

Purpose: Use C++23 compliant type punning with std::bit_cast and remove dead code.
Output: Modified files with proper type conversion and no unreachable code.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

## Issue Details

### Issue 1: CompleteToken.cpp lines 417-418 (Reliability Bug)

**Location:** `EIDCardLibrary/CompleteToken.cpp` lines 417-418
**Rule:** cpp:S3624 - Type punning should not be done through unions
**Current code:**
```cpp
SystemTimeToFileTime(&SystemTime, &FileTime);
ExpirationTime.LowPart = FileTime.dwLowDateTime;    // Line 417 - type punning
ExpirationTime.HighPart = FileTime.dwHighDateTime;  // Line 418 - type punning
ExpirationTime.QuadPart += Hour.QuadPart * dwHours;
```

**Analysis:** The code is using LARGE_INTEGER and FILETIME which are both 64-bit structures representing a 64-bit value split into high/low parts. This is technically type punning through union members.

**C++23 Solution:** Use `std::bit_cast` to safely reinterpret the bits between types. However, FILETIME and LARGE_INTEGER have different structures:
- FILETIME: `{ dwLowDateTime, dwHighDateTime }`
- LARGE_INTEGER: `{ LowPart, HighPart, QuadPart }` (union)

The correct fix is to use `std::bit_cast<std::int64_t>` to extract the 64-bit value, since both represent the same underlying 64-bit integer:

```cpp
ExpirationTime.QuadPart = std::bit_cast<std::int64_t>(FileTime);
```

Or more explicitly:
```cpp
auto fileTimeInt = std::bit_cast<std::int64_t>(FileTime);
ExpirationTime.QuadPart = fileTimeInt;
```

This requires `#include <bit>` which should already be available with C++23.

### Issue 2: EIDConfigurationWizardPage05.cpp line 104 (Reliability Bug)

**Location:** `EIDConfigurationWizard/EIDConfigurationWizardPage05.cpp` line 104
**Rule:** cpp:S128 - Switch case clauses should not have fall-through to unreachable code
**Current code:**
```cpp
case WM_MYMESSAGE:
    if (fHasDeselected)
    {
        ListView_SetItemState(GetDlgItem(hWnd,IDC_05LIST), dwCurrentCredential, LVIS_SELECTED | LVIS_FOCUSED, LVIS_SELECTED | LVIS_FOCUSED);
        ListView_Update(GetDlgItem(hWnd,IDC_05LIST), dwCurrentCredential);
    }
    return TRUE;
    break;   // Line 104 - unreachable after return
```

**Analysis:** The `break` statement after `return TRUE` is never executed, making it unreachable dead code.

**Fix:** Simply remove the unreachable `break` statement.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix type punning in CompleteToken.cpp</name>
  <files>EIDCardLibrary/CompleteToken.cpp</files>
  <action>
    In the `CheckAuthorizationInternal` function (around lines 415-419):

    1. First, verify `#include <bit>` is present at the top of the file. If not, add it.

    2. Change the current type punning code:
    ```cpp
    SystemTimeToFileTime(&SystemTime, &FileTime);
    ExpirationTime.LowPart = FileTime.dwLowDateTime;
    ExpirationTime.HighPart = FileTime.dwHighDateTime;
    ExpirationTime.QuadPart += Hour.QuadPart * dwHours;
    ```

    To use std::bit_cast:
    ```cpp
    SystemTimeToFileTime(&SystemTime, &FileTime);
    // Use std::bit_cast for type-safe conversion between FILETIME and 64-bit integer
    ExpirationTime.QuadPart = std::bit_cast<std::int64_t>(FileTime);
    ExpirationTime.QuadPart += Hour.QuadPart * dwHours;
    ```

    **Important:** `std::bit_cast` requires the source and destination types to have the same size and be trivially copyable. FILETIME is 8 bytes (2 x DWORD), and int64_t is 8 bytes, so this is safe.

    The `<bit>` header is part of C++20 and is available with `/std:c++23preview`.
  </action>
  <verify>
    Build EIDCardLibrary project and verify no compiler errors:
    ```
    msbuild EIDCardLibrary/EIDCardLibrary.vcxproj /p:Configuration=Release /p:Platform=x64 /t:Build
    ```
  </verify>
  <done>
    Type punning uses `std::bit_cast<std::int64_t>` instead of union member access, addressing cpp:S3624.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove unreachable break in EIDConfigurationWizardPage05.cpp</name>
  <files>EIDConfigurationWizard/EIDConfigurationWizardPage05.cpp</files>
  <action>
    In the `WndProc_05PASSWORD` function, find the WM_MYMESSAGE case (around lines 97-104):

    Change:
    ```cpp
    case WM_MYMESSAGE:
        if (fHasDeselected)
        {
            ListView_SetItemState(GetDlgItem(hWnd,IDC_05LIST), dwCurrentCredential, LVIS_SELECTED | LVIS_FOCUSED, LVIS_SELECTED | LVIS_FOCUSED);
            ListView_Update(GetDlgItem(hWnd,IDC_05LIST), dwCurrentCredential);
        }
        return TRUE;
        break;
    ```

    To:
    ```cpp
    case WM_MYMESSAGE:
        if (fHasDeselected)
        {
            ListView_SetItemState(GetDlgItem(hWnd,IDC_05LIST), dwCurrentCredential, LVIS_SELECTED | LVIS_FOCUSED, LVIS_SELECTED | LVIS_FOCUSED);
            ListView_Update(GetDlgItem(hWnd,IDC_05LIST), dwCurrentCredential);
        }
        return TRUE;
    ```

    Simply delete the `break;` statement on line 104.
  </action>
  <verify>
    Build EIDConfigurationWizard project and verify no compiler errors:
    ```
    msbuild EIDConfigurationWizard/EIDConfigurationWizard.vcxproj /p:Configuration=Release /p:Platform=x64 /t:Build
    ```
  </verify>
  <done>
    Unreachable `break` statement removed, addressing cpp:S128.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Build the full solution:
   ```
   msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:Build
   ```

2. Verify no new compiler warnings introduced.

3. Mark SonarQube reliability bugs as resolved:
   - CompleteToken.cpp lines 417-418: Fixed by using std::bit_cast
   - EIDConfigurationWizardPage05.cpp line 104: Fixed by removing unreachable break
</verification>

<success_criteria>
1. CompleteToken.cpp uses `std::bit_cast` for FILETIME to int64_t conversion
2. EIDConfigurationWizardPage05.cpp has no unreachable break statement
3. Both files compile without errors
4. No new compiler warnings introduced
5. SonarQube reliability bugs cpp:S3624 and cpp:S128 can be marked as resolved
</success_criteria>

<output>
After completion, create `.planning/phases/07-security-reliability/07-02-SUMMARY.md`
</output>
