---
phase: 32-auto-conversion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - EIDCredentialProvider/helpers.cpp
  - EIDCredentialProvider/Dll.cpp
  - EIDCredentialProvider/CMessageCredential.cpp
  - EIDCredentialProvider/CEIDProvider.cpp
  - EIDCardLibrary/CSmartCardNotifier.cpp
  - EIDCardLibrary/CertificateValidation.cpp
  - EIDCardLibrary/CContainerHolderFactory.cpp
  - EIDCardLibrary/CredentialManagement.cpp
  - EIDCardLibrary/StoredCredentialManagement.cpp
  - EIDCardLibrary/ErrorHandling.cpp
autonomous: true
requirements:
  - AUTO-01
  - AUTO-02

must_haves:
  truths:
    - "Iterator declarations use auto (e.g., auto it = map.begin())"
    - "New object declarations use auto when type is obvious (e.g., auto p = new Type())"
    - "Security-critical types remain explicit for clarity (HRESULT, NTSTATUS, HANDLE)"
    - "Build passes with zero errors after conversions"
  artifacts:
    - path: "EIDCredentialProvider/helpers.cpp"
      provides: "Auto conversions for credential provider helpers"
      pattern: "auto.*=.*CoTaskMemAlloc|auto.*=.*new"
    - path: "EIDCredentialProvider/Dll.cpp"
      provides: "Auto conversions for class factory"
      pattern: "auto.*=.*new"
    - path: "EIDCardLibrary/CSmartCardNotifier.cpp"
      provides: "Auto conversions for notifier callbacks"
      pattern: "auto.*=.*static_cast"
  key_links:
    - from: "Source files"
      to: "Build output"
      via: "MSBuild compilation"
      pattern: "zero errors, zero new warnings"
---

<objective>
Convert redundant type declarations to auto where the type is obvious from the initializer, improving code maintainability while preserving explicit types for security-critical values.

Purpose: Reduce visual noise and improve maintainability by using auto for obvious types. Keep security-critical types explicit for code review clarity.
Output: Modified source files with appropriate auto conversions, build verification confirming no regressions.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@sonarqube_issues/README.md

## Won't-Fix Categories (Security-Critical Explicit Types)

The following types MUST remain explicit for security clarity in code reviews:

| Type | Reason | Example |
|------|--------|---------|
| HRESULT | Windows API return status, critical for error handling | HRESULT hr = SomeAPICall(); |
| NTSTATUS | LSA/Kernel return status, security-critical | NTSTATUS Status = LsaLogonUser(...); |
| HANDLE | Windows handles, null checks critical | HANDLE hToken = NULL; |
| BOOL | Windows boolean, distinct from bool | BOOL fReturn = FALSE; |
| DWORD | Windows unsigned, often from API | DWORD dwError = GetLastError(); |
| LONG | Registry return values | LONG lStatus = RegOpenKey(...); |
| ULONG | LSA/API parameters | ULONG CredSize = 0; |

## Fixable Patterns (Convert to Auto)

1. **Iterator declarations:**
   - `auto it = container.begin()` - type is obvious from container
   - Already partially implemented in CContainerHolderFactory.cpp

2. **New object declarations:**
   - `auto pProvider = new CEIDProvider()` - type is obvious from new
   - `auto pcf = new CClassFactory` - type is obvious from new

3. **static_cast results:**
   - `auto pNotifier = static_cast<CSmartCardConnectionNotifier*>(lpParameter)` - type is in cast
   - `auto pcpfd = static_cast<CREDENTIAL_PROVIDER_FIELD_DESCRIPTOR*>(ptr)` - type is in cast

4. **CoTaskMemAlloc results:**
   - `auto pcpfd = static_cast<CREDENTIAL_PROVIDER_FIELD_DESCRIPTOR*>(CoTaskMemAlloc(cbStruct))` - type is in cast

## Current Auto Usage (Already Converted)

The codebase already has some auto usage:
- CContainerHolderFactory.cpp: `auto l_iter = _CredentialList.begin();`
- These patterns should be preserved and extended.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert new object declarations to auto</name>
  <files>
    EIDCredentialProvider/Dll.cpp,
    EIDCredentialProvider/CEIDProvider.cpp,
    EIDCredentialProvider/CMessageCredential.cpp,
    EIDCredentialProvider/helpers.cpp
  </files>
  <action>
    Convert redundant type declarations to auto where the type is obvious from the initializer:

    **Patterns to convert:**
    1. `Type* ptr = new Type()` to `auto ptr = new Type()`
    2. `Type* ptr = static_cast<Type*>(expr)` to `auto ptr = static_cast<Type*>(expr)`
    3. `Type* ptr = (Type*)CoTaskMemAlloc(...)` after adding static_cast, then use auto

    **Files and specific locations:**

    **Dll.cpp line ~134:**
    ```cpp
    // Before:
    CClassFactory* pcf = new CClassFactory;
    // After:
    auto pcf = new CClassFactory;
    ```

    **CEIDProvider.cpp line ~498:**
    ```cpp
    // Before:
    CEIDProvider* pProvider = new CEIDProvider();
    // After:
    auto pProvider = new CEIDProvider();
    ```

    **helpers.cpp line ~64:**
    ```cpp
    // Before:
    CREDENTIAL_PROVIDER_FIELD_DESCRIPTOR* pcpfd =
        (CREDENTIAL_PROVIDER_FIELD_DESCRIPTOR*)CoTaskMemAlloc(cbStruct);
    // After (first add static_cast, then auto):
    auto pcpfd = static_cast<CREDENTIAL_PROVIDER_FIELD_DESCRIPTOR*>(CoTaskMemAlloc(cbStruct));
    ```

    **CMessageCredential.cpp line ~202:**
    ```cpp
    // Before:
    PWSTR Message = (PWSTR) CoTaskMemAlloc(dwMessageLen*sizeof(WCHAR));
    // After:
    auto Message = static_cast<PWSTR>(CoTaskMemAlloc(dwMessageLen*sizeof(WCHAR)));
    ```

    **CEIDProvider.cpp line ~345:**
    ```cpp
    // Before:
    PWSTR Message = (PWSTR) CoTaskMemAlloc(dwMessageLen*sizeof(WCHAR));
    // After:
    auto Message = static_cast<PWSTR>(CoTaskMemAlloc(dwMessageLen*sizeof(WCHAR)));
    ```

    **IMPORTANT - DO NOT convert these (security-critical explicit types):**
    - HRESULT hr = ... (keep explicit for error handling clarity)
    - NTSTATUS Status = ... (keep explicit for LSA security)
    - HANDLE hToken = ... (keep explicit for handle safety)
    - BOOL fReturn = ... (keep explicit for Windows API)
    - DWORD dwError = ... (keep explicit for GetLastError)
  </action>
  <verify>
    Build the solution and verify zero compilation errors:
    ```
    msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:Build /v:minimal
    ```
    Confirm no new warnings introduced.
  </verify>
  <done>
    - All new object declarations converted to auto where type is obvious
    - All static_cast results converted to auto
    - All CoTaskMemAlloc results converted to auto (after adding static_cast)
    - Security-critical types (HRESULT, NTSTATUS, HANDLE, BOOL, DWORD) remain explicit
    - Build passes with zero errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert iterator declarations to auto</name>
  <files>
    EIDCardLibrary/CContainerHolderFactory.cpp,
    EIDCardLibrary/CredentialManagement.cpp
  </files>
  <action>
    Convert iterator declarations to auto where the type is obvious from begin()/end() calls.

    **Note:** Some iterator declarations already use auto (CContainerHolderFactory.cpp). Verify these are consistent and convert any remaining explicit iterator types.

    **Patterns to convert:**
    1. `std::map<K,V>::iterator it = map.begin()` to `auto it = map.begin()`
    2. `std::vector<T>::iterator it = vec.begin()` to `auto it = vec.begin()`
    3. `std::unordered_map<K,V>::iterator it = map.find(key)` to `auto it = map.find(key)`

    **Files to check:**
    - CredentialManagement.cpp - check UserModeContexts iterator usage
    - CContainerHolderFactory.cpp - verify _CredentialList iterator usage (may already be auto)

    **Already converted (verify remains):**
    ```cpp
    // CContainerHolderFactory.cpp line ~374
    auto l_iter = _CredentialList.begin();  // Already correct
    ```

    **DO NOT convert:**
    - Iterators where the type is not obvious from the initializer
    - Iterators used in complex template contexts where auto would reduce clarity
  </action>
  <verify>
    Build the solution and verify zero compilation errors:
    ```
    msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:Build /v:minimal
    ```
  </verify>
  <done>
    - All iterator declarations use auto where type is obvious from begin()/end()
    - Build passes with zero errors
    - No new warnings introduced
  </done>
</task>

<task type="auto">
  <name>Task 3: Convert static_cast pointer results to auto</name>
  <files>
    EIDCardLibrary/CSmartCardNotifier.cpp,
    EIDCardLibrary/CertificateValidation.cpp
  </files>
  <action>
    Convert pointer declarations that use static_cast to auto where the cast makes the type obvious.

    **CSmartCardNotifier.cpp line ~130:**
    ```cpp
    // Before:
    CSmartCardConnectionNotifier *pSmartCardConnectionNotifier = static_cast<CSmartCardConnectionNotifier *>(lpParameter);
    // After:
    auto pSmartCardConnectionNotifier = static_cast<CSmartCardConnectionNotifier*>(lpParameter);
    ```

    **CertificateValidation.cpp line ~237:**
    ```cpp
    // Before:
    PCERT_ENHKEY_USAGE pCertUsage = static_cast<PCERT_ENHKEY_USAGE>(EIDAlloc(dwSize));
    // After:
    auto pCertUsage = static_cast<PCERT_ENHKEY_USAGE>(EIDAlloc(dwSize));
    ```

    **IMPORTANT - DO NOT convert:**
    - Casts that remove const (keep type explicit for safety review)
    - Casts in security-sensitive contexts where type clarity aids review
    - HRESULT/NTSTATUS/DWORD casts (these should remain explicit)
  </action>
  <verify>
    Build the solution and verify zero compilation errors:
    ```
    msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:Build /v:minimal
    ```
  </verify>
  <done>
    - All static_cast pointer results converted to auto
    - Build passes with zero errors
    - No new warnings introduced
  </done>
</task>

<task type="auto">
  <name>Task 4: Final build verification</name>
  <files>
    (build verification only - no source changes)
  </files>
  <action>
    Perform final build verification to ensure all auto conversions are correct:

    1. Clean build:
       ```
       msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:Rebuild /v:minimal
       ```

    2. Verify build output:
       - Zero errors
       - No new warnings compared to baseline
       - All 7 projects build successfully

    3. Verify auto conversions are semantically correct:
       - All auto declarations compile without type deduction errors
       - No narrowing conversions introduced
       - No const-correctness violations

    4. Document won't-fix categories in code comments if needed:
       - Add inline comments for security-critical explicit types if SonarQube flags them
       - Example: `HRESULT hr; // Keep explicit for error handling clarity`
  </action>
  <verify>
    Full rebuild completes with zero errors:
    ```
    msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:Rebuild
    ```
    Output should show: "Build succeeded. 0 Error(s)"
  </verify>
  <done>
    - All 7 projects build successfully with zero errors
    - No new warnings introduced
    - All auto conversions compile correctly
    - Won't-fix categories documented
  </done>
</task>

</tasks>

<verification>
## Phase Verification Checklist

- [ ] All new object declarations (`new Type()`) converted to auto
- [ ] All iterator declarations (`.begin()`, `.end()`) converted to auto
- [ ] All static_cast pointer results converted to auto
- [ ] All CoTaskMemAlloc results converted to auto (after adding static_cast)
- [ ] Security-critical types remain explicit (HRESULT, NTSTATUS, HANDLE, BOOL, DWORD, LONG, ULONG)
- [ ] Build passes with zero errors
- [ ] No new warnings introduced
</verification>

<success_criteria>
1. Iterator declarations converted to auto (e.g., `auto it = map.begin()`) - COMPLETED
2. New object declarations converted to auto (e.g., `auto ptr = new Type()`) - COMPLETED
3. Security-critical types (HRESULT, NTSTATUS, handles) kept explicit - COMPLETED
4. Build passes with zero errors after auto conversions - COMPLETED
</success_criteria>

<output>
After completion, create `.planning/phases/32-auto-conversion/32-01-SUMMARY.md`
</output>
