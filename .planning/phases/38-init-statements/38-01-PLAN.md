---
phase: 38-init-statements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
requirements: [MODERN-01]
user_setup: []

must_haves:
  truths:
    - "Variable declarations are scoped to if/switch blocks using init-statements"
    - "Iterator scope is limited using if-init pattern for map/set operations"
    - "Build passes with zero errors after all init-statement conversions"
  artifacts:
    - path: "EIDCredentialProvider/helpers.cpp"
      provides: "Credential protection helper with scoped variables"
      pattern: "if \\(.*=.*\\)"
    - path: "EIDCredentialProvider/CEIDProvider.cpp"
      provides: "Credential provider factory with scoped allocations"
      pattern: "if \\(auto.*=.*new\\)"
    - path: "EIDCredentialProvider/CEIDCredential.cpp"
      provides: "Credential serialization with scoped variables"
      pattern: "if \\(.*=.*\\)"
    - path: "EIDCredentialProvider/CEIDFilter.h"
      provides: "Filter factory with scoped allocations"
      pattern: "if \\(auto.*=.*new\\)"
    - path: "EIDCardLibrary/CredentialManagement.cpp"
      provides: "Context management with scoped iterators"
      pattern: "if \\(auto it = .*\\.find\\(\\)"
    - path: "EIDCardLibrary/CertificateValidation.cpp"
      provides: "Certificate validation with scoped variables"
      pattern: "if \\(.*=.*\\)"
    - path: "EIDCardLibrary/CContainerHolderFactory.cpp"
      provides: "Container factory with scoped buffers"
      pattern: "if \\(.*=.*\\)"
  key_links:
    - from: "helpers.cpp"
      to: "if-init pattern"
      via: "allocation + null check conversion"
      pattern: "PWSTR.*=.*CoTaskMemAlloc.*if"
    - from: "CredentialManagement.cpp"
      to: "if-init pattern"
      via: "iterator + end check conversion"
      pattern: "auto it = .*\\.find.*if.*== .*\\.end"
---

<objective>
Convert ~49 init-statement opportunities across the codebase to use C++17 if/switch init-statements, limiting variable scope to the block where they are used.

Purpose: Improve code clarity by scoping variables to their usage blocks, reducing namespace pollution and making the intent clearer.
Output: Modified .cpp/.h files with init-statement conversions, zero build errors.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
<name>Task 1: Convert EIDCredentialProvider init-statements</name>
<files>
EIDCredentialProvider/helpers.cpp
EIDCredentialProvider/CEIDProvider.cpp
EIDCredentialProvider/CEIDCredential.cpp
EIDCredentialProvider/CMessageCredential.cpp
EIDCredentialProvider/CEIDFilter.h
</files>
<action>
Convert the following init-statement patterns in the EIDCredentialProvider project:

**Pattern 1 - Allocation + null check (CEIDProvider.cpp:498-500, CEIDFilter.h:71-73):**
```cpp
// Before:
CEIDProvider* pProvider = new CEIDProvider();
if (pProvider)

// After:
if (CEIDProvider* pProvider = new CEIDProvider())
```

**Pattern 2 - API result + condition (helpers.cpp:144, 209, 298-299):**
- Line 144: `PWSTR pwzProtected = s_wszEmpty;` before `if (!CredProtectW(...))` - the pwzProtected is used AFTER the if block, do NOT convert (variable needs outer scope)
- Line 204-209: `CRED_PROTECTION_TYPE protectionType;` before `if(CredIsProtectedW(...))` - the protectionType is used AFTER the if block for comparison, do NOT convert (variable needs outer scope)
- Line 298-299: `LITEM item = pNMLink->item;` before `if (wcscmp(item.szID, ...))` - can convert since item is only used within the if block:
```cpp
// Convert:
LITEM item = pNMLink->item;
if (wcscmp(item.szID, L"idinfo") == 0)
// To:
if (LITEM item = pNMLink->item; wcscmp(item.szID, L"idinfo") == 0)
```

**Pattern 3 - Message allocation (CMessageCredential.cpp:202-203, CEIDProvider.cpp:345-346):**
```cpp
// Before:
PWSTR Message = (PWSTR) CoTaskMemAlloc(dwMessageLen*sizeof(WCHAR));
if (Message)

// After:
if (PWSTR Message = (PWSTR) CoTaskMemAlloc(dwMessageLen*sizeof(WCHAR)))
```

**Pattern 4 - Computer name + check (CEIDCredential.cpp:543-544):**
- Line 543: `DWORD cch = ARRAYSIZE(wsz);` before `if (GetComputerNameW(wsz, &cch))` - cch is modified by GetComputerNameW, keep separate but wsz/cch are only used in this block, evaluate carefully. The wsz and cch are used ONLY in this if block's success path, but cch must be declared before the call as it's passed by address. Do NOT convert - requires pointer argument.

**IMPORTANT CONSTRAINTS:**
1. Do NOT convert if the variable is used AFTER the if/switch block (outer scope needed)
2. Do NOT convert if the variable address is taken (passed by pointer/ref to the condition function)
3. Do NOT convert HRESULT/NTSTATUS declarations - these should remain explicit for security clarity (documented as won't-fix per PROJECT.md)
4. For switch init-statements, use: `switch (Type var = init(); var)`

Document any conversions that are skipped due to these constraints in code comments.
</action>
<verify>
1. Build EIDCredentialProvider project: `msbuild EIDCredentialProvider\EIDCredentialProvider.vcxproj /p:Configuration=Release /p:Platform=x64`
2. Verify no new compiler errors
3. Review each conversion to ensure variable scope is correct
</verify>
<done>
EIDCredentialProvider files have init-statement conversions applied where scope permits, build passes with zero errors.
</done>
</task>

<task type="auto">
<name>Task 2: Convert EIDCardLibrary init-statements</name>
<files>
EIDCardLibrary/CredentialManagement.cpp
EIDCardLibrary/CertificateValidation.cpp
EIDCardLibrary/CContainerHolderFactory.cpp
</files>
<action>
Convert the following init-statement patterns in the EIDCardLibrary project:

**Pattern 1 - Iterator find (CredentialManagement.cpp:589-590, 618-619):**
```cpp
// Before:
auto it = UserModeContexts.find(pHandle);
if (it == UserModeContexts.end())

// After:
if (auto it = UserModeContexts.find(pHandle); it != UserModeContexts.end())
```
Note: Invert the condition logic since we want to continue if found (not if not found).

**Pattern 2 - Header size check (CertificateValidation.cpp:69-70):**
```cpp
// Before:
DWORD dwHeaderSize = FIELD_OFFSET(EID_SMARTCARD_CSP_INFO, bBuffer);
if (pCspInfo->dwCspInfoLen < dwHeaderSize || ...)

// After:
if (DWORD dwHeaderSize = FIELD_OFFSET(EID_SMARTCARD_CSP_INFO, bBuffer);
    pCspInfo->dwCspInfoLen < dwHeaderSize || ...)
```
However, dwHeaderSize is used in lines 71-72 AFTER the condition check. Do NOT convert - variable needs outer scope for subsequent checks.

**Pattern 3 - Chain flags (CertificateValidation.cpp:339-341):**
```cpp
// Before:
DWORD dwChainFlags = CERT_CHAIN_ENABLE_PEER_TRUST;
if(!CertGetCertificateChain(..., dwChainFlags, ...))
```
dwChainFlags is passed BY VALUE to the function, so it CAN be in the init-statement. However, it's used only as a parameter, not in the condition itself. Evaluate: The pattern is `init; if(func(init))` - the variable is used within the if condition's function call. Convert:
```cpp
if (DWORD dwChainFlags = CERT_CHAIN_ENABLE_PEER_TRUST;
    !CertGetCertificateChain(hChainEngine, pCertContext, nullptr, nullptr, &params.ChainPara, dwChainFlags, nullptr, &pChainContext))
```

**Pattern 4 - Data buffer size (CContainerHolderFactory.cpp:180-181, 217-218):**
```cpp
// Before:
DWORD DataSize = 4096;
if (CryptGetKeyParam(hKey, KP_CERTIFICATE, Data, &DataSize, 0))
```
DataSize is passed BY ADDRESS (&DataSize), so it must be declared before the call. Do NOT convert.

**IMPORTANT CONSTRAINTS:**
1. Variables passed by address/ref to the condition function must NOT be converted
2. Variables used after the if block must NOT be converted
3. Iterator patterns with `!= end()` check can be converted by inverting logic

Document any conversions that are skipped due to these constraints in code comments.
</action>
<verify>
1. Build EIDCardLibrary project: `msbuild EIDCardLibrary\EIDCardLibrary.vcxproj /p:Configuration=Release /p:Platform=x64`
2. Verify no new compiler errors
3. Verify iterator find patterns still work correctly (no regression in context management)
</verify>
<done>
EIDCardLibrary files have init-statement conversions applied where scope permits, build passes with zero errors.
</done>
</task>

<task type="auto">
<name>Task 3: Convert EIDConfigurationWizard init-statements</name>
<files>
EIDConfigurationWizard/EIDConfigurationWizardPage03.cpp
</files>
<action>
Convert init-statement patterns in EIDConfigurationWizard files:

**Pattern - GetLastError result (EIDConfigurationWizardPage03.cpp lines 208, 234, 263):**
These are likely patterns like:
```cpp
DWORD dwError = GetLastError();
if (dwError != ERROR_SUCCESS)
```

Analyze each occurrence:
1. If dwError is used ONLY within the if block, convert
2. If dwError is used after the if block, do NOT convert
3. If dwError is used in a switch statement, consider `switch (DWORD dwError = GetLastError(); dwError)`

For each conversion, ensure the variable's lifetime is correctly scoped.

**IMPORTANT:** Read the actual file at the specified lines to determine exact patterns before converting.
</action>
<verify>
1. Build EIDConfigurationWizard project: `msbuild EIDConfigurationWizard\EIDConfigurationWizard.vcxproj /p:Configuration=Release /p:Platform=x64`
2. Verify no new compiler errors
</verify>
<done>
EIDConfigurationWizard files have init-statement conversions applied where scope permits, build passes with zero errors.
</done>
</task>

<task type="auto">
<name>Task 4: Full solution build verification</name>
<files>
</files>
<action>
After all init-statement conversions are complete, perform a full solution build to ensure no regressions:

1. Clean and rebuild all projects:
   ```
   msbuild EIDAuthentication.sln /t:Clean /p:Configuration=Release /p:Platform=x64
   msbuild EIDAuthentication.sln /t:Build /p:Configuration=Release /p:Platform=x64
   ```

2. Verify zero errors across all 7 projects:
   - EIDAuthenticationPackage
   - EIDCardLibrary
   - EIDConfigurationWizard
   - EIDConfigurationWizardElevated
   - EIDCredentialProvider
   - EIDLogManager
   - EIDPasswordChangeNotification

3. Count and report the number of init-statement conversions made vs. skipped with justification.

4. Verify no runtime-critical behavior changes (init-statements are purely syntactic, but verify iterator logic inversions are correct).
</action>
<verify>
1. `msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64` returns exit code 0
2. No compiler errors in build output
3. List of conversions made documented
</verify>
<done>
All 7 projects build successfully with zero errors. Init-statement conversions complete and verified.
</done>
</task>

</tasks>

<verification>
1. Full solution build passes with zero errors
2. No new compiler warnings introduced
3. Iterator find patterns still work correctly (inverted logic verified)
4. Variables requiring outer scope are correctly identified and NOT converted
5. Count of conversions documented (targeting ~30-40 of the ~49 opportunities)
</verification>

<success_criteria>
1. Variable declarations scoped to if/switch blocks using init-statements where possible
2. Iterator scope limited using if-init pattern for map/set operations
3. Build passes with zero errors after init-statement additions
4. Documented list of conversions made and skipped with justifications
</success_criteria>

<output>
After completion, create `.planning/phases/38-init-statements/38-01-SUMMARY.md`
</output>
