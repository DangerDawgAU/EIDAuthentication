---
phase: 16-const-correctness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - EIDConfigurationWizard/global.h
  - EIDConfigurationWizard/EIDConfigurationWizardPage05.cpp
  - EIDCardLibrary/CertificateUtilities.cpp
  - EIDCardLibrary/Tracing.cpp
  - EIDCardLibrary/Package.cpp
  - EIDCredentialProvider/CEIDCredential.cpp
  - EIDCredentialProvider/common.h
  - EIDAuthenticationPackage/EIDSecuritySupportProvider.cpp
  - EIDAuthenticationPackage/EIDAuthenticationPackage.cpp
  - EIDLogManager/EIDLogManager.cpp
autonomous: true
requirements:
  - CONST-01

must_haves:
  truths:
    - "Global variables that are never modified are marked const"
    - "Code compiles successfully after const additions"
    - "No new compiler warnings from const changes"
  artifacts:
    - path: "EIDConfigurationWizard/global.h"
      provides: "Global variable declarations with const"
      pattern: "const.*extern|extern.*const"
    - path: "EIDCardLibrary/CertificateUtilities.cpp"
      provides: "Static buffers with const where appropriate"
  key_links:
    - from: "global.h declarations"
      to: "source file definitions"
      via: "extern linkage"
      pattern: "definition must match declaration const-ness"
---

<objective>
Mark global variables that should be const as const across the codebase.

Purpose: Resolve 71 SonarQube "Global variables should be const" issues to improve code maintainability and enable compiler optimizations.

Output: Global variables that are never modified after initialization will be marked const in both declarations and definitions.
</objective>

<execution_context>
@C:/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/sonarqube-analysis.md

# SonarQube issue files with global variable const issues
@sonarqube_issues/issues/High/Maintainability/

# Key source files with global variables
@EIDConfigurationWizard/global.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Mark EIDConfigurationWizard global variables as const</name>
  <files>
    EIDConfigurationWizard/global.h,
    EIDConfigurationWizard/EIDConfigurationWizardPage05.cpp
  </files>
  <action>
Review global.h and all EIDConfigurationWizard source files for global variables that should be const.

For each global variable:
1. Verify it is never modified after initialization (grep for assignments)
2. If never modified, add const qualifier to BOTH declaration (in .h) and definition (in .cpp)

Variables in global.h that likely need const:
- dwReaderSize, dwCardSize, dwUserNameSize, dwPasswordSize (size variables typically read-only)

EXCEPTIONS (do NOT mark const):
- g_hinst (HINSTANCE) - set by Windows during DLL loading
- szReader[], szCard[], szUserName[], szPassword[] - may be modified during wizard operation
- fShowNewCertificatePanel, fGotoNewScreen - control flow flags that change
- pCredentialList - pointer to credential factory, managed elsewhere
- dwCurrentCredential - index that changes during selection

For EIDConfigurationWizardPage05.cpp:
- dwWizardError on line 29 - evaluate if this should be thread-local or const
</action>
  <verify>
    - `msbuild EIDConfigurationWizard.vcxproj /p:Configuration=Release /p:Platform=x64` compiles without errors
    - No new compiler warnings introduced
  </verify>
  <done>
EIDConfigurationWizard global variables that are never modified are marked const in both header and source files.
</done>
</task>

<task type="auto">
  <name>Task 2: Mark EIDCardLibrary global variables as const</name>
  <files>
    EIDCardLibrary/CertificateUtilities.cpp,
    EIDCardLibrary/Tracing.cpp,
    EIDCardLibrary/Package.cpp
  </files>
  <action>
Review all EIDCardLibrary source files for global variables that should be const.

CertificateUtilities.cpp already has static buffers (lines 36-44) for Windows API compatibility:
- s_szOidClientAuth, s_szOidServerAuth, s_szOidSmartCardLogon, etc.
- These are static writable copies for API compatibility - do NOT mark const

For Tracing.cpp and Package.cpp:
1. Find all global variables at file scope
2. Check if they are modified after initialization
3. If never modified, mark as const

Common patterns to const-ify:
- GUID constants (CLSID_, IID_)
- Static string constants used for logging
- Configuration constants
</action>
  <verify>
    - `msbuild EIDCardLibrary.vcxproj /p:Configuration=Release /p:Platform=x64` compiles without errors
    - No new compiler warnings introduced
  </verify>
  <done>
EIDCardLibrary global variables that are never modified are marked const.
</done>
</task>

<task type="auto">
  <name>Task 3: Mark remaining project global variables as const</name>
  <files>
    EIDCredentialProvider/CEIDCredential.cpp,
    EIDCredentialProvider/common.h,
    EIDAuthenticationPackage/EIDSecuritySupportProvider.cpp,
    EIDAuthenticationPackage/EIDAuthenticationPackage.cpp,
    EIDLogManager/EIDLogManager.cpp
  </files>
  <action>
Review remaining projects for global variables that should be const:

EIDCredentialProvider:
- common.h line 70 has s_wszEmptyLabel (static wchar_t[]) - this is a writable buffer for API compatibility, do NOT mark const
- CEIDCredential.cpp line 42 - check what global is defined there

EIDAuthenticationPackage:
- Check EIDSecuritySupportProvider.cpp and EIDAuthenticationPackage.cpp for globals
- Be careful with LSA-related globals that may be set during package initialization

EIDLogManager:
- EIDLogManager.cpp line 32: hInst (HINSTANCE) - do NOT mark const, set by Windows

For each variable found:
1. Verify it is never modified after initialization
2. If never modified, mark as const
3. If definition and declaration are in different files, update BOTH
</action>
  <verify>
    - `msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64 /t:Build` compiles all projects without errors
    - No new compiler warnings introduced
  </verify>
  <done>
All remaining project global variables that are never modified are marked const. Full solution builds successfully.
</done>
</task>

</tasks>

<verification>
1. Run full solution build: `msbuild EIDAuthentication.sln /p:Configuration=Release /p:Platform=x64`
2. Verify no new compiler warnings: redirect build output and check for warning count increase
3. Verify const additions are consistent between .h declarations and .cpp definitions
</verification>

<success_criteria>
- All 71 global variable const issues addressed (marked const or documented as exception)
- Code compiles successfully after changes
- No new compiler warnings introduced
- Const qualifiers consistent between declarations and definitions
</success_criteria>

<output>
After completion, create `.planning/phases/16-const-correctness/16-01-SUMMARY.md`
</output>
